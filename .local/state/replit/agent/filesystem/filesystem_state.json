{"file_contents":{"app.py":{"content":"import streamlit as st\nimport pandas as pd\nimport time\nimport random\nfrom utils.data_manager import DataManager\nfrom utils.recommendation_engine import RecommendationEngine\nfrom utils.weather_manager import WeatherManager\nimport os\n\n# è¨­å®šé é¢é…ç½®\nst.set_page_config(\n    page_title=\"å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"ğŸƒâ€â™‚ï¸\",\n    layout=\"wide\",\n    initial_sidebar_state=\"collapsed\"\n)\n\n# è‡ªå®šç¾©ç°è—è‰²ä¸»é¡ŒCSS\nst.markdown(\"\"\"\n<style>\n    /* ä¸»èƒŒæ™¯é¡è‰² */\n    .stApp {\n        background-color: #f8fafb;\n    }\n    \n    /* å€å¡ŠèƒŒæ™¯ */\n    .block-container {\n        background-color: #ecf0f3;\n        padding: 20px;\n        border-radius: 10px;\n        margin-bottom: 20px;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    }\n    \n    /* ä¸»æ¨™é¡Œå€åŸŸ */\n    .main-header {\n        background: linear-gradient(135deg, #a6bee2 0%, #8fadd9 100%);\n        color: white;\n        padding: 20px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        flex-wrap: wrap;\n    }\n    \n    .logo-section {\n        display: flex;\n        align-items: center;\n        gap: 15px;\n    }\n    \n    .location-selector-inline {\n        background: rgba(255,255,255,0.2);\n        border-radius: 10px;\n        padding: 10px 15px;\n        min-width: 200px;\n    }\n    \n    .location-selector-inline .stSelectbox > div > div {\n        background-color: rgba(255,255,255,0.9);\n        border-radius: 8px;\n    }\n    \n    /* å¤©æ°£å€å¡Šç‰¹æ®Šæ¨£å¼ */\n    .weather-block {\n        background: linear-gradient(135deg, #a6bee2 0%, #8fadd9 100%);\n        color: white;\n        padding: 20px;\n        border-radius: 15px;\n        text-align: center;\n        margin-bottom: 30px;\n    }\n    \n    /* æœå°‹å€å¡Š */\n    .search-block {\n        background-color: #ecf0f3;\n        padding: 25px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n    }\n    \n    /* æ¨è–¦å€å¡Š */\n    .recommend-block {\n        background-color: #ecf0f3;\n        padding: 25px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n    }\n    \n    /* é‹å‹•iconæ—‹è½‰å‹•ç•« */\n    @keyframes rotation {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n    }\n    \n    /* å‹•æ…‹é‹å‹•icon */\n    .rotating-icon {\n        animation: rotation 3s infinite linear;\n        display: inline-block;\n        font-size: 24px;\n    }\n    \n    @keyframes rotation {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n    }\n    \n    /* æ‡‰ç”¨å•Ÿå‹•å‹•ç•«è¦†è“‹å±¤ */\n    .app-startup-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: #a6bee2;\n        z-index: 99999;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        flex-direction: column;\n        color: white;\n        font-family: 'Arial', sans-serif;\n    }\n    \n    .startup-logo-container {\n        position: relative;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n    }\n    \n    .app-startup-overlay.hidden {\n        opacity: 0;\n        visibility: hidden;\n        transition: opacity 0.8s ease-out, visibility 0.8s ease-out;\n    }\n    \n    /* å•Ÿå‹•logoå‹•ç•« */\n    .startup-logo {\n        max-width: 450vw;\n        max-height: 450vh;\n        width: auto;\n        height: auto;\n        animation: logoFadeIn 1.5s ease-out;\n        position: relative;\n    }\n    \n    @keyframes logoFadeIn {\n        0% {\n            opacity: 0;\n            transform: scale(0.8) translateY(20px);\n        }\n        100% {\n            opacity: 1;\n            transform: scale(1) translateY(0);\n        }\n    }\n    \n    /* å•Ÿå‹•æ¨™é¡Œ - æ”¾ç½®åœ¨é é¢ 2/3 ä½ç½® */\n    .startup-title-compact {\n        position: fixed;\n        top: calc(66.67vh - 1.5cm);\n        left: 50%;\n        transform: translateX(-50%);\n        font-size: 1em;\n        font-weight: normal;\n        text-align: center;\n        opacity: 0.9;\n        white-space: nowrap;\n        font-family: 'uoqmunthenkhung', 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', 'Heiti TC', sans-serif;\n        letter-spacing: 2px;\n        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n    }\n    \n    /* å­—ç¬¦å¼¹è·³åŠ¨ç”» - å•ä¸ªå­—ç¬¦ä¾æ¬¡è·³åŠ¨ */\n    .bounce-char {\n        display: inline-block;\n        animation: charBounceOnce 0.6s ease-in-out;\n        animation-fill-mode: both;\n    }\n    \n    @keyframes charBounceOnce {\n        0% {\n            transform: translateY(0);\n        }\n        50% {\n            transform: translateY(-0.2cm);\n        }\n        100% {\n            transform: translateY(0);\n        }\n    }\n    \n    /* ä¸ºæ¯ä¸ªå­—ç¬¦è®¾ç½®ä¸åŒçš„åŠ¨ç”»å»¶è¿Ÿ - ä¾æ¬¡è·³åŠ¨ */\n    .bounce-char:nth-child(1) { animation-delay: 0s; }\n    .bounce-char:nth-child(2) { animation-delay: 0.6s; }\n    .bounce-char:nth-child(3) { animation-delay: 1.2s; }\n    .bounce-char:nth-child(4) { animation-delay: 1.8s; }\n    .bounce-char:nth-child(5) { animation-delay: 2.4s; }\n    .bounce-char:nth-child(6) { animation-delay: 3.0s; }\n    .bounce-char:nth-child(7) { animation-delay: 3.6s; }\n    .bounce-char:nth-child(8) { animation-delay: 4.2s; }\n    .bounce-char:nth-child(9) { animation-delay: 4.8s; }\n    .bounce-char:nth-child(10) { animation-delay: 5.4s; }\n    .bounce-char:nth-child(11) { animation-delay: 6.0s; }\n    .bounce-char:nth-child(12) { animation-delay: 6.6s; }\n    .bounce-char:nth-child(13) { animation-delay: 7.2s; }\n    .bounce-char:nth-child(14) { animation-delay: 7.8s; }\n    .bounce-char:nth-child(15) { animation-delay: 8.4s; }\n    .bounce-char:nth-child(16) { animation-delay: 9.0s; }\n    .bounce-char:nth-child(17) { animation-delay: 9.6s; }\n    .bounce-char:nth-child(18) { animation-delay: 10.2s; }\n    .bounce-char:nth-child(19) { animation-delay: 10.8s; }\n    .bounce-char:nth-child(20) { animation-delay: 11.4s; }\n    .bounce-char:nth-child(21) { animation-delay: 12.0s; }\n    .bounce-char:nth-child(22) { animation-delay: 12.6s; }\n    .bounce-char:nth-child(23) { animation-delay: 13.2s; }\n    .bounce-char:nth-child(24) { animation-delay: 13.8s; }\n    \n    @keyframes titleSlideUp {\n        0% {\n            opacity: 0;\n            transform: translateY(30px);\n        }\n        100% {\n            opacity: 1;\n            transform: translateY(0);\n        }\n    }\n    \n    /* è¼‰å…¥é€²åº¦å‹•ç•« */\n    .startup-loading {\n        display: flex;\n        align-items: center;\n        gap: 15px;\n        animation: loadingFadeIn 2.2s ease-out 0.9s both;\n    }\n    \n    .loading-text {\n        font-size: 1.1em;\n        margin-right: 10px;\n    }\n    \n    .loading-dots {\n        display: flex;\n        gap: 5px;\n    }\n    \n    .loading-dot {\n        width: 8px;\n        height: 8px;\n        background-color: white;\n        border-radius: 50%;\n        animation: dotPulse 1.4s ease-in-out infinite;\n    }\n    \n    .loading-dot:nth-child(1) { animation-delay: 0s; }\n    .loading-dot:nth-child(2) { animation-delay: 0.2s; }\n    .loading-dot:nth-child(3) { animation-delay: 0.4s; }\n    \n    @keyframes dotPulse {\n        0%, 60%, 100% {\n            opacity: 0.3;\n            transform: scale(0.8);\n        }\n        30% {\n            opacity: 1;\n            transform: scale(1);\n        }\n    }\n    \n    @keyframes loadingFadeIn {\n        0% {\n            opacity: 0;\n            transform: translateY(20px);\n        }\n        100% {\n            opacity: 1;\n            transform: translateY(0);\n        }\n    }\n    \n    /* è½‰å ´å‹•ç•«è¦†è“‹å±¤ */\n    .page-transition-overlay {\n        display: none;\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(245, 245, 245, 0.95);\n        z-index: 9999;\n        justify-content: center;\n        align-items: center;\n        flex-direction: column;\n    }\n    \n    .page-transition-overlay.show {\n        display: flex;\n    }\n    \n    /* è¼‰å…¥å‹•ç•« */\n    .loading-spinner {\n        width: 80px;\n        height: 80px;\n        border: 8px solid #e8e8e8;\n        border-top: 8px solid #9e9e9e;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n        margin-bottom: 20px;\n    }\n    \n    @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n    }\n    \n    /* éšè—é¡¶éƒ¨ç™½è‰²æ¡ */\n    header[data-testid=\"stHeader\"] {\n        display: none !important;\n    }\n    \n    .stApp > header {\n        display: none !important;\n    }\n    \n    /* è¼¸å…¥æ¬„æ¨£å¼ */\n    .stTextInput > div > div > input {\n        background-color: #f0f0f0;\n        border: 2px solid #9e9e9e;\n        border-radius: 25px;\n        padding: 10px 20px;\n        font-size: 16px;\n    }\n    \n    /* å ´é¤¨å¡ç‰‡æ¨£å¼ */\n    .venue-card {\n        background-color: #f8f8f8;\n        border-radius: 10px;\n        padding: 15px;\n        margin: 10px 0;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n        border-left: 4px solid #9e9e9e;\n    }\n    \n    /* æ¨™é¡Œæ¨£å¼ */\n    h1, h2, h3 {\n        color: #424242;\n    }\n    \n    /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */\n    .stButton > button {\n        transition: all 0.3s ease;\n    }\n    \n    .stButton > button:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n    }\n</style>\n\"\"\", unsafe_allow_html=True)\n\n# ===== å¯åŠ¨é¡µé¢é€»è¾‘ =====\n\n# è¯»å–logoæ–‡ä»¶\nwith open('attached_assets/FM logo_1757941352267.jpg', 'rb') as f:\n    logo_data = f.read()\n\n# ç¼–ç ä¸ºbase64\nimport base64\nlogo_base64 = base64.b64encode(logo_data).decode()\n\n# å®Œæ•´çš„å¯åŠ¨é¡µé¢HTML - ç¾ä¸½çš„åŠ¨ç”»æ•ˆæœ\nstartup_html = f'''\n<div id=\"appStartup\" class=\"app-startup-overlay\" style=\"display: flex !important;\">\n    <div class=\"startup-logo-container\">\n        <img src=\"data:image/jpeg;base64,{logo_base64}\" class=\"startup-logo\" alt=\"Finding Move Logo\">\n    </div>\n    <div class=\"startup-title-compact\">\n        <span class=\"bounce-char\">å°‹</span><span class=\"bounce-char\">åœ°</span><span class=\"bounce-char\">å¯³</span><span class=\"bounce-char\"> </span><span class=\"bounce-char\">-</span><span class=\"bounce-char\"> </span><span class=\"bounce-char\">æ ¹</span><span class=\"bounce-char\">æ“š</span><span class=\"bounce-char\">æ‚¨</span><span class=\"bounce-char\">çš„</span><span class=\"bounce-char\">ç¯€</span><span class=\"bounce-char\">å¥</span><span class=\"bounce-char\">ï¼Œ</span><span class=\"bounce-char\">æ‰¾</span><span class=\"bounce-char\">åˆ°</span><span class=\"bounce-char\">æœ€</span><span class=\"bounce-char\">é©</span><span class=\"bounce-char\">åˆ</span><span class=\"bounce-char\">æ‚¨</span><span class=\"bounce-char\">çš„</span><span class=\"bounce-char\">é‹</span><span class=\"bounce-char\">å‹•</span><span class=\"bounce-char\">å ´</span><span class=\"bounce-char\">æ‰€</span>\n    </div>\n</div>\n\n<script>\n// 3ç§’åè‡ªåŠ¨éšè—å¯åŠ¨ç”»é¢\nsetTimeout(function() {{\n    var overlay = document.getElementById('appStartup');\n    if (overlay) {{\n        overlay.classList.add('hidden');\n    }}\n}}, 3000);\n</script>\n'''\n\n# æ˜¾ç¤ºå¯åŠ¨é¡µé¢\nst.markdown(startup_html, unsafe_allow_html=True)\n\n# ç­‰å¾…3.5ç§’æ˜¾ç¤ºå¯åŠ¨åŠ¨ç”»\ntime.sleep(3.5)\n\n# åˆå§‹åŒ–å¿…è¦çš„session stateï¼ˆä½†ä¸å¼ºåˆ¶è®¤è¯ï¼‰\nif 'current_sport_icon' not in st.session_state:\n    st.session_state.current_sport_icon = 0\nif 'selected_district' not in st.session_state:\n    st.session_state.selected_district = 'ä¸­æ­£å€'\nif 'user_location' not in st.session_state:\n    st.session_state.user_location = None\n\n# è®¾ç½®å¯åŠ¨å®Œæˆæ ‡å¿—\nst.session_state.startup_done = True\n\n# è‡ªåŠ¨è·³è½¬åˆ°ä¸»é¡µé¢\nst.switch_page(\"pages/1_ğŸ”_å ´åœ°æœå°‹.py\")","size_bytes":11781},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"folium>=0.20.0\",\n    \"numpy>=2.3.3\",\n    \"pandas>=2.3.2\",\n    \"scikit-learn>=1.7.2\",\n    \"streamlit-folium>=0.25.1\",\n    \"streamlit>=1.49.1\",\n    \"plotly>=6.3.0\",\n    \"psycopg2-binary>=2.9.10\",\n    \"sqlalchemy>=2.0.43\",\n]\n","size_bytes":369},"replit.md":{"content":"# Overview\n\nThis is a Streamlit-based web application for discovering and searching sports venues in Taipei City. The application provides a comprehensive search engine with personalized recommendations, interactive map visualization, and user preference management. Users can find suitable sports facilities through various filtering options including sport type, district, price range, and facilities.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# Recent Changes\n\n**September 15, 2025**: Successfully implemented top-right location selector with auto-positioning:\n- Added fixed position location selector in top-right corner with gray theme design\n- Integrated all 12 Taipei districts dropdown using Streamlit native selectbox component\n- Implemented HTML5 geolocation API with distance calculation to nearest district\n- Added real-time weather data updates based on selected district\n- Fixed pandas compatibility issues (na_last â†’ na_position in sort_values)\n- Resolved accessibility warnings by adding proper selectbox labels\n- Enhanced URL parameter management for state persistence across page reloads\n- Complete end-to-end testing validation with Playwright\n\n**September 13, 2025**: Completed comprehensive sports venue search engine with following features:\n- PostgreSQL database integration with venues, bookings, reviews, and user tables\n- Real-time booking system with availability checking and conflict detection\n- User review and rating system with administrative moderation dashboard\n- Advanced machine learning recommendation algorithms (ML-based, clustering, content-based similarity)\n- Comprehensive venue comparison feature with charts, statistics, and analysis\n- Venue detail pages with complete information, booking forms, and review sections\n- Security improvements: removed hardcoded passwords, using environment variables\n- Enhanced error handling and data validation throughout the application\n\n# System Architecture\n\n## Frontend Architecture\nThe application uses Streamlit as the primary web framework with a multi-page architecture:\n- **Main App (app.py)**: Entry point with user preference settings and overall configuration\n- **Search Page**: Advanced filtering and search functionality for venues\n- **Map View Page**: Interactive map visualization using Folium integration\n\nThe frontend follows a session state management pattern to maintain user preferences and application state across different pages. The layout uses a sidebar for filters and controls with a wide main content area.\n\n## Backend Architecture\nThe system is built with a modular utility-based architecture:\n\n### Core Components\n- **DataManager**: Handles all data operations including loading, filtering, and venue retrieval\n- **RecommendationEngine**: Implements multiple recommendation algorithms using content-based filtering and TF-IDF vectorization\n- **MapUtils**: Provides geographical utilities and coordinate calculations for map functionality\n\n### Data Processing Layer\nThe DataManager supports flexible data loading from multiple sources:\n- JSON files for structured venue data\n- CSV files for tabular data\n- REST API endpoints for dynamic data fetching\n- Environment variable configuration for data source specification\n\n### Recommendation System\nThe RecommendationEngine implements sophisticated recommendation algorithms:\n- Content-based filtering using venue features\n- User preference matching with weighted scoring\n- Diversity and novelty factors to avoid filter bubbles\n- Feedback integration for continuous learning\n\n## Data Storage\n\n**PostgreSQL Database Integration (Updated September 2025)**\n\nThe application now uses a comprehensive PostgreSQL database with the following tables:\n- **venues**: Stores all venue information including name, location, facilities, pricing\n- **reviews**: User-generated reviews and ratings with moderation status\n- **bookings**: Real-time booking records with availability tracking\n- **user_preferences**: User preference data for personalized recommendations\n\nKey features:\n- Real-time availability checking with conflict detection\n- ACID-compliant booking transactions\n- Review moderation workflow with admin dashboard\n- Secure environment-based database configuration\n\n## Geographic Features\n\nMap functionality is built around Taipei City's district system:\n- Predefined district center coordinates for all Taipei districts\n- Color-coded markers for different sport types\n- Boundary calculations for map viewport management\n- Integration with Folium for interactive map rendering\n\n# External Dependencies\n\n## Core Web Framework\n- **Streamlit**: Main web application framework for UI and user interaction\n- **streamlit-folium**: Integration package for embedding Folium maps in Streamlit\n\n## Data Processing\n- **Pandas**: Primary data manipulation and analysis library\n- **NumPy**: Numerical computing support for calculations and array operations\n\n## Machine Learning & Recommendations\n- **scikit-learn**: Machine learning utilities including TfidfVectorizer and cosine similarity calculations for content-based recommendations\n\n## Visualization & Mapping\n- **Folium**: Interactive map generation and visualization library for geographic data display\n\n## Data Sources\n- **Configurable data sources**: Support for JSON files, CSV files, or REST API endpoints\n- **Environment variables**: VENUES_DATA_SOURCE for flexible data source configuration\n- **HTTP requests**: Optional integration for API-based data fetching\n\nThe architecture is designed to be flexible and extensible, allowing for easy integration of additional data sources, recommendation algorithms, and visualization features.","size_bytes":5677},"pages/1_ğŸ”_å ´åœ°æœå°‹.py":{"content":"import streamlit as st\nimport pandas as pd\nimport time\nfrom utils.data_manager import DataManager\nfrom utils.recommendation_engine import RecommendationEngine\nfrom utils.weather_manager import WeatherManager\n\nst.set_page_config(\n    page_title=\"Finding Move å°‹åœ°å¯³ \",\n    page_icon=\"ğŸ”\",\n    layout=\"wide\",\n    initial_sidebar_state=\"collapsed\"\n)\n\n# å¯åŠ¨åŠ¨ç”»é€»è¾‘ - å¦‚æœæ˜¯é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºå¯åŠ¨åŠ¨ç”»\nif 'startup_done' not in st.session_state:\n    # è¯»å–logoæ–‡ä»¶\n    with open('attached_assets/FM logo_1757941352267.jpg', 'rb') as f:\n        logo_data = f.read()\n    \n    # ç¼–ç ä¸ºbase64\n    import base64\n    logo_base64 = base64.b64encode(logo_data).decode()\n    \n    # æ˜¾ç¤ºå¯åŠ¨åŠ¨ç”»\n    startup_html = f'''\n    <div id=\"appStartup\" class=\"app-startup-overlay\" style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #a6bee2 0%, #8fadd9 100%); z-index: 99999; display: flex !important; justify-content: center; align-items: center; flex-direction: column; color: white;\">\n        <div style=\"text-align: center;\">\n            <img src=\"data:image/jpeg;base64,{logo_base64}\" style=\"max-width: 300px; max-height: 300px; margin-bottom: 30px; animation: logoFadeIn 1.5s ease-out;\" alt=\"Finding Move Logo\">\n            <div style=\"font-size: 1.2em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\">\n                <span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0s;\">å°‹</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.1s;\">åœ°</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.2s;\">å¯³</span>\n                <span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.3s;\"> - </span>\n                <span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.4s;\">æ ¹</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.5s;\">æ“š</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.6s;\">æ‚¨</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.7s;\">çš„</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.8s;\">ç¯€</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 0.9s;\">å¥</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.0s;\">ï¼Œ</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.1s;\">æ‰¾</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.2s;\">åˆ°</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.3s;\">æœ€</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.4s;\">é©</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.5s;\">åˆ</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.6s;\">æ‚¨</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.7s;\">çš„</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.8s;\">é‹</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 1.9s;\">å‹•</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 2.0s;\">å ´</span><span style=\"display: inline-block; animation: charBounce 0.6s ease-in-out 2.1s;\">æ‰€</span>\n            </div>\n        </div>\n    </div>\n    \n    <style>\n        @keyframes logoFadeIn {{\n            0% {{ opacity: 0; transform: scale(0.8) translateY(20px); }}\n            100% {{ opacity: 1; transform: scale(1) translateY(0); }}\n        }}\n        @keyframes charBounce {{\n            0% {{ transform: translateY(0); }}\n            50% {{ transform: translateY(-10px); }}\n            100% {{ transform: translateY(0); }}\n        }}\n        header[data-testid=\"stHeader\"] {{ display: none !important; }}\n    </style>\n    \n    <script>\n        // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ\n        document.addEventListener('DOMContentLoaded', function() {{\n            setTimeout(function() {{\n                var overlay = document.getElementById('appStartup');\n                if (overlay) {{\n                    overlay.style.opacity = '0';\n                    overlay.style.transition = 'opacity 0.8s ease-out';\n                    setTimeout(function() {{\n                        overlay.style.display = 'none';\n                    }}, 800);\n                }}\n            }}, 3000);\n        }});\n        \n        // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœDOMå·²ç»åŠ è½½ï¼Œç«‹å³æ‰§è¡Œ\n        if (document.readyState === 'loading') {{\n            // å¦‚æœæ–‡æ¡£è¿˜åœ¨åŠ è½½ï¼Œç­‰å¾…DOMContentLoaded\n        }} else {{\n            // å¦‚æœæ–‡æ¡£å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œå®šæ—¶å™¨\n            setTimeout(function() {{\n                var overlay = document.getElementById('appStartup');\n                if (overlay) {{\n                    overlay.style.opacity = '0';\n                    overlay.style.transition = 'opacity 0.8s ease-out';\n                    setTimeout(function() {{\n                        overlay.style.display = 'none';\n                    }}, 800);\n                }}\n            }}, 3000);\n        }}\n    </script>\n    '''\n    \n    st.markdown(startup_html, unsafe_allow_html=True)\n    \n    # ç­‰å¾…åŠ¨ç”»æ’­æ”¾\n    import time\n    time.sleep(3.5)\n    \n    # è®¾ç½®æ ‡å¿—\n    st.session_state.startup_done = True\n    st.rerun()\n\n# è‡ªå®šç¾©ç°è—è‰²ä¸»é¡ŒCSS\nst.markdown(\"\"\"\n<style>\n    /* ä¸»èƒŒæ™¯é¡è‰² */\n    .stApp {\n        background-color: #f8fafb;\n    }\n    \n    /* ä¸»æ¨™é¡Œå€åŸŸ */\n    .main-header {\n        background: linear-gradient(135deg, #a6bee2 0%, #8fadd9 100%);\n        color: white;\n        padding: 20px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        flex-wrap: wrap;\n    }\n    \n    .logo-section {\n        display: flex;\n        align-items: center;\n        gap: 15px;\n    }\n    \n    .location-selector-inline {\n        background: rgba(255,255,255,0.2);\n        border-radius: 10px;\n        padding: 10px 15px;\n        min-width: 200px;\n    }\n    \n    .location-selector-inline .stSelectbox > div > div {\n        background-color: rgba(255,255,255,0.9);\n        border-radius: 8px;\n    }\n    \n    /* å¤©æ°£å€å¡Šç‰¹æ®Šæ¨£å¼ */\n    .weather-block {\n        background: linear-gradient(135deg, #a6bee2 0%, #8fadd9 100%);\n        color: white;\n        padding: 20px;\n        border-radius: 15px;\n        text-align: center;\n        margin-bottom: 30px;\n    }\n    \n    /* æœå°‹å€å¡Š */\n    .search-block {\n        background-color: #ecf0f3;\n        padding: 25px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n    }\n    \n    /* æ¨è–¦å€å¡Š */\n    .recommend-block {\n        background-color: #ecf0f3;\n        padding: 25px;\n        border-radius: 15px;\n        margin-bottom: 30px;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n    }\n    \n    /* é‹å‹•iconæ—‹è½‰å‹•ç•« */\n    @keyframes rotation {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n    }\n    \n    /* å‹•æ…‹é‹å‹•icon */\n    .rotating-icon {\n        animation: rotation 3s infinite linear;\n        display: inline-block;\n        font-size: 24px;\n    }\n    \n    /* å ´é¤¨å¡ç‰‡æ¨£å¼ */\n    .venue-card {\n        background-color: #f8f8f8;\n        border-radius: 10px;\n        padding: 15px;\n        margin: 10px 0;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n        border-left: 4px solid #9e9e9e;\n    }\n    \n    /* æ¨™é¡Œæ¨£å¼ */\n    h1, h2, h3 {\n        color: #424242;\n    }\n    \n    /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */\n    .stButton > button {\n        transition: all 0.3s ease;\n    }\n    \n    .stButton > button:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n    }\n</style>\n\"\"\", unsafe_allow_html=True)\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nif 'recommendation_engine' not in st.session_state:\n    st.session_state.recommendation_engine = RecommendationEngine()\n    \nif 'weather_manager' not in st.session_state:\n    st.session_state.weather_manager = WeatherManager()\n    \nif 'current_sport_icon' not in st.session_state:\n    st.session_state.current_sport_icon = 0\n    \nif 'selected_district' not in st.session_state:\n    st.session_state.selected_district = 'ä¸­æ­£å€'\n    \nif 'user_location' not in st.session_state:\n    st.session_state.user_location = None\n\n# é‹å‹•iconåˆ—è¡¨å’Œå‹•æ…‹æ›´æ–°\nsports_icons = [\"ğŸ€\", \"âš½\", \"ğŸ¸\", \"ğŸ\", \"ğŸ¾\", \"ğŸŠâ€â™‚ï¸\", \"ğŸƒâ€â™‚ï¸\", \"ğŸš´â€â™‚ï¸\", \"ğŸ‹ï¸â€â™‚ï¸\", \"ğŸ¤¸â€â™‚ï¸\"]\n\n# æ›´æ–°é‹å‹•iconï¼ˆæ¯3ç§’æ›ä¸€æ¬¡ï¼‰\nif 'last_icon_update' not in st.session_state:\n    st.session_state.last_icon_update = time.time()\n\ncurrent_time = time.time()\nif current_time - st.session_state.last_icon_update > 3:\n    st.session_state.current_sport_icon = (st.session_state.current_sport_icon + 1) % len(sports_icons)\n    st.session_state.last_icon_update = current_time\n\ncurrent_icon = sports_icons[st.session_state.current_sport_icon]\n\n# ===== ä¸»æ¨™é¡Œå€åŸŸèˆ‡ä½ç½®é¸æ“‡å™¨ =====\navailable_districts = ['ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', \n                      'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€']\n\n# è®€å–ç•¶å‰é¸æ“‡çš„å€åŸŸ\nif hasattr(st, 'query_params') and st.query_params.get('district'):\n    current_district = st.query_params.get('district')\n    if current_district in available_districts:\n        st.session_state.selected_district = current_district\n\n# ç°¡æ½”çš„æ¨™é¡Œå€åŸŸ - ç§»é™¤è“è‰²èƒŒæ™¯\nst.markdown(f\"\"\"\n<div style=\"padding: 20px 0; margin-bottom: 20px;\">\n    <div style=\"display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;\">\n        <div style=\"display: flex; align-items: center; gap: 15px;\">\n            <div style=\"font-size: 2.5em;\">{current_icon}</div>\n            <div>\n                <h1 style=\"margin: 0; font-size: 2em; color: #424242;\">å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“</h1>\n                <p style=\"margin: 5px 0 0 0; color: #666; font-size: 1.1em;\">æ‰¾åˆ°æœ€é©åˆæ‚¨çš„é‹å‹•å ´åœ°</p>\n            </div>\n        </div>\n        <div style=\"min-width: 200px;\">\n            {st.session_state.selected_district}\n        </div>\n    </div>\n</div>\n\"\"\", unsafe_allow_html=True)\n\n# ä½ç½®é€‰æ‹©å™¨ï¼ˆç®€åŒ–ç‰ˆï¼Œå»é™¤è“è‰²èƒŒæ™¯ï¼‰\ncol1, col2, col3 = st.columns([2, 1, 1])\nwith col2:\n    selected_district = st.selectbox(\n        \"ğŸ“ é¸æ“‡ä½ç½®\",\n        available_districts,\n        index=available_districts.index(st.session_state.selected_district) if st.session_state.selected_district in available_districts else 0,\n        key=\"district_selector\",\n        help=\"é¸æ“‡æ‚¨æ‰€åœ¨çš„å°åŒ—å¸‚è¡Œæ”¿å€\"\n    )\n    \n    # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´\n    if selected_district != st.session_state.selected_district:\n        st.session_state.selected_district = selected_district\n        st.query_params[\"district\"] = selected_district\n        st.rerun()\n\nwith col3:\n    if st.button(\"ğŸ¯ è‡ªå‹•å®šä½\", help=\"ä½¿ç”¨GPSè‡ªå‹•é¸æ“‡æœ€è¿‘çš„è¡Œæ”¿å€\"):\n        st.info(\"è«‹åœ¨ç€è¦½å™¨ä¸­å…è¨±å®šä½æ¬Šé™\")\n\n# ===== å¤©æ°£è³‡è¨Šå€å¡Š =====\n# ç²å–é¸æ“‡çš„å€åŸŸ\nselected_district = st.session_state.selected_district\n\n# ç²å–å³æ™‚å¤©æ°£è³‡æ–™\nweather_info = st.session_state.weather_manager.get_current_weather(selected_district)\nweather_icon = st.session_state.weather_manager.get_weather_icon(\n    weather_info['weather_description'], \n    weather_info['temperature']\n)\n\n# æ ¹æ“šé‹å‹•é©å®œæ€§çµ¦å‡ºå»ºè­°\ndef get_exercise_advice(temp, humidity, precipitation):\n    if precipitation > 60:\n        return \"ğŸŒ§ï¸ ä»Šæ—¥æœ‰é›¨ï¼Œå»ºè­°å®¤å…§é‹å‹•\"\n    elif temp > 35:\n        return \"ğŸŒ¡ï¸ é«˜æº«è­¦å‘Šï¼Œè«‹æ³¨æ„é˜²æ›¬è£œæ°´\"\n    elif temp < 15:\n        return \"ğŸ§¥ æ°£æº«è¼ƒä½ï¼Œè«‹æ³¨æ„ä¿æš–\"\n    elif humidity > 80:\n        return \"ğŸ’¦ æ¿•åº¦è¼ƒé«˜ï¼Œé‹å‹•æ™‚å¤šè£œæ°´\"\n    else:\n        return \"â˜€ï¸ ä»Šæ—¥é©åˆæˆ¶å¤–é‹å‹•\"\n\nexercise_advice = get_exercise_advice(\n    weather_info['temperature'], \n    weather_info['humidity'], \n    weather_info['precipitation_probability']\n)\n\n# ===== å¤©æ°£é å ±å€å¡Š =====\nst.markdown(f\"\"\"\n<div class=\"weather-block\">\n    <h2>ğŸŒ¤ï¸ {selected_district} å³æ™‚å¤©æ°£</h2>\n    <div style=\"display: flex; justify-content: space-around; align-items: center; margin-top: 20px;\">\n        <div>\n            <div style=\"font-size: 3em;\">{weather_icon}</div>\n            <div style=\"font-size: 1.8em; font-weight: bold;\">{weather_info['temperature']}Â°C</div>\n            <div style=\"font-size: 1.1em;\">{weather_info['weather_description']}</div>\n        </div>\n        <div>\n            <div style=\"font-size: 2em;\">ğŸ’¨</div>\n            <div style=\"font-size: 1.1em;\">{weather_info['wind_direction']} {weather_info['wind_speed']}ç´š</div>\n            <div style=\"font-size: 1.1em;\">æ¿•åº¦ {weather_info['humidity']}%</div>\n        </div>\n        <div>\n            <div style=\"font-size: 2em;\">ğŸ“</div>\n            <div style=\"font-weight: bold; font-size: 1.2em;\">å°åŒ—å¸‚</div>\n            <div style=\"font-size: 1.1em; color: #ffeb3b;\">{weather_info['district']}</div>\n        </div>\n    </div>\n    <div style=\"margin-top: 15px; font-size: 1em; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px;\">\n        <strong>{exercise_advice}</strong>\n    </div>\n    <div style=\"margin-top: 10px; font-size: 0.9em; display: flex; justify-content: space-between;\">\n        <span>ğŸŒ¡ï¸ é«”æ„Ÿ {weather_info['apparent_temperature']}Â°C</span>\n        <span>ğŸŒ§ï¸ é™é›¨ {weather_info['precipitation_probability']}%</span>\n        <span>ğŸ˜Š {weather_info['comfort_index']}</span>\n    </div>\n    <div style=\"margin-top: 8px; font-size: 0.8em; opacity: 0.8; text-align: center;\">\n        æ›´æ–°æ™‚é–“: {weather_info['update_time']}\n    </div>\n</div>\n\"\"\", unsafe_allow_html=True)\n\n# ===== æœå°‹åŠŸèƒ½å€å¡Š =====\nst.markdown('<div class=\"search-block\">', unsafe_allow_html=True)\n\n# æœå°‹æ¨™é¡Œ\nst.markdown(f\"\"\"\n<div style=\"text-align: center; margin-bottom: 20px;\">\n    <h2 style=\"color: #424242;\">\n        <span class=\"rotating-icon\">{current_icon}</span>\n        å°‹æ‰¾æœ€é©åˆçš„é‹å‹•å ´åœ°\n        <span class=\"rotating-icon\">{current_icon}</span>\n    </h2>\n</div>\n\"\"\", unsafe_allow_html=True)\n\n# æœå°‹è¼¸å…¥æ¬„\nsearch_col1, search_col2 = st.columns([4, 1])\n\nwith search_col1:\n    search_placeholder = f\"{current_icon} è¼¸å…¥å ´åœ°åç¨±ã€é‹å‹•é¡å‹æˆ–åœ°å€...\"\n    search_query = st.text_input(\"æœå°‹\", placeholder=search_placeholder, label_visibility=\"collapsed\")\n\nwith search_col2:\n    search_button = st.button(\"ğŸ”\", help=\"é–‹å§‹æœå°‹\", use_container_width=True, type=\"primary\")\n\n# ç¯©é¸æ¢ä»¶\nst.markdown('<div style=\"margin-top: 20px;\"><h4 style=\"color: #424242;\">ğŸ“‹ ç¯©é¸æ¢ä»¶</h4></div>', unsafe_allow_html=True)\n\nif 'search_filters' not in st.session_state:\n    st.session_state.search_filters = {\n        'sport_type': [],\n        'district': [],\n        'price_range': [0, 5000],\n        'facilities': [],\n        'rating_min': 0.0\n    }\n\nfilter_col1, filter_col2, filter_col3, filter_col4 = st.columns(4)\n\nwith filter_col1:\n    # é‹å‹•é¡å‹ç¯©é¸\n    sport_types = [\"å…¨éƒ¨\", \"ç±ƒçƒ\", \"è¶³çƒ\", \"ç¶²çƒ\", \"ç¾½æ¯›çƒ\", \"æ¸¸æ³³\", \"å¥èº«\", \"è·‘æ­¥\", \"æ¡Œçƒ\"]\n    selected_sport = st.selectbox(\"ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹\", sport_types)\n\nwith filter_col2:\n    # åœ°å€ç¯©é¸\n    districts = [\"å…¨éƒ¨\", \"ä¸­æ­£å€\", \"å¤§åŒå€\", \"ä¸­å±±å€\", \"æ¾å±±å€\", \"å¤§å®‰å€\", \"è¬è¯å€\", \"ä¿¡ç¾©å€\", \"å£«æ—å€\", \"åŒ—æŠ•å€\", \"å…§æ¹–å€\", \"å—æ¸¯å€\", \"æ–‡å±±å€\"]\n    selected_district_filter = st.selectbox(\"ğŸ“ åœ°å€\", districts)\n\nwith filter_col3:\n    # åƒ¹æ ¼ç¯„åœ\n    price_range = st.selectbox(\"ğŸ’° åƒ¹æ ¼ç¯„åœ\", [\"å…¨éƒ¨\", \"å…è²»\", \"NT$1-100\", \"NT$101-300\", \"NT$301-500\", \"NT$500ä»¥ä¸Š\"])\n\nwith filter_col4:\n    # è©•åˆ†ç¯©é¸\n    rating_filter = st.selectbox(\"â­ è©•åˆ†\", [\"å…¨éƒ¨\", \"4.5åˆ†ä»¥ä¸Š\", \"4.0åˆ†ä»¥ä¸Š\", \"3.5åˆ†ä»¥ä¸Š\", \"3.0åˆ†ä»¥ä¸Š\"])\n\nst.markdown('</div>', unsafe_allow_html=True)\n\n# ===== æ¨è–¦å ´é¤¨å€å¡Š =====\nst.markdown('<div class=\"recommend-block\">', unsafe_allow_html=True)\n\nst.markdown('<h2 style=\"color: #424242; text-align: center; margin-bottom: 25px;\">ğŸ† æ¨è–¦å ´é¤¨</h2>', unsafe_allow_html=True)\n\n# ç²å–æ¨è–¦å ´åœ°\nvenues_data = st.session_state.data_manager.get_all_venues()\nif venues_data is not None and not venues_data.empty:\n    # éš¨æ©Ÿé¸æ“‡6å€‹å ´åœ°ä½œç‚ºæ¨è–¦\n    recommended_venues = venues_data.sample(n=min(6, len(venues_data)))\n    \n    # ä»¥3åˆ—2è¡Œæ–¹å¼å±•ç¤ºæ¨è–¦å ´é¤¨\n    for i in range(0, len(recommended_venues), 3):\n        cols = st.columns(3)\n        row_venues = recommended_venues.iloc[i:i+3]\n        \n        for j, (_, venue) in enumerate(row_venues.iterrows()):\n            with cols[j]:\n                # å ´é¤¨åœ–ç‰‡ï¼ˆæš«æ™‚ç”¨emojiæ›¿ä»£ï¼‰\n                sport_type = venue.get('sport_type', 'é‹å‹•')\n                venue_icon = \"ğŸŸï¸\"\n                if \"ç±ƒçƒ\" in sport_type:\n                    venue_icon = \"ğŸ€\"\n                elif \"æ¸¸æ³³\" in sport_type:\n                    venue_icon = \"ğŸŠâ€â™‚ï¸\"\n                elif \"ç¶²çƒ\" in sport_type:\n                    venue_icon = \"ğŸ¾\"\n                elif \"è¶³çƒ\" in sport_type:\n                    venue_icon = \"âš½\"\n                elif \"ç¾½æ¯›çƒ\" in sport_type:\n                    venue_icon = \"ğŸ¸\"\n                elif \"å¥èº«\" in sport_type:\n                    venue_icon = \"ğŸ‹ï¸â€â™‚ï¸\"\n                \n                st.markdown(f\"\"\"\n                <div class=\"venue-card\">\n                    <div style=\"text-align: center; font-size: 3em; margin-bottom: 10px;\">\n                        {venue_icon}\n                    </div>\n                    <div style=\"text-align: center;\">\n                        <h4 style=\"color: #424242; margin-bottom: 8px;\">{venue.get('name', 'æœªçŸ¥å ´åœ°')}</h4>\n                        <p style=\"color: #666; font-size: 0.9em; margin-bottom: 5px;\">\n                            ğŸ“ {venue.get('district', 'æœªçŸ¥åœ°å€')}\n                        </p>\n                        <p style=\"color: #666; font-size: 0.9em; margin-bottom: 5px;\">\n                            ğŸƒâ€â™‚ï¸ {venue.get('sport_type', 'æœªæŒ‡å®š')}\n                        </p>\n                        <div style=\"display: flex; justify-content: space-between; margin-top: 10px;\">\n                            <span style=\"color: #e91e63; font-weight: bold;\">\n                                ğŸ’° NT${venue.get('price_per_hour', 0)}/å°æ™‚\n                            </span>\n                            <span style=\"color: #ff9800; font-weight: bold;\">\n                                â­ {venue.get('rating', 0):.1f}\n                            </span>\n                        </div>\n                    </div>\n                </div>\n                \"\"\", unsafe_allow_html=True)\n                \n                # è©³æƒ…æŒ‰éˆ•\n                if st.button(f\"ğŸ“‹ æŸ¥çœ‹è©³æƒ…\", key=f\"venue_detail_{venue.get('id', i)}_{j}\", use_container_width=True):\n                    venue_id = venue.get('id')\n                    if venue_id:\n                        st.query_params.id = venue_id\n                        st.switch_page(\"pages/5_ğŸ¢_å ´åœ°è©³æƒ….py\")\n\nelse:\n    st.info(\"æ­£åœ¨è¼‰å…¥å ´åœ°è³‡æ–™...\")\n\nst.markdown('</div>', unsafe_allow_html=True)\n\n# ===== åŸæœ‰æœç´¢åŠŸèƒ½ =====\nst.markdown(\"---\")\nst.title(\"ğŸ” é€²éšæœå°‹\")\nst.markdown(\"ä½¿ç”¨è©³ç´°ç¯©é¸æ¢ä»¶æ‰¾åˆ°æœ€é©åˆçš„é‹å‹•å ´åœ°\")\n\n# å´é‚Šæ¬„ - æœå°‹ç¯©é¸å™¨\nwith st.sidebar:\n    st.header(\"ğŸ¯ æœå°‹ç¯©é¸\")\n    \n    # é‹å‹•é¡å‹ç¯©é¸\n    available_sports = st.session_state.data_manager.get_sport_types()\n    if available_sports:\n        selected_sports = st.multiselect(\n            \"é‹å‹•é¡å‹\",\n            available_sports,\n            default=st.session_state.search_filters['sport_type']\n        )\n        st.session_state.search_filters['sport_type'] = selected_sports\n    else:\n        st.info(\"è¼‰å…¥é‹å‹•é¡å‹ä¸­...\")\n    \n    # åœ°å€ç¯©é¸\n    available_districts = st.session_state.data_manager.get_districts()\n    if available_districts:\n        selected_districts = st.multiselect(\n            \"åœ°å€\",\n            available_districts,\n            default=st.session_state.search_filters['district']\n        )\n        st.session_state.search_filters['district'] = selected_districts\n    else:\n        st.info(\"è¼‰å…¥åœ°å€è³‡æ–™ä¸­...\")\n    \n    # åƒ¹æ ¼ç¯„åœ\n    price_range = st.slider(\n        \"åƒ¹æ ¼ç¯„åœ (æ¯å°æ™‚)\",\n        0, 10000,\n        value=st.session_state.search_filters['price_range'],\n        step=100,\n        format=\"NT$%d\"\n    )\n    st.session_state.search_filters['price_range'] = price_range\n    \n    # è¨­æ–½ç¯©é¸\n    available_facilities = st.session_state.data_manager.get_facilities()\n    if available_facilities:\n        selected_facilities = st.multiselect(\n            \"è¨­æ–½éœ€æ±‚\",\n            available_facilities,\n            default=st.session_state.search_filters['facilities']\n        )\n        st.session_state.search_filters['facilities'] = selected_facilities\n    \n    # æœ€ä½è©•åˆ†\n    min_rating = st.slider(\n        \"æœ€ä½è©•åˆ†\",\n        0.0, 5.0,\n        value=st.session_state.search_filters['rating_min'],\n        step=0.1,\n        format=\"%.1f\"\n    )\n    st.session_state.search_filters['rating_min'] = min_rating\n    \n    # é‡ç½®ç¯©é¸\n    if st.button(\"é‡ç½®ç¯©é¸\", use_container_width=True):\n        st.session_state.search_filters = {\n            'sport_type': [],\n            'district': [],\n            'price_range': [0, 5000],\n            'facilities': [],\n            'rating_min': 0.0\n        }\n        st.rerun()\n\n# ä¸»è¦å…§å®¹å€åŸŸ\ncol1, col2 = st.columns([2, 1])\n\nwith col1:\n    # æœå°‹æ¬„\n    search_col1, search_col2, search_col3 = st.columns([3, 1, 1])\n    \n    with search_col1:\n        search_query = st.text_input(\n            \"æœå°‹å ´åœ°\",\n            placeholder=\"è¼¸å…¥å ´åœ°åç¨±æˆ–é—œéµå­—...\",\n            key=\"venue_search\"\n        )\n    \n    with search_col2:\n        search_button = st.button(\"ğŸ” æœå°‹\", type=\"primary\", use_container_width=True)\n    \n    with search_col3:\n        sort_option = st.selectbox(\n            \"æ’åºæ–¹å¼\",\n            [\"è©•åˆ†\", \"åƒ¹æ ¼\", \"è·é›¢\", \"åç¨±\"],\n            key=\"sort_venues\"\n        )\n    \n    # åŸ·è¡Œæœå°‹å’Œç¯©é¸\n    if search_button or any(st.session_state.search_filters.values()):\n        # ç²å–ç¯©é¸å¾Œçš„å ´åœ°\n        filtered_venues = st.session_state.data_manager.get_filtered_venues(\n            sport_types=st.session_state.search_filters['sport_type'],\n            districts=st.session_state.search_filters['district'],\n            price_range=st.session_state.search_filters['price_range'],\n            facilities=st.session_state.search_filters['facilities'],\n            min_rating=st.session_state.search_filters['rating_min'],\n            search_query=search_query if search_button else None\n        )\n        \n        if filtered_venues is not None and not filtered_venues.empty:\n            # æ’åº\n            if sort_option == \"è©•åˆ†\":\n                filtered_venues = filtered_venues.sort_values('rating', ascending=False, na_position='last')\n            elif sort_option == \"åƒ¹æ ¼\":\n                filtered_venues = filtered_venues.sort_values('price_per_hour', ascending=True, na_position='last')\n            elif sort_option == \"åç¨±\":\n                filtered_venues = filtered_venues.sort_values('name', ascending=True, na_position='last')\n            \n            st.success(f\"æ‰¾åˆ° {len(filtered_venues)} å€‹ç¬¦åˆæ¢ä»¶çš„å ´åœ°\")\n            \n            # åˆ†é é¡¯ç¤º\n            venues_per_page = 10\n            total_pages = (len(filtered_venues) - 1) // venues_per_page + 1\n            \n            if total_pages > 1:\n                page = st.selectbox(f\"é é¢ (å…± {total_pages} é )\", range(1, total_pages + 1))\n                start_idx = (page - 1) * venues_per_page\n                end_idx = start_idx + venues_per_page\n                page_venues = filtered_venues.iloc[start_idx:end_idx]\n            else:\n                page_venues = filtered_venues\n            \n            # é¡¯ç¤ºå ´åœ°åˆ—è¡¨\n            for idx, venue in page_venues.iterrows():\n                with st.expander(\n                    f\"ğŸ“ {venue.get('name', 'æœªçŸ¥å ´åœ°')} - {venue.get('district', 'æœªçŸ¥åœ°å€')} \"\n                    f\"{'â­' * int(venue.get('rating', 0)) if venue.get('rating') else ''}\"\n                ):\n                    venue_detail_col1, venue_detail_col2 = st.columns([2, 1])\n                    \n                    with venue_detail_col1:\n                        st.markdown(f\"**ğŸ“ åœ°å€:** {venue.get('address', 'åœ°å€æœªæä¾›')}\")\n                        st.markdown(f\"**ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹:** {venue.get('sport_type', 'æœªæŒ‡å®š')}\")\n                        \n                        if venue.get('facilities'):\n                            facilities_list = venue.get('facilities', '').split(',') if isinstance(venue.get('facilities'), str) else venue.get('facilities', [])\n                            st.markdown(f\"**ğŸ¢ è¨­æ–½:** {', '.join(facilities_list)}\")\n                        \n                        if venue.get('description'):\n                            st.markdown(f\"**ğŸ“ æè¿°:** {venue.get('description')}\")\n                        \n                        if venue.get('contact_phone'):\n                            st.markdown(f\"**ğŸ“ è¯çµ¡é›»è©±:** {venue.get('contact_phone')}\")\n                        \n                        if venue.get('opening_hours'):\n                            st.markdown(f\"**ğŸ•’ ç‡Ÿæ¥­æ™‚é–“:** {venue.get('opening_hours')}\")\n                    \n                    with venue_detail_col2:\n                        # åƒ¹æ ¼è³‡è¨Š\n                        if venue.get('price_per_hour'):\n                            st.metric(\"æ¯å°æ™‚è²»ç”¨\", f\"NT${venue.get('price_per_hour')}\")\n                        \n                        # è©•åˆ†è³‡è¨Š\n                        if venue.get('rating'):\n                            st.metric(\"è©•åˆ†\", f\"{venue.get('rating'):.1f}/5.0\")\n                        \n                        # æ“ä½œæŒ‰éˆ•\n                        button_col1, button_col2, button_col3 = st.columns(3)\n                        \n                        with button_col1:\n                            if st.button(f\"ğŸ“‹ è©³æƒ…\", key=f\"detail_{idx}\"):\n                                # è¨­ç½®é¸å®šçš„å ´åœ°IDä¸¦å°èˆªåˆ°è©³æƒ…é é¢\n                                venue_id = venue.get('id')\n                                if venue_id:\n                                    st.query_params.id = venue_id\n                                    st.switch_page(\"pages/5_ğŸ¢_å ´åœ°è©³æƒ….py\")\n                        \n                        with button_col2:\n                            if st.button(f\"ğŸ“ åœ°åœ–\", key=f\"map_{idx}\"):\n                                st.session_state.selected_venue = venue.to_dict()\n                                st.switch_page(\"pages/2_ğŸ—ºï¸_åœ°åœ–æª¢è¦–.py\")\n                        \n                        with button_col3:\n                            if st.button(f\"â¤ï¸ æ”¶è—\", key=f\"fav_{idx}\"):\n                                # æ·»åŠ åˆ°æ”¶è—åˆ—è¡¨\n                                if 'favorites' not in st.session_state:\n                                    st.session_state.favorites = []\n                                \n                                venue_id = venue.get('id', idx)\n                                if venue_id not in st.session_state.favorites:\n                                    st.session_state.favorites.append(venue_id)\n                                    st.success(\"å·²åŠ å…¥æ”¶è—ï¼\")\n                                else:\n                                    st.info(\"å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­\")\n        \n        elif search_query:\n            st.warning(\"æœªæ‰¾åˆ°ç¬¦åˆæœå°‹æ¢ä»¶çš„å ´åœ°ã€‚è«‹å˜—è©¦ï¼š\")\n            st.markdown(\"\"\"\n            - ä½¿ç”¨ä¸åŒçš„é—œéµå­—\n            - èª¿æ•´ç¯©é¸æ¢ä»¶\n            - æ“´å¤§åƒ¹æ ¼æˆ–è©•åˆ†ç¯„åœ\n            \"\"\")\n        else:\n            st.info(\"è«‹è¨­å®šæœå°‹æ¢ä»¶æˆ–è¼¸å…¥é—œéµå­—ä¾†æœå°‹å ´åœ°\")\n    \n    else:\n        # é¡¯ç¤ºæ‰€æœ‰å ´åœ°\n        all_venues = st.session_state.data_manager.get_all_venues()\n        \n        if all_venues is not None and not all_venues.empty:\n            st.info(f\"å…±æœ‰ {len(all_venues)} å€‹å ´åœ°å¯ä¾›é¸æ“‡ã€‚ä½¿ç”¨å·¦å´ç¯©é¸å™¨ä¾†ç¸®å°æœå°‹ç¯„åœã€‚\")\n            \n            # é¡¯ç¤ºå‰10å€‹å ´åœ°ä½œç‚ºé è¦½\n            preview_venues = all_venues.head(10)\n            \n            for idx, venue in preview_venues.iterrows():\n                with st.container():\n                    venue_preview_col1, venue_preview_col2, venue_preview_col3 = st.columns([3, 1, 1])\n                    \n                    with venue_preview_col1:\n                        st.markdown(f\"**ğŸ“ {venue.get('name', 'æœªçŸ¥å ´åœ°')}**\")\n                        st.markdown(f\"ğŸƒâ€â™‚ï¸ {venue.get('sport_type', 'æœªæŒ‡å®š')} | ğŸ“ {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n                    \n                    with venue_preview_col2:\n                        if venue.get('price_per_hour'):\n                            st.markdown(f\"ğŸ’° NT${venue.get('price_per_hour')}/hr\")\n                        if venue.get('rating'):\n                            st.markdown(f\"â­ {venue.get('rating'):.1f}\")\n                    \n                    with venue_preview_col3:\n                        if st.button(f\"æŸ¥çœ‹è©³æƒ…\", key=f\"preview_{idx}\"):\n                            venue_id = venue.get('id')\n                            if venue_id:\n                                st.query_params.id = venue_id\n                                st.switch_page(\"pages/5_ğŸ¢_å ´åœ°è©³æƒ….py\")\n                    \n                    st.divider()\n        else:\n            st.error(\"ç„¡æ³•è¼‰å…¥å ´åœ°è³‡æ–™ã€‚è«‹æª¢æŸ¥è³‡æ–™ä¾†æºæˆ–ç¨å¾Œå†è©¦ã€‚\")\n\nwith col2:\n    st.subheader(\"ğŸ¯ æœå°‹å»ºè­°\")\n    \n    # ç†±é–€æœå°‹\n    popular_searches = st.session_state.data_manager.get_popular_searches()\n    if popular_searches:\n        st.markdown(\"**ğŸ”¥ ç†±é–€æœå°‹:**\")\n        for search_term in popular_searches[:5]:\n            if st.button(f\"ğŸ” {search_term}\", key=f\"popular_{search_term}\", use_container_width=True):\n                st.session_state.venue_search = search_term\n                st.rerun()\n    \n    # æ¨è–¦å ´åœ°\n    st.subheader(\"ğŸ’¡ æ¨è–¦å ´åœ°\")\n    \n    recommendations = st.session_state.recommendation_engine.get_trending_venues()\n    if recommendations is not None and not recommendations.empty:\n        for idx, venue in recommendations.head(5).iterrows():\n            with st.container():\n                st.markdown(f\"**ğŸ“ {venue.get('name', 'æœªçŸ¥å ´åœ°')}**\")\n                st.markdown(f\"ğŸƒâ€â™‚ï¸ {venue.get('sport_type', 'æœªæŒ‡å®š')}\")\n                st.markdown(f\"ğŸ“ {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n                \n                if venue.get('rating'):\n                    stars = \"â­\" * int(venue.get('rating', 0))\n                    st.markdown(f\"{stars} {venue.get('rating'):.1f}\")\n                \n                if st.button(f\"æŸ¥çœ‹\", key=f\"trend_rec_{idx}\", use_container_width=True):\n                    st.session_state.selected_venue = venue.to_dict()\n                    st.rerun()\n                \n                st.divider()\n    else:\n        st.info(\"æ¨è–¦å ´åœ°è¼‰å…¥ä¸­...\")\n\n# é¡¯ç¤ºé¸ä¸­å ´åœ°çš„è©³ç´°è³‡è¨Š\nif st.session_state.get('selected_venue'):\n    st.markdown(\"---\")\n    st.subheader(f\"ğŸ“ {st.session_state.selected_venue.get('name', 'å ´åœ°è©³æƒ…')}\")\n    \n    detail_col1, detail_col2 = st.columns([2, 1])\n    \n    with detail_col1:\n        venue = st.session_state.selected_venue\n        \n        st.markdown(f\"**ğŸ“ åœ°å€:** {venue.get('address', 'åœ°å€æœªæä¾›')}\")\n        st.markdown(f\"**ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹:** {venue.get('sport_type', 'æœªæŒ‡å®š')}\")\n        st.markdown(f\"**ğŸ¢ æ‰€åœ¨åœ°å€:** {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n        \n        if venue.get('facilities'):\n            facilities_list = venue.get('facilities', '').split(',') if isinstance(venue.get('facilities'), str) else venue.get('facilities', [])\n            st.markdown(f\"**ğŸ¢ è¨­æ–½:** {', '.join(facilities_list)}\")\n        \n        if venue.get('description'):\n            st.markdown(f\"**ğŸ“ æè¿°:** {venue.get('description')}\")\n        \n        if venue.get('contact_phone'):\n            st.markdown(f\"**ğŸ“ è¯çµ¡é›»è©±:** {venue.get('contact_phone')}\")\n        \n        if venue.get('opening_hours'):\n            st.markdown(f\"**ğŸ•’ ç‡Ÿæ¥­æ™‚é–“:** {venue.get('opening_hours')}\")\n        \n        if venue.get('website'):\n            st.markdown(f\"**ğŸŒ å®˜æ–¹ç¶²ç«™:** {venue.get('website')}\")\n    \n    with detail_col2:\n        # å ´åœ°è©•åˆ†å’Œåƒ¹æ ¼\n        if venue.get('rating'):\n            st.metric(\"è©•åˆ†\", f\"{venue.get('rating'):.1f}/5.0\")\n        \n        if venue.get('price_per_hour'):\n            st.metric(\"æ¯å°æ™‚è²»ç”¨\", f\"NT${venue.get('price_per_hour')}\")\n        \n        # æ“ä½œæŒ‰éˆ•\n        if st.button(\"ğŸ“ åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹\", use_container_width=True):\n            st.switch_page(\"pages/2_ğŸ—ºï¸_Map_View.py\")\n        \n        if st.button(\"â¤ï¸ åŠ å…¥æ”¶è—\", use_container_width=True):\n            if 'favorites' not in st.session_state:\n                st.session_state.favorites = []\n            \n            venue_id = venue.get('id', venue.get('name'))\n            if venue_id not in st.session_state.favorites:\n                st.session_state.favorites.append(venue_id)\n                st.success(\"å·²åŠ å…¥æ”¶è—ï¼\")\n            else:\n                st.info(\"å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­\")\n        \n        if st.button(\"ğŸ”„ æ¸…é™¤é¸æ“‡\", use_container_width=True):\n            st.session_state.selected_venue = None\n            st.rerun()\n","size_bytes":34255},"pages/2_ğŸ—ºï¸_åœ°åœ–æª¢è¦–.py":{"content":"import streamlit as st\nimport folium\nfrom streamlit_folium import st_folium\nimport pandas as pd\nfrom utils.data_manager import DataManager\nfrom utils.map_utils import MapUtils\n\nst.set_page_config(\n    page_title=\"åœ°åœ–æª¢è¦– - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"ğŸ—ºï¸\",\n    layout=\"wide\"\n)\n\n# è®¤è¯å®ˆå«å·²ç§»é™¤\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nif 'map_utils' not in st.session_state:\n    st.session_state.map_utils = MapUtils()\n\nst.title(\"ğŸ—ºï¸ å ´åœ°åœ°åœ–æª¢è¦–\")\nst.markdown(\"åœ¨åœ°åœ–ä¸Šæ¢ç´¢å°åŒ—å¸‚çš„é‹å‹•å ´åœ°\")\n\n# å´é‚Šæ¬„æ§åˆ¶\nwith st.sidebar:\n    st.header(\"ğŸ—ºï¸ åœ°åœ–æ§åˆ¶\")\n    \n    # åœ°åœ–ä¸­å¿ƒé»é¸æ“‡\n    map_center_option = st.selectbox(\n        \"åœ°åœ–ä¸­å¿ƒ\",\n        [\"å°åŒ—å¸‚ä¸­å¿ƒ\", \"ä¿¡ç¾©å€\", \"å¤§å®‰å€\", \"ä¸­å±±å€\", \"æ¾å±±å€\", \"è¬è¯å€\", \"ä¸­æ­£å€\", \"å¤§åŒå€\", \"å£«æ—å€\", \"åŒ—æŠ•å€\", \"å…§æ¹–å€\", \"å—æ¸¯å€\"],\n        key=\"map_center\"\n    )\n    \n    # é¡¯ç¤ºç¯©é¸\n    st.subheader(\"ğŸ“ é¡¯ç¤ºç¯©é¸\")\n    \n    # é‹å‹•é¡å‹ç¯©é¸\n    available_sports = st.session_state.data_manager.get_sport_types()\n    if available_sports:\n        show_sports = st.multiselect(\n            \"é¡¯ç¤ºé‹å‹•é¡å‹\",\n            available_sports,\n            default=available_sports[:5] if len(available_sports) > 5 else available_sports,\n            key=\"map_sports_filter\"\n        )\n    else:\n        show_sports = []\n        st.info(\"è¼‰å…¥é‹å‹•é¡å‹ä¸­...\")\n    \n    # åœ°å€ç¯©é¸\n    available_districts = st.session_state.data_manager.get_districts()\n    if available_districts:\n        show_districts = st.multiselect(\n            \"é¡¯ç¤ºåœ°å€\",\n            available_districts,\n            default=available_districts[:5] if len(available_districts) > 5 else available_districts,\n            key=\"map_districts_filter\"\n        )\n    else:\n        show_districts = []\n        st.info(\"è¼‰å…¥åœ°å€è³‡æ–™ä¸­...\")\n    \n    # åƒ¹æ ¼ç¯„åœç¯©é¸\n    price_range = st.slider(\n        \"åƒ¹æ ¼ç¯„åœ (æ¯å°æ™‚)\",\n        0, 10000,\n        value=[0, 5000],\n        step=100,\n        format=\"NT$%d\",\n        key=\"map_price_filter\"\n    )\n    \n    # è©•åˆ†ç¯©é¸\n    min_rating = st.slider(\n        \"æœ€ä½è©•åˆ†\",\n        0.0, 5.0,\n        value=0.0,\n        step=0.1,\n        format=\"%.1f\",\n        key=\"map_rating_filter\"\n    )\n    \n    # åœ°åœ–æ¨£å¼\n    st.subheader(\"ğŸ¨ åœ°åœ–æ¨£å¼\")\n    map_style = st.selectbox(\n        \"åœ°åœ–æ¨£å¼\",\n        [\"OpenStreetMap\", \"CartoDB positron\", \"CartoDB dark_matter\", \"Stamen Terrain\"],\n        key=\"map_style\"\n    )\n    \n    # é¡¯ç¤ºé¸é …\n    show_heatmap = st.checkbox(\"é¡¯ç¤ºç†±åŠ›åœ–\", value=False, key=\"show_heatmap\")\n    show_clusters = st.checkbox(\"ç¾¤é›†é¡¯ç¤º\", value=True, key=\"show_clusters\")\n\n# ä¸»è¦å…§å®¹\ncol1, col2 = st.columns([3, 1])\n\nwith col1:\n    # ç²å–åœ°åœ–ä¸­å¿ƒåº§æ¨™\n    map_center = st.session_state.map_utils.get_district_center(map_center_option)\n    \n    # å‰µå»ºåœ°åœ–\n    m = folium.Map(\n        location=map_center,\n        zoom_start=12,\n        tiles=None\n    )\n    \n    # æ·»åŠ åœ°åœ–åœ–å±¤\n    tile_mapping = {\n        \"OpenStreetMap\": folium.TileLayer('openstreetmap', attr='OpenStreetMap contributors'),\n        \"CartoDB positron\": folium.TileLayer('cartodbpositron', attr='CartoDB contributors'),\n        \"CartoDB dark_matter\": folium.TileLayer('cartodbdark_matter', attr='CartoDB contributors'),\n        \"Stamen Terrain\": folium.TileLayer('stamenterrain', attr='Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under ODbL.')\n    }\n    \n    if map_style in tile_mapping:\n        tile_mapping[map_style].add_to(m)\n    else:\n        folium.TileLayer('openstreetmap').add_to(m)\n    \n    # ç²å–ç¯©é¸å¾Œçš„å ´åœ°è³‡æ–™\n    filtered_venues = st.session_state.data_manager.get_filtered_venues(\n        sport_types=show_sports,\n        districts=show_districts,\n        price_range=price_range,\n        min_rating=min_rating\n    )\n    \n    if filtered_venues is not None and not filtered_venues.empty:\n        # æ·»åŠ å ´åœ°æ¨™è¨˜\n        if show_clusters:\n            from folium.plugins import MarkerCluster\n            marker_cluster = MarkerCluster().add_to(m)\n            container = marker_cluster\n        else:\n            container = m\n        \n        # ç‚ºä¸åŒé‹å‹•é¡å‹è¨­å®šä¸åŒé¡è‰²\n        sport_colors = st.session_state.map_utils.get_sport_colors()\n        \n        for idx, venue in filtered_venues.iterrows():\n            if pd.notna(venue.get('latitude')) and pd.notna(venue.get('longitude')):\n                sport_type = venue.get('sport_type', 'å…¶ä»–')\n                color = sport_colors.get(sport_type, 'gray')\n                \n                # å»ºç«‹å½ˆå‡ºè¦–çª—å…§å®¹\n                popup_html = f\"\"\"\n                <div style=\"width: 250px;\">\n                    <h4>{venue.get('name', 'æœªçŸ¥å ´åœ°')}</h4>\n                    <p><b>ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹:</b> {venue.get('sport_type', 'æœªæŒ‡å®š')}</p>\n                    <p><b>ğŸ“ åœ°å€:</b> {venue.get('address', 'åœ°å€æœªæä¾›')}</p>\n                    <p><b>ğŸ¢ åœ°å€:</b> {venue.get('district', 'æœªçŸ¥åœ°å€')}</p>\n                    {f'<p><b>ğŸ’° åƒ¹æ ¼:</b> NT${venue.get(\"price_per_hour\")}/hr</p>' if venue.get('price_per_hour') else ''}\n                    {f'<p><b>â­ è©•åˆ†:</b> {venue.get(\"rating\"):.1f}/5.0</p>' if venue.get('rating') else ''}\n                    {f'<p><b>ğŸ¢ è¨­æ–½:</b> {venue.get(\"facilities\")}</p>' if venue.get('facilities') else ''}\n                </div>\n                \"\"\"\n                \n                folium.Marker(\n                    location=[venue.get('latitude'), venue.get('longitude')],\n                    popup=folium.Popup(popup_html, max_width=300),\n                    tooltip=f\"{venue.get('name', 'æœªçŸ¥å ´åœ°')} - {sport_type}\",\n                    icon=folium.Icon(color=color, icon='info-sign')\n                ).add_to(container)\n        \n        # æ·»åŠ ç†±åŠ›åœ–ï¼ˆå¦‚æœå‹¾é¸ï¼‰\n        if show_heatmap and not filtered_venues.empty:\n            from folium.plugins import HeatMap\n            \n            heat_data = []\n            for idx, venue in filtered_venues.iterrows():\n                if pd.notna(venue.get('latitude')) and pd.notna(venue.get('longitude')):\n                    # ä½¿ç”¨è©•åˆ†ä½œç‚ºç†±åŠ›æ¬Šé‡\n                    weight = venue.get('rating', 3.0)\n                    heat_data.append([venue.get('latitude'), venue.get('longitude'), weight])\n            \n            if heat_data:\n                HeatMap(heat_data, radius=15, max_zoom=18).add_to(m)\n        \n        # é¡¯ç¤ºåœ°åœ–\n        map_data = st_folium(m, width=700, height=500, returned_objects=[\"last_clicked\"])\n        \n        # è™•ç†åœ°åœ–é»æ“Šäº‹ä»¶\n        if map_data['last_clicked']:\n            clicked_lat = map_data['last_clicked']['lat']\n            clicked_lng = map_data['last_clicked']['lng']\n            \n            # å°‹æ‰¾æœ€è¿‘çš„å ´åœ°\n            nearest_venue = st.session_state.map_utils.find_nearest_venue(\n                filtered_venues, clicked_lat, clicked_lng\n            )\n            \n            if nearest_venue is not None:\n                st.session_state.selected_venue = nearest_venue\n                \n        # é¡¯ç¤ºåœ–ä¾‹\n        st.markdown(\"### ğŸ¨ åœ–ä¾‹\")\n        legend_cols = st.columns(len(sport_colors))\n        \n        for i, (sport, color) in enumerate(sport_colors.items()):\n            if i < len(legend_cols):\n                with legend_cols[i]:\n                    st.markdown(f\"ğŸ”µ **{sport}**\" if color == 'blue' else \n                              f\"ğŸ”´ **{sport}**\" if color == 'red' else \n                              f\"ğŸŸ¢ **{sport}**\" if color == 'green' else \n                              f\"ğŸŸ  **{sport}**\" if color == 'orange' else \n                              f\"ğŸŸ£ **{sport}**\" if color == 'purple' else \n                              f\"âš« **{sport}**\")\n    \n    else:\n        st.warning(\"æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å ´åœ°è³‡æ–™å¯é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š\")\n        # é¡¯ç¤ºç©ºç™½åœ°åœ–\n        st_folium(m, width=700, height=500)\n\nwith col2:\n    st.subheader(\"ğŸ“Š åœ°åœ–çµ±è¨ˆ\")\n    \n    if filtered_venues is not None and not filtered_venues.empty:\n        # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š\n        total_venues = len(filtered_venues)\n        avg_rating = filtered_venues['rating'].mean() if 'rating' in filtered_venues.columns else 0\n        avg_price = filtered_venues['price_per_hour'].mean() if 'price_per_hour' in filtered_venues.columns else 0\n        \n        st.metric(\"é¡¯ç¤ºå ´åœ°æ•¸\", total_venues)\n        if avg_rating > 0:\n            st.metric(\"å¹³å‡è©•åˆ†\", f\"{avg_rating:.1f}/5.0\")\n        if avg_price > 0:\n            st.metric(\"å¹³å‡åƒ¹æ ¼\", f\"NT${avg_price:.0f}/hr\")\n        \n        # æŒ‰å€åŸŸçµ±è¨ˆ\n        if 'district' in filtered_venues.columns:\n            district_counts = filtered_venues['district'].value_counts()\n            \n            st.markdown(\"**ğŸ“ å„å€åŸŸå ´åœ°æ•¸é‡:**\")\n            for district, count in district_counts.head(10).items():\n                st.markdown(f\"â€¢ {district}: {count} å€‹å ´åœ°\")\n        \n        # æŒ‰é‹å‹•é¡å‹çµ±è¨ˆ\n        if 'sport_type' in filtered_venues.columns:\n            sport_counts = filtered_venues['sport_type'].value_counts()\n            \n            st.markdown(\"**ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹åˆ†å¸ƒ:**\")\n            for sport, count in sport_counts.head(10).items():\n                st.markdown(f\"â€¢ {sport}: {count} å€‹å ´åœ°\")\n    \n    else:\n        st.info(\"é¸æ“‡ç¯©é¸æ¢ä»¶ä»¥é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š\")\n    \n    # å¿«é€Ÿå°èˆª\n    st.subheader(\"ğŸ§­ å¿«é€Ÿå°èˆª\")\n    \n    major_districts = [\"ä¿¡ç¾©å€\", \"å¤§å®‰å€\", \"ä¸­å±±å€\", \"æ¾å±±å€\"]\n    for district in major_districts:\n        if st.button(f\"ğŸ“ {district}\", key=f\"nav_{district}\", use_container_width=True):\n            # æ›´æ–°åœ°åœ–ä¸­å¿ƒåˆ°è©²å€åŸŸ\n            st.session_state.map_center = district\n            st.rerun()\n    \n    # å ´åœ°é¡å‹å¿«é€Ÿç¯©é¸\n    st.subheader(\"ğŸƒâ€â™‚ï¸ å¿«é€Ÿç¯©é¸\")\n    \n    if available_sports:\n        popular_sports = available_sports[:6]  # é¡¯ç¤ºå‰6å€‹é‹å‹•é¡å‹\n        for sport in popular_sports:\n            if st.button(f\"ğŸƒâ€â™‚ï¸ {sport}\", key=f\"sport_filter_{sport}\", use_container_width=True):\n                st.session_state.map_sports_filter = [sport]\n                st.rerun()\n\n# é¡¯ç¤ºé¸ä¸­å ´åœ°çš„è©³ç´°è³‡è¨Š\nif st.session_state.get('selected_venue'):\n    st.markdown(\"---\")\n    st.subheader(f\"ğŸ“ {st.session_state.selected_venue.get('name', 'é¸ä¸­å ´åœ°')}\")\n    \n    venue = st.session_state.selected_venue\n    \n    info_col1, info_col2, info_col3 = st.columns([2, 1, 1])\n    \n    with info_col1:\n        st.markdown(f\"**ğŸ“ åœ°å€:** {venue.get('address', 'åœ°å€æœªæä¾›')}\")\n        st.markdown(f\"**ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹:** {venue.get('sport_type', 'æœªæŒ‡å®š')}\")\n        st.markdown(f\"**ğŸ¢ åœ°å€:** {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n        \n        if venue.get('contact_phone'):\n            st.markdown(f\"**ğŸ“ é›»è©±:** {venue.get('contact_phone')}\")\n    \n    with info_col2:\n        if venue.get('rating'):\n            st.metric(\"è©•åˆ†\", f\"{venue.get('rating'):.1f}/5.0\")\n        if venue.get('price_per_hour'):\n            st.metric(\"åƒ¹æ ¼\", f\"NT${venue.get('price_per_hour')}/hr\")\n    \n    with info_col3:\n        if st.button(\"ğŸ” è©³ç´°è³‡è¨Š\", use_container_width=True):\n            st.switch_page(\"pages/1_ğŸ”_Search_Venues.py\")\n        \n        if st.button(\"â¤ï¸ åŠ å…¥æ”¶è—\", key=\"map_favorite\", use_container_width=True):\n            if 'favorites' not in st.session_state:\n                st.session_state.favorites = []\n            \n            venue_id = venue.get('id', venue.get('name'))\n            if venue_id not in st.session_state.favorites:\n                st.session_state.favorites.append(venue_id)\n                st.success(\"å·²åŠ å…¥æ”¶è—ï¼\")\n            else:\n                st.info(\"å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­\")\n","size_bytes":12004},"pages/3_â­_å€‹äººæ¨è–¦.py":{"content":"import streamlit as st\nimport pandas as pd\nimport plotly.express as px\nfrom utils.data_manager import DataManager\nfrom utils.recommendation_engine import RecommendationEngine\n\nst.set_page_config(\n    page_title=\"å€‹äººæ¨è–¦ - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"â­\",\n    layout=\"wide\"\n)\n\n# è®¤è¯å®ˆå«å·²ç§»é™¤\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nif 'recommendation_engine' not in st.session_state:\n    st.session_state.recommendation_engine = RecommendationEngine()\n\nif 'user_preferences' not in st.session_state:\n    st.session_state.user_preferences = {\n        'preferred_sports': [],\n        'preferred_districts': [],\n        'price_range': [0, 10000],\n        'search_history': [],\n        'visited_venues': [],\n        'favorite_venues': []\n    }\n\nst.title(\"â­ å€‹äººåŒ–æ¨è–¦\")\nst.markdown(\"åŸºæ–¼æ‚¨çš„åå¥½å’Œè¡Œç‚ºï¼Œç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„é‹å‹•å ´åœ°\")\n\n# å´é‚Šæ¬„ - æ¨è–¦è¨­å®š\nwith st.sidebar:\n    st.header(\"ğŸ¯ æ¨è–¦è¨­å®š\")\n    \n    # æ¨è–¦é¡å‹é¸æ“‡\n    recommendation_type = st.selectbox(\n        \"æ¨è–¦é¡å‹\",\n        [\"å€‹äººåŒ–æ¨è–¦\", \"æ©Ÿå™¨å­¸ç¿’æ¨è–¦\", \"èšé¡åˆ†ææ¨è–¦\", \"å…§å®¹ç›¸ä¼¼æ¨è–¦\", \"ç†±é–€å ´åœ°\", \"æ–°å ´åœ°\", \"ç›¸ä¼¼ç”¨æˆ¶æ¨è–¦\", \"åŸºæ–¼è©•åˆ†æ¨è–¦\"],\n        key=\"rec_type\"\n    )\n    \n    # æ¨è–¦æ•¸é‡\n    num_recommendations = st.slider(\n        \"æ¨è–¦æ•¸é‡\",\n        5, 20, 10,\n        key=\"num_rec\"\n    )\n    \n    # å¤šæ¨£æ€§è¨­å®š\n    diversity_weight = st.slider(\n        \"çµæœå¤šæ¨£æ€§\",\n        0.0, 1.0, 0.3,\n        step=0.1,\n        help=\"æ•¸å€¼è¶Šé«˜ï¼Œæ¨è–¦çµæœè¶Šå¤šæ¨£åŒ–\",\n        key=\"diversity\"\n    )\n    \n    st.subheader(\"ğŸ“Š åå¥½åˆ†æ\")\n    \n    # é¡¯ç¤ºç”¨æˆ¶åå¥½çµ±è¨ˆ\n    if st.session_state.user_preferences['search_history']:\n        st.metric(\"æœå°‹æ¬¡æ•¸\", len(st.session_state.user_preferences['search_history']))\n    \n    if 'favorites' in st.session_state:\n        st.metric(\"æ”¶è—å ´åœ°\", len(st.session_state.favorites))\n    \n    # æ›´æ–°åå¥½æŒ‰éˆ•\n    if st.button(\"ğŸ”„ æ›´æ–°åå¥½åˆ†æ\", use_container_width=True):\n        # é‡æ–°åˆ†æç”¨æˆ¶åå¥½\n        st.session_state.recommendation_engine.update_user_profile(\n            st.session_state.user_preferences\n        )\n        st.success(\"åå¥½åˆ†æå·²æ›´æ–°ï¼\")\n\n# ä¸»è¦å…§å®¹\ntab1, tab2, tab3, tab4 = st.tabs([\"ğŸ¯ æ¨è–¦çµæœ\", \"ğŸ“Š åå¥½åˆ†æ\", \"ğŸ”„ æ¨è–¦è§£é‡‹\", \"âš™ï¸ è¨­å®šèª¿æ•´\"])\n\nwith tab1:\n    st.subheader(f\"ğŸŒŸ {recommendation_type}\")\n    \n    # æ ¹æ“šé¸æ“‡çš„æ¨è–¦é¡å‹ç²å–æ¨è–¦çµæœ\n    if recommendation_type == \"å€‹äººåŒ–æ¨è–¦\":\n        recommendations = st.session_state.recommendation_engine.get_personalized_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations,\n            diversity_weight=diversity_weight\n        )\n    elif recommendation_type == \"æ©Ÿå™¨å­¸ç¿’æ¨è–¦\":\n        recommendations = st.session_state.recommendation_engine.get_ml_based_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations\n        )\n    elif recommendation_type == \"èšé¡åˆ†ææ¨è–¦\":\n        recommendations = st.session_state.recommendation_engine.get_cluster_based_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations\n        )\n    elif recommendation_type == \"å…§å®¹ç›¸ä¼¼æ¨è–¦\":\n        recommendations = st.session_state.recommendation_engine.get_content_based_ml_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations\n        )\n    elif recommendation_type == \"ç†±é–€å ´åœ°\":\n        recommendations = st.session_state.recommendation_engine.get_trending_venues(\n            num_recommendations=num_recommendations\n        )\n    elif recommendation_type == \"æ–°å ´åœ°\":\n        recommendations = st.session_state.recommendation_engine.get_new_venues(\n            num_recommendations=num_recommendations\n        )\n    elif recommendation_type == \"ç›¸ä¼¼ç”¨æˆ¶æ¨è–¦\":\n        recommendations = st.session_state.recommendation_engine.get_collaborative_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations\n        )\n    else:  # åŸºæ–¼è©•åˆ†æ¨è–¦\n        recommendations = st.session_state.recommendation_engine.get_rating_based_recommendations(\n            st.session_state.user_preferences,\n            num_recommendations=num_recommendations\n        )\n    \n    if recommendations is not None and not recommendations.empty:\n        # é¡¯ç¤ºæ¨è–¦çµæœ\n        for idx, venue in recommendations.iterrows():\n            with st.expander(\n                f\"â­ {venue.get('name', 'æœªçŸ¥å ´åœ°')} - æ¨è–¦åº¦: {venue.get('recommendation_score', 0):.1f}\",\n                expanded=idx < 3  # å‰3å€‹è‡ªå‹•å±•é–‹\n            ):\n                rec_col1, rec_col2, rec_col3 = st.columns([2, 1, 1])\n                \n                with rec_col1:\n                    st.markdown(f\"**ğŸ“ åœ°å€:** {venue.get('address', 'åœ°å€æœªæä¾›')}\")\n                    st.markdown(f\"**ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹:** {venue.get('sport_type', 'æœªæŒ‡å®š')}\")\n                    st.markdown(f\"**ğŸ¢ åœ°å€:** {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n                    \n                    if venue.get('facilities'):\n                        facilities_list = venue.get('facilities', '').split(',') if isinstance(venue.get('facilities'), str) else venue.get('facilities', [])\n                        st.markdown(f\"**ğŸ¢ è¨­æ–½:** {', '.join(facilities_list)}\")\n                    \n                    if venue.get('description'):\n                        st.markdown(f\"**ğŸ“ æè¿°:** {venue.get('description')}\")\n                    \n                    # æ¨è–¦åŸå› \n                    if venue.get('recommendation_reason'):\n                        st.markdown(f\"**ğŸ’¡ æ¨è–¦åŸå› :** {venue.get('recommendation_reason')}\")\n                \n                with rec_col2:\n                    # è©•åˆ†å’Œåƒ¹æ ¼\n                    if venue.get('rating'):\n                        st.metric(\"è©•åˆ†\", f\"{venue.get('rating'):.1f}/5.0\")\n                    \n                    if venue.get('price_per_hour'):\n                        st.metric(\"åƒ¹æ ¼\", f\"NT${venue.get('price_per_hour')}/hr\")\n                    \n                    # æ¨è–¦åº¦åˆ†æ•¸\n                    if venue.get('recommendation_score'):\n                        st.metric(\"æ¨è–¦åº¦\", f\"{venue.get('recommendation_score'):.1f}/10\")\n                \n                with rec_col3:\n                    # æ“ä½œæŒ‰éˆ•\n                    if st.button(f\"ğŸ” è©³ç´°è³‡è¨Š\", key=f\"rec_detail_{idx}\"):\n                        st.session_state.selected_venue = venue.to_dict()\n                        st.switch_page(\"pages/1_ğŸ”_Search_Venues.py\")\n                    \n                    if st.button(f\"ğŸ“ åœ°åœ–ä½ç½®\", key=f\"rec_map_{idx}\"):\n                        st.session_state.selected_venue = venue.to_dict()\n                        st.switch_page(\"pages/2_ğŸ—ºï¸_Map_View.py\")\n                    \n                    if st.button(f\"â¤ï¸ æ”¶è—\", key=f\"rec_fav_{idx}\"):\n                        if 'favorites' not in st.session_state:\n                            st.session_state.favorites = []\n                        \n                        venue_id = venue.get('id', venue.get('name'))\n                        if venue_id not in st.session_state.favorites:\n                            st.session_state.favorites.append(venue_id)\n                            st.success(\"å·²åŠ å…¥æ”¶è—ï¼\")\n                        else:\n                            st.info(\"å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­\")\n                    \n                    # åé¥‹æŒ‰éˆ•\n                    feedback_col1, feedback_col2 = st.columns(2)\n                    with feedback_col1:\n                        if st.button(\"ğŸ‘\", key=f\"rec_like_{idx}\", help=\"å–œæ­¡é€™å€‹æ¨è–¦\"):\n                            st.session_state.recommendation_engine.record_feedback(\n                                venue.get('id'), 'like', st.session_state.user_preferences\n                            )\n                            st.success(\"æ„Ÿè¬æ‚¨çš„åé¥‹ï¼\")\n                    \n                    with feedback_col2:\n                        if st.button(\"ğŸ‘\", key=f\"rec_dislike_{idx}\", help=\"ä¸å–œæ­¡é€™å€‹æ¨è–¦\"):\n                            st.session_state.recommendation_engine.record_feedback(\n                                venue.get('id'), 'dislike', st.session_state.user_preferences\n                            )\n                            st.info(\"æˆ‘å€‘æœƒæ”¹å–„æ¨è–¦çµæœ\")\n    \n    else:\n        st.warning(\"æš«æ™‚ç„¡æ³•ç”Ÿæˆæ¨è–¦çµæœã€‚è«‹å˜—è©¦ï¼š\")\n        st.markdown(\"\"\"\n        - åœ¨ä¸»é é¢è¨­å®šæ‚¨çš„åå¥½\n        - æœå°‹ä¸€äº›å ´åœ°ä»¥å»ºç«‹ä½¿ç”¨æ­·å²\n        - æ”¶è—ä¸€äº›æ‚¨å–œæ­¡çš„å ´åœ°\n        - èª¿æ•´æ¨è–¦è¨­å®š\n        \"\"\")\n\nwith tab2:\n    st.subheader(\"ğŸ“Š æ‚¨çš„åå¥½åˆ†æ\")\n    \n    # åå¥½é‹å‹•é¡å‹åœ–è¡¨\n    if st.session_state.user_preferences['preferred_sports']:\n        sport_counts = {}\n        for sport in st.session_state.user_preferences['preferred_sports']:\n            sport_counts[sport] = sport_counts.get(sport, 0) + 1\n        \n        if sport_counts:\n            fig_sports = px.pie(\n                values=list(sport_counts.values()),\n                names=list(sport_counts.keys()),\n                title=\"åå¥½é‹å‹•é¡å‹åˆ†å¸ƒ\"\n            )\n            st.plotly_chart(fig_sports, use_container_width=True)\n    else:\n        st.info(\"è«‹åœ¨ä¸»é é¢è¨­å®šæ‚¨çš„é‹å‹•é¡å‹åå¥½\")\n    \n    # åå¥½åœ°å€åœ–è¡¨\n    if st.session_state.user_preferences['preferred_districts']:\n        district_counts = {}\n        for district in st.session_state.user_preferences['preferred_districts']:\n            district_counts[district] = district_counts.get(district, 0) + 1\n        \n        if district_counts:\n            fig_districts = px.bar(\n                x=list(district_counts.keys()),\n                y=list(district_counts.values()),\n                title=\"åå¥½åœ°å€åˆ†å¸ƒ\",\n                labels={'x': 'åœ°å€', 'y': 'åå¥½ç¨‹åº¦'}\n            )\n            st.plotly_chart(fig_districts, use_container_width=True)\n    \n    # æœå°‹æ­·å²åˆ†æ\n    if st.session_state.user_preferences['search_history']:\n        st.subheader(\"ğŸ” æœå°‹æ­·å²åˆ†æ\")\n        \n        search_frequency = {}\n        for search in st.session_state.user_preferences['search_history']:\n            search_frequency[search] = search_frequency.get(search, 0) + 1\n        \n        # é¡¯ç¤ºæœ€å¸¸æœå°‹çš„é—œéµå­—\n        sorted_searches = sorted(search_frequency.items(), key=lambda x: x[1], reverse=True)\n        \n        st.markdown(\"**æœ€å¸¸æœå°‹çš„é—œéµå­—:**\")\n        for search, count in sorted_searches[:10]:\n            st.markdown(f\"â€¢ {search}: {count} æ¬¡\")\n    \n    # æ”¶è—å ´åœ°åˆ†æ\n    if 'favorites' in st.session_state and st.session_state.favorites:\n        st.subheader(\"â¤ï¸ æ”¶è—å ´åœ°åˆ†æ\")\n        \n        favorite_venues = st.session_state.data_manager.get_venues_by_ids(st.session_state.favorites)\n        \n        if favorite_venues is not None and not favorite_venues.empty:\n            # æ”¶è—å ´åœ°çš„é‹å‹•é¡å‹åˆ†å¸ƒ\n            if 'sport_type' in favorite_venues.columns:\n                fav_sport_counts = favorite_venues['sport_type'].value_counts()\n                \n                fig_fav_sports = px.bar(\n                    x=fav_sport_counts.index,\n                    y=fav_sport_counts.values,\n                    title=\"æ”¶è—å ´åœ°é‹å‹•é¡å‹åˆ†å¸ƒ\",\n                    labels={'x': 'é‹å‹•é¡å‹', 'y': 'å ´åœ°æ•¸é‡'}\n                )\n                st.plotly_chart(fig_fav_sports, use_container_width=True)\n\nwith tab3:\n    st.subheader(\"ğŸ”„ æ¨è–¦æ¼”ç®—æ³•èªªæ˜\")\n    \n    st.markdown(\"\"\"\n    ### ğŸ¤– æˆ‘å€‘å¦‚ä½•ç‚ºæ‚¨æ¨è–¦å ´åœ°\n    \n    æˆ‘å€‘çš„æ¨è–¦ç³»çµ±çµåˆå¤šç¨®æ¼”ç®—æ³•ä¾†ç‚ºæ‚¨æ‰¾åˆ°æœ€é©åˆçš„é‹å‹•å ´åœ°ï¼š\n    \n    #### 1. ğŸ¯ å€‹äººåŒ–æ¨è–¦\n    - **åŸºæ–¼å…§å®¹çš„æ¨è–¦**: æ ¹æ“šæ‚¨çš„é‹å‹•é¡å‹å’Œåœ°å€åå¥½\n    - **å”åŒéæ¿¾**: åˆ†æèˆ‡æ‚¨ç›¸ä¼¼ç”¨æˆ¶çš„é¸æ“‡\n    - **æ··åˆæ¨è–¦**: çµåˆå¤šç¨®æ–¹æ³•æä¾›æœ€ä½³çµæœ\n    \n    #### 2. ğŸ“Š è€ƒæ…®å› ç´ \n    - **åå¥½åŒ¹é…åº¦**: å ´åœ°æ˜¯å¦ç¬¦åˆæ‚¨è¨­å®šçš„åå¥½\n    - **è©•åˆ†æ¬Šé‡**: é«˜è©•åˆ†å ´åœ°æœƒç²å¾—æ›´é«˜æ¨è–¦åˆ†æ•¸\n    - **è·é›¢å› ç´ **: è€ƒæ…®æ‚¨åå¥½åœ°å€çš„åœ°ç†ä½ç½®\n    - **åƒ¹æ ¼é©é…**: ç¬¦åˆæ‚¨é ç®—ç¯„åœçš„å ´åœ°\n    - **è¨­æ–½åŒ¹é…**: æä¾›æ‚¨éœ€è¦è¨­æ–½çš„å ´åœ°\n    \n    #### 3. ğŸ”„ å­¸ç¿’æ©Ÿåˆ¶\n    - **æœå°‹æ­·å²**: åˆ†ææ‚¨çš„æœå°‹æ¨¡å¼\n    - **é»æ“Šè¡Œç‚º**: è¨˜éŒ„æ‚¨æ„Ÿèˆˆè¶£çš„å ´åœ°é¡å‹\n    - **æ”¶è—åå¥½**: å¾æ‚¨çš„æ”¶è—ä¸­å­¸ç¿’åå¥½\n    - **åé¥‹å­¸ç¿’**: æ ¹æ“šæ‚¨çš„é»è®š/é»è¸©èª¿æ•´æ¨è–¦\n    \"\"\")\n    \n    # é¡¯ç¤ºç•¶å‰æ¨è–¦æ¬Šé‡\n    if recommendations is not None and not recommendations.empty:\n        st.subheader(\"ğŸ”¢ ç•¶å‰æ¨è–¦æ¬Šé‡åˆ†æ\")\n        \n        # ç‚ºç¬¬ä¸€å€‹æ¨è–¦å ´åœ°é¡¯ç¤ºè©³ç´°è©•åˆ†åˆ†è§£\n        first_venue = recommendations.iloc[0]\n        \n        st.markdown(f\"**ä»¥ã€Œ{first_venue.get('name', 'æœªçŸ¥å ´åœ°')}ã€ç‚ºä¾‹:**\")\n        \n        weight_col1, weight_col2 = st.columns(2)\n        \n        with weight_col1:\n            st.metric(\"åå¥½åŒ¹é…åº¦\", f\"{first_venue.get('preference_match', 0):.1f}/10\")\n            st.metric(\"è©•åˆ†æ¬Šé‡\", f\"{first_venue.get('rating_weight', 0):.1f}/10\")\n            st.metric(\"è·é›¢è©•åˆ†\", f\"{first_venue.get('distance_score', 0):.1f}/10\")\n        \n        with weight_col2:\n            st.metric(\"åƒ¹æ ¼é©é…åº¦\", f\"{first_venue.get('price_match', 0):.1f}/10\")\n            st.metric(\"è¨­æ–½åŒ¹é…åº¦\", f\"{first_venue.get('facility_match', 0):.1f}/10\")\n            st.metric(\"ç¸½æ¨è–¦åˆ†æ•¸\", f\"{first_venue.get('recommendation_score', 0):.1f}/10\")\n\nwith tab4:\n    st.subheader(\"âš™ï¸ æ¨è–¦ç³»çµ±èª¿æ•´\")\n    \n    st.markdown(\"èª¿æ•´ä»¥ä¸‹è¨­å®šä¾†å€‹äººåŒ–æ‚¨çš„æ¨è–¦é«”é©—ï¼š\")\n    \n    # æ¨è–¦æ¬Šé‡èª¿æ•´\n    st.markdown(\"#### ğŸšï¸ æ¨è–¦å› ç´ æ¬Šé‡\")\n    \n    weight_col1, weight_col2 = st.columns(2)\n    \n    with weight_col1:\n        preference_weight = st.slider(\n            \"åå¥½åŒ¹é…é‡è¦æ€§\",\n            0.0, 1.0, 0.3,\n            step=0.1,\n            key=\"pref_weight\"\n        )\n        \n        rating_weight = st.slider(\n            \"è©•åˆ†é‡è¦æ€§\",\n            0.0, 1.0, 0.25,\n            step=0.1,\n            key=\"rating_weight\"\n        )\n        \n        price_weight = st.slider(\n            \"åƒ¹æ ¼é‡è¦æ€§\",\n            0.0, 1.0, 0.2,\n            step=0.1,\n            key=\"price_weight\"\n        )\n    \n    with weight_col2:\n        distance_weight = st.slider(\n            \"è·é›¢é‡è¦æ€§\",\n            0.0, 1.0, 0.15,\n            step=0.1,\n            key=\"distance_weight\"\n        )\n        \n        facility_weight = st.slider(\n            \"è¨­æ–½é‡è¦æ€§\",\n            0.0, 1.0, 0.1,\n            step=0.1,\n            key=\"facility_weight\"\n        )\n    \n    # æ¨è–¦åå¥½è¨­å®š\n    st.markdown(\"#### ğŸ¯ æ¨è–¦åå¥½\")\n    \n    pref_col1, pref_col2 = st.columns(2)\n    \n    with pref_col1:\n        explore_vs_exploit = st.slider(\n            \"æ¢ç´¢ vs åˆ©ç”¨\",\n            0.0, 1.0, 0.3,\n            step=0.1,\n            help=\"æ•¸å€¼è¶Šé«˜è¶Šæœƒæ¨è–¦æ–°é¡å‹å ´åœ°ï¼Œè¶Šä½è¶Šæœƒæ¨è–¦ç†Ÿæ‚‰é¡å‹\",\n            key=\"explore_exploit\"\n        )\n        \n        popularity_bias = st.slider(\n            \"ç†±é–€ç¨‹åº¦åå¥½\",\n            0.0, 1.0, 0.4,\n            step=0.1,\n            help=\"æ•¸å€¼è¶Šé«˜è¶Šåå¥½ç†±é–€å ´åœ°\",\n            key=\"popularity_bias\"\n        )\n    \n    with pref_col2:\n        novelty_preference = st.slider(\n            \"æ–°å ´åœ°åå¥½\",\n            0.0, 1.0, 0.2,\n            step=0.1,\n            help=\"æ•¸å€¼è¶Šé«˜è¶Šæœƒæ¨è–¦æ–°é–‹æ”¾çš„å ´åœ°\",\n            key=\"novelty_pref\"\n        )\n        \n        serendipity_factor = st.slider(\n            \"æ„å¤–ç™¼ç¾å› å­\",\n            0.0, 1.0, 0.15,\n            step=0.1,\n            help=\"æ•¸å€¼è¶Šé«˜è¶Šæœƒæ¨è–¦æ„æƒ³ä¸åˆ°ä½†å¯èƒ½å–œæ­¡çš„å ´åœ°\",\n            key=\"serendipity\"\n        )\n    \n    # æ‡‰ç”¨è¨­å®š\n    if st.button(\"ğŸ’¾ æ‡‰ç”¨è¨­å®š\", type=\"primary\", use_container_width=True):\n        # æ›´æ–°æ¨è–¦å¼•æ“çš„æ¬Šé‡è¨­å®š\n        weights = {\n            'preference_weight': preference_weight,\n            'rating_weight': rating_weight,\n            'price_weight': price_weight,\n            'distance_weight': distance_weight,\n            'facility_weight': facility_weight,\n            'explore_vs_exploit': explore_vs_exploit,\n            'popularity_bias': popularity_bias,\n            'novelty_preference': novelty_preference,\n            'serendipity_factor': serendipity_factor\n        }\n        \n        st.session_state.recommendation_engine.update_weights(weights)\n        st.success(\"æ¨è–¦è¨­å®šå·²æ›´æ–°ï¼é‡æ–°è¼‰å…¥é é¢ä»¥æŸ¥çœ‹æ–°çš„æ¨è–¦çµæœã€‚\")\n        \n        # è‡ªå‹•é‡æ–°ç”Ÿæˆæ¨è–¦\n        st.rerun()\n    \n    # é‡ç½®ç‚ºé è¨­å€¼\n    if st.button(\"ğŸ”„ é‡ç½®ç‚ºé è¨­å€¼\", use_container_width=True):\n        st.session_state.recommendation_engine.reset_weights()\n        st.success(\"å·²é‡ç½®ç‚ºé è¨­æ¨è–¦è¨­å®šï¼\")\n        st.rerun()\n","size_bytes":17368},"pages/4_âš–ï¸_å ´åœ°æ¯”è¼ƒ.py":{"content":"import streamlit as st\nimport pandas as pd\nimport plotly.express as px\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nfrom utils.data_manager import DataManager\n\nst.set_page_config(\n    page_title=\"å ´åœ°æ¯”è¼ƒ - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"âš–ï¸\",\n    layout=\"wide\"\n)\n\n# è®¤è¯å®ˆå«å·²ç§»é™¤\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nif 'comparison_venues' not in st.session_state:\n    st.session_state.comparison_venues = []\n\nst.title(\"âš–ï¸ å ´åœ°æ¯”è¼ƒåˆ†æ\")\nst.markdown(\"é¸æ“‡å¤šå€‹å ´åœ°é€²è¡Œè©³ç´°æ¯”è¼ƒï¼Œå¹«åŠ©æ‚¨åšå‡ºæœ€ä½³é¸æ“‡\")\n\n# å´é‚Šæ¬„ - å ´åœ°é¸æ“‡\nwith st.sidebar:\n    st.header(\"ğŸŸï¸ é¸æ“‡æ¯”è¼ƒå ´åœ°\")\n    \n    # è¼‰å…¥æ‰€æœ‰å ´åœ°\n    venues_data = st.session_state.data_manager.get_all_venues()\n    \n    if venues_data is not None and not venues_data.empty:\n        venue_options = {}\n        for _, venue in venues_data.iterrows():\n            venue_name = venue.get('name', 'æœªçŸ¥å ´åœ°')\n            sport_type = venue.get('sport_type', 'æœªçŸ¥é‹å‹•')\n            district = venue.get('district', 'æœªçŸ¥åœ°å€')\n            venue_options[f\"{venue_name} ({sport_type} - {district})\"] = venue.get('id')\n        \n        # å¤šé¸å ´åœ°\n        selected_venues = st.multiselect(\n            \"é¸æ“‡è¦æ¯”è¼ƒçš„å ´åœ°ï¼ˆæœ€å¤š5å€‹ï¼‰\",\n            options=list(venue_options.keys()),\n            default=[],\n            max_selections=5,\n            key=\"venue_multiselect\"\n        )\n        \n        if selected_venues:\n            # æ›´æ–°æ¯”è¼ƒåˆ—è¡¨\n            selected_ids = [venue_options[venue] for venue in selected_venues]\n            st.session_state.comparison_venues = selected_ids\n            \n            st.success(f\"å·²é¸æ“‡ {len(selected_venues)} å€‹å ´åœ°é€²è¡Œæ¯”è¼ƒ\")\n            \n            # å¿«é€Ÿæ“ä½œæŒ‰éˆ•\n            if st.button(\"ğŸ”„ æ¸…ç©ºé¸æ“‡\", use_container_width=True):\n                st.session_state.comparison_venues = []\n                st.rerun()\n        else:\n            st.info(\"è«‹è‡³å°‘é¸æ“‡2å€‹å ´åœ°é€²è¡Œæ¯”è¼ƒ\")\n    else:\n        st.error(\"ç„¡æ³•è¼‰å…¥å ´åœ°è³‡æ–™\")\n\n# ä¸»è¦å…§å®¹\nif len(st.session_state.comparison_venues) >= 2:\n    # ç²å–æ¯”è¼ƒå ´åœ°çš„è©³ç´°è³‡æ–™\n    comparison_data = []\n    \n    for venue_id in st.session_state.comparison_venues:\n        venue_info = st.session_state.data_manager.get_venue_by_id(venue_id)\n        if venue_info is not None:\n            comparison_data.append(venue_info)\n    \n    if comparison_data:\n        tab1, tab2, tab3, tab4 = st.tabs([\"ğŸ“Š åŸºæœ¬æ¯”è¼ƒ\", \"ğŸ’° åƒ¹æ ¼åˆ†æ\", \"â­ è©•åˆ†å°æ¯”\", \"ğŸ“ åœ°ç†åˆ†å¸ƒ\"])\n        \n        with tab1:\n            st.subheader(\"ğŸ“Š åŸºæœ¬è³‡è¨Šæ¯”è¼ƒ\")\n            \n            # å‰µå»ºæ¯”è¼ƒè¡¨æ ¼\n            comparison_df = pd.DataFrame(comparison_data)\n            \n            # åŸºæœ¬è³‡è¨Šè¡¨æ ¼\n            basic_info_columns = ['name', 'sport_type', 'district', 'address', 'contact_phone', 'price_per_hour', 'rating']\n            available_columns = [col for col in basic_info_columns if col in comparison_df.columns]\n            \n            if available_columns:\n                display_df = comparison_df[available_columns].copy()\n                \n                # é‡æ–°å‘½ååˆ—\n                column_mapping = {\n                    'name': 'å ´åœ°åç¨±',\n                    'sport_type': 'é‹å‹•é¡å‹',\n                    'district': 'åœ°å€',\n                    'address': 'åœ°å€',\n                    'contact_phone': 'é›»è©±',\n                    'price_per_hour': 'æ¯å°æ™‚è²»ç”¨(NT$)',\n                    'rating': 'è©•åˆ†'\n                }\n                \n                display_df = display_df.rename(columns=column_mapping)\n                \n                # è½‰ç½®è¡¨æ ¼ä»¥ä¾¿æ¯”è¼ƒ\n                display_df_transposed = display_df.T\n                display_df_transposed.columns = [f\"å ´åœ° {i+1}\" for i in range(len(comparison_data))]\n                \n                st.dataframe(display_df_transposed, use_container_width=True)\n            \n            # è¨­æ–½æ¯”è¼ƒ\n            st.subheader(\"ğŸ¢ è¨­æ–½æ¯”è¼ƒ\")\n            \n            facilities_comparison = {}\n            for i, venue in enumerate(comparison_data):\n                venue_name = venue.get('name', f'å ´åœ° {i+1}')\n                facilities = venue.get('facilities', '')\n                \n                if isinstance(facilities, str) and facilities:\n                    facility_list = [f.strip() for f in facilities.split(',')]\n                elif isinstance(facilities, list):\n                    facility_list = facilities\n                else:\n                    facility_list = []\n                \n                facilities_comparison[venue_name] = facility_list\n            \n            if facilities_comparison:\n                # å‰µå»ºè¨­æ–½å°æ¯”è¡¨\n                all_facilities = set()\n                for facilities in facilities_comparison.values():\n                    all_facilities.update(facilities)\n                \n                if all_facilities:\n                    facility_matrix = []\n                    for facility in sorted(all_facilities):\n                        row = {'è¨­æ–½': facility}\n                        for venue_name, facilities in facilities_comparison.items():\n                            row[venue_name] = 'âœ…' if facility in facilities else 'âŒ'\n                        facility_matrix.append(row)\n                    \n                    facility_df = pd.DataFrame(facility_matrix)\n                    st.dataframe(facility_df, use_container_width=True)\n                else:\n                    st.info(\"æš«ç„¡è¨­æ–½è³‡è¨Šå¯æ¯”è¼ƒ\")\n            \n        with tab2:\n            st.subheader(\"ğŸ’° åƒ¹æ ¼åˆ†æ\")\n            \n            # åƒ¹æ ¼æ¯”è¼ƒåœ–è¡¨\n            price_data = []\n            for venue in comparison_data:\n                price_data.append({\n                    'å ´åœ°': venue.get('name', 'æœªçŸ¥å ´åœ°'),\n                    'æ¯å°æ™‚è²»ç”¨': venue.get('price_per_hour', 0)\n                })\n            \n            price_df = pd.DataFrame(price_data)\n            \n            if not price_df['æ¯å°æ™‚è²»ç”¨'].isna().all():\n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    # æŸ±ç‹€åœ–\n                    fig_bar = px.bar(\n                        price_df, \n                        x='å ´åœ°', \n                        y='æ¯å°æ™‚è²»ç”¨',\n                        title=\"å„å ´åœ°åƒ¹æ ¼æ¯”è¼ƒ\",\n                        color='æ¯å°æ™‚è²»ç”¨',\n                        color_continuous_scale='viridis'\n                    )\n                    fig_bar.update_layout(height=400)\n                    st.plotly_chart(fig_bar, use_container_width=True)\n                \n                with col2:\n                    # åœ“é¤…åœ–\n                    fig_pie = px.pie(\n                        price_df, \n                        values='æ¯å°æ™‚è²»ç”¨', \n                        names='å ´åœ°',\n                        title=\"åƒ¹æ ¼åˆ†å¸ƒæ¯”ä¾‹\"\n                    )\n                    fig_pie.update_layout(height=400)\n                    st.plotly_chart(fig_pie, use_container_width=True)\n                \n                # åƒ¹æ ¼çµ±è¨ˆ\n                st.subheader(\"ğŸ’µ åƒ¹æ ¼çµ±è¨ˆ\")\n                col1, col2, col3, col4 = st.columns(4)\n                \n                prices = price_df['æ¯å°æ™‚è²»ç”¨'].dropna()\n                if not prices.empty:\n                    with col1:\n                        st.metric(\"æœ€é«˜åƒ¹æ ¼\", f\"NT${prices.max():,.0f}\")\n                    with col2:\n                        st.metric(\"æœ€ä½åƒ¹æ ¼\", f\"NT${prices.min():,.0f}\")\n                    with col3:\n                        st.metric(\"å¹³å‡åƒ¹æ ¼\", f\"NT${prices.mean():,.0f}\")\n                    with col4:\n                        st.metric(\"åƒ¹æ ¼å·®è·\", f\"NT${prices.max() - prices.min():,.0f}\")\n            else:\n                st.info(\"æš«ç„¡åƒ¹æ ¼è³‡è¨Šå¯æ¯”è¼ƒ\")\n        \n        with tab3:\n            st.subheader(\"â­ è©•åˆ†å°æ¯”\")\n            \n            # è©•åˆ†æ¯”è¼ƒ\n            rating_data = []\n            for venue in comparison_data:\n                rating = venue.get('rating', 0)\n                if rating and rating > 0:\n                    rating_data.append({\n                        'å ´åœ°': venue.get('name', 'æœªçŸ¥å ´åœ°'),\n                        'è©•åˆ†': rating\n                    })\n            \n            if rating_data:\n                rating_df = pd.DataFrame(rating_data)\n                \n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    # é›·é”åœ–\n                    fig_radar = go.Figure()\n                    \n                    for _, row in rating_df.iterrows():\n                        fig_radar.add_trace(go.Scatterpolar(\n                            r=[row['è©•åˆ†'], row['è©•åˆ†'], row['è©•åˆ†'], row['è©•åˆ†'], row['è©•åˆ†']],\n                            theta=['æ•´é«”æ»¿æ„åº¦', 'è¨­æ–½å“è³ª', 'æœå‹™æ…‹åº¦', 'ç’°å¢ƒæ•´æ½”', 'åƒ¹æ ¼åˆç†'],\n                            fill='toself',\n                            name=row['å ´åœ°']\n                        ))\n                    \n                    fig_radar.update_layout(\n                        polar=dict(\n                            radialaxis=dict(\n                                visible=True,\n                                range=[0, 5]\n                            )),\n                        showlegend=True,\n                        title=\"è©•åˆ†é›·é”åœ–æ¯”è¼ƒ\",\n                        height=500\n                    )\n                    st.plotly_chart(fig_radar, use_container_width=True)\n                \n                with col2:\n                    # è©•åˆ†æŸ±ç‹€åœ–\n                    fig_rating = px.bar(\n                        rating_df, \n                        x='å ´åœ°', \n                        y='è©•åˆ†',\n                        title=\"å ´åœ°è©•åˆ†æ¯”è¼ƒ\",\n                        color='è©•åˆ†',\n                        color_continuous_scale='RdYlGn',\n                        range_color=[0, 5]\n                    )\n                    fig_rating.update_layout(height=500)\n                    fig_rating.add_hline(y=rating_df['è©•åˆ†'].mean(), \n                                        line_dash=\"dash\", \n                                        annotation_text=\"å¹³å‡è©•åˆ†\")\n                    st.plotly_chart(fig_rating, use_container_width=True)\n                \n                # è©•åˆ†çµ±è¨ˆ\n                st.subheader(\"ğŸ“Š è©•åˆ†çµ±è¨ˆ\")\n                col1, col2, col3, col4 = st.columns(4)\n                \n                ratings = rating_df['è©•åˆ†']\n                with col1:\n                    st.metric(\"æœ€é«˜è©•åˆ†\", f\"{ratings.max():.1f}/5.0\")\n                with col2:\n                    st.metric(\"æœ€ä½è©•åˆ†\", f\"{ratings.min():.1f}/5.0\")\n                with col3:\n                    st.metric(\"å¹³å‡è©•åˆ†\", f\"{ratings.mean():.1f}/5.0\")\n                with col4:\n                    best_venue = rating_df.loc[rating_df['è©•åˆ†'].idxmax(), 'å ´åœ°']\n                    st.metric(\"æœ€ä½³å ´åœ°\", best_venue)\n            else:\n                st.info(\"æš«ç„¡è©•åˆ†è³‡è¨Šå¯æ¯”è¼ƒ\")\n        \n        with tab4:\n            st.subheader(\"ğŸ“ åœ°ç†åˆ†å¸ƒ\")\n            \n            # åœ°å€åˆ†å¸ƒ\n            district_data = [venue.get('district', 'æœªçŸ¥åœ°å€') for venue in comparison_data]\n            district_counts = pd.Series(district_data).value_counts()\n            \n            col1, col2 = st.columns(2)\n            \n            with col1:\n                # åœ°å€åˆ†å¸ƒåœ“é¤…åœ–\n                fig_district = px.pie(\n                    values=district_counts.values, \n                    names=district_counts.index,\n                    title=\"å ´åœ°åœ°å€åˆ†å¸ƒ\"\n                )\n                st.plotly_chart(fig_district, use_container_width=True)\n            \n            with col2:\n                # åœ°å€åˆ—è¡¨\n                st.subheader(\"ğŸª å„åœ°å€å ´åœ°\")\n                for district, count in district_counts.items():\n                    st.write(f\"**{district}**: {count} å€‹å ´åœ°\")\n                    venues_in_district = [venue.get('name', 'æœªçŸ¥å ´åœ°') \n                                        for venue in comparison_data \n                                        if venue.get('district') == district]\n                    for venue_name in venues_in_district:\n                        st.write(f\"  â€¢ {venue_name}\")\n        \n        # ç¶œåˆæ¨è–¦\n        st.markdown(\"---\")\n        st.subheader(\"ğŸ† ç¶œåˆåˆ†ææ¨è–¦\")\n        \n        # è¨ˆç®—ç¶œåˆåˆ†æ•¸\n        recommendation_scores = []\n        for venue in comparison_data:\n            score = 0\n            factors = []\n            \n            # è©•åˆ†å› å­ (40%)\n            rating = venue.get('rating', 3.0)\n            if rating:\n                rating_score = rating / 5.0 * 0.4\n                score += rating_score\n                factors.append(f\"è©•åˆ†: {rating:.1f}/5.0\")\n            \n            # åƒ¹æ ¼å› å­ (30%) - åƒ¹æ ¼è¶Šä½åˆ†æ•¸è¶Šé«˜\n            price = venue.get('price_per_hour', 500)\n            if price:\n                # å‡è¨­æœ€é«˜åˆç†åƒ¹æ ¼ç‚º1000ï¼Œåƒ¹æ ¼è¶Šä½åˆ†æ•¸è¶Šé«˜\n                price_score = max(0, (1000 - price) / 1000) * 0.3\n                score += price_score\n                factors.append(f\"æ¯å°æ™‚ NT${price:,.0f}\")\n            \n            # è¨­æ–½å› å­ (20%)\n            facilities = venue.get('facilities', '')\n            if facilities:\n                facility_count = len(facilities.split(',')) if isinstance(facilities, str) else len(facilities)\n                facility_score = min(facility_count / 10, 1.0) * 0.2  # å‡è¨­10å€‹è¨­æ–½ç‚ºæ»¿åˆ†\n                score += facility_score\n                factors.append(f\"{facility_count} é …è¨­æ–½\")\n            \n            # åœ°ç†ä½ç½®å› å­ (10%)\n            district = venue.get('district', '')\n            popular_districts = ['å¤§å®‰å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€']  # ç†±é–€åœ°å€\n            if district in popular_districts:\n                score += 0.1\n                factors.append(f\"ä½æ–¼ç†±é–€åœ°å€ ({district})\")\n            else:\n                factors.append(f\"ä½æ–¼ {district}\")\n            \n            recommendation_scores.append({\n                'å ´åœ°': venue.get('name', 'æœªçŸ¥å ´åœ°'),\n                'ç¶œåˆåˆ†æ•¸': score * 100,  # è½‰æ›ç‚ºç™¾åˆ†åˆ¶\n                'æ¨è–¦å› å­': ' â€¢ '.join(factors)\n            })\n        \n        # æ’åºä¸¦é¡¯ç¤ºæ¨è–¦\n        recommendation_df = pd.DataFrame(recommendation_scores)\n        recommendation_df = recommendation_df.sort_values('ç¶œåˆåˆ†æ•¸', ascending=False)\n        \n        for i, (_, venue) in enumerate(recommendation_df.iterrows()):\n            if i == 0:\n                st.success(f\"ğŸ¥‡ **æœ€æ¨è–¦**: {venue['å ´åœ°']} (ç¶œåˆåˆ†æ•¸: {venue['ç¶œåˆåˆ†æ•¸']:.1f})\")\n            elif i == 1:\n                st.info(f\"ğŸ¥ˆ **æ¬¡æ¨è–¦**: {venue['å ´åœ°']} (ç¶œåˆåˆ†æ•¸: {venue['ç¶œåˆåˆ†æ•¸']:.1f})\")\n            elif i == 2:\n                st.warning(f\"ğŸ¥‰ **ç¬¬ä¸‰æ¨è–¦**: {venue['å ´åœ°']} (ç¶œåˆåˆ†æ•¸: {venue['ç¶œåˆåˆ†æ•¸']:.1f})\")\n            else:\n                st.write(f\"**{i+1}.** {venue['å ´åœ°']} (ç¶œåˆåˆ†æ•¸: {venue['ç¶œåˆåˆ†æ•¸']:.1f})\")\n            \n            st.write(f\"   {venue['æ¨è–¦å› å­']}\")\n            st.write(\"\")\n\nelse:\n    # æç¤ºç”¨æˆ¶é¸æ“‡å ´åœ°\n    st.info(\"è«‹åœ¨å´é‚Šæ¬„é¸æ“‡è‡³å°‘2å€‹å ´åœ°é€²è¡Œæ¯”è¼ƒ\")\n    \n    # é¡¯ç¤ºå¿«é€Ÿé¸æ“‡é¸é …\n    if venues_data is not None and not venues_data.empty:\n        st.subheader(\"ğŸš€ å¿«é€Ÿé¸æ“‡\")\n        \n        col1, col2, col3 = st.columns(3)\n        \n        with col1:\n            if st.button(\"ğŸ€ æ¯”è¼ƒç±ƒçƒå ´åœ°\", use_container_width=True):\n                basketball_venues = venues_data[venues_data['sport_type'] == 'ç±ƒçƒ'].head(3)\n                if not basketball_venues.empty:\n                    st.session_state.comparison_venues = basketball_venues['id'].tolist()\n                    st.rerun()\n        \n        with col2:\n            if st.button(\"ğŸŠâ€â™€ï¸ æ¯”è¼ƒæ¸¸æ³³å ´åœ°\", use_container_width=True):\n                swimming_venues = venues_data[venues_data['sport_type'] == 'æ¸¸æ³³'].head(3)\n                if not swimming_venues.empty:\n                    st.session_state.comparison_venues = swimming_venues['id'].tolist()\n                    st.rerun()\n        \n        with col3:\n            if st.button(\"ğŸƒâ€â™‚ï¸ æ¯”è¼ƒç¶œåˆå ´åœ°\", use_container_width=True):\n                mixed_venues = venues_data[venues_data['sport_type'].isin(['ç¶œåˆé‹å‹•', 'å¥èº«', 'å¤šåŠŸèƒ½'])].head(3)\n                if not mixed_venues.empty:\n                    st.session_state.comparison_venues = mixed_venues['id'].tolist()\n                    st.rerun()\n        \n        # é¡¯ç¤ºå ´åœ°é è¦½\n        st.subheader(\"ğŸŸï¸ å¯æ¯”è¼ƒå ´åœ°é è¦½\")\n        \n        preview_venues = venues_data.head(6)  # é¡¯ç¤ºå‰6å€‹å ´åœ°ä½œç‚ºé è¦½\n        \n        for i in range(0, len(preview_venues), 3):\n            cols = st.columns(3)\n            for j, (_, venue) in enumerate(preview_venues.iloc[i:i+3].iterrows()):\n                with cols[j]:\n                    st.markdown(f\"**{venue.get('name', 'æœªçŸ¥å ´åœ°')}**\")\n                    st.markdown(f\"ğŸƒâ€â™‚ï¸ {venue.get('sport_type', 'æœªçŸ¥é‹å‹•')}\")\n                    st.markdown(f\"ğŸ“ {venue.get('district', 'æœªçŸ¥åœ°å€')}\")\n                    if venue.get('rating'):\n                        st.markdown(f\"â­ {venue.get('rating'):.1f}/5.0\")\n                    if venue.get('price_per_hour'):\n                        st.markdown(f\"ğŸ’° NT${venue.get('price_per_hour'):,.0f}/å°æ™‚\")\n\n# å°å‡ºåŠŸèƒ½\nif len(st.session_state.comparison_venues) >= 2 and comparison_data:\n    st.markdown(\"---\")\n    st.subheader(\"ğŸ“¤ å°å‡ºæ¯”è¼ƒçµæœ\")\n    \n    col1, col2 = st.columns(2)\n    \n    with col1:\n        if st.button(\"ğŸ“Š ç”Ÿæˆæ¯”è¼ƒå ±å‘Š\", use_container_width=True):\n            # ç”Ÿæˆæ¯”è¼ƒå ±å‘Šçš„CSV\n            comparison_df = pd.DataFrame(comparison_data)\n            csv_data = comparison_df.to_csv(index=False, encoding='utf-8-sig')\n            \n            st.download_button(\n                label=\"ä¸‹è¼‰æ¯”è¼ƒå ±å‘Š (CSV)\",\n                data=csv_data,\n                file_name=f\"venue_comparison_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.csv\",\n                mime=\"text/csv\"\n            )\n    \n    with col2:\n        if st.button(\"ğŸ”— åˆ†äº«æ¯”è¼ƒé€£çµ\", use_container_width=True):\n            # ç”Ÿæˆåˆ†äº«é€£çµï¼ˆé€™è£¡åªæ˜¯ç¤ºä¾‹ï¼Œå¯¦éš›éœ€è¦å¯¦ç¾URLåƒæ•¸åŠŸèƒ½ï¼‰\n            venue_ids = ','.join(map(str, st.session_state.comparison_venues))\n            share_url = f\"?compare={venue_ids}\"\n            st.code(f\"åˆ†äº«é€£çµ: {share_url}\", language=\"text\")\n            st.info(\"è¤‡è£½æ­¤é€£çµå¯ç›´æ¥åˆ†äº«æ‚¨çš„æ¯”è¼ƒçµæœ\")","size_bytes":19006},"pages/4_ğŸ“Š_è³‡æ–™åˆ†æ.py":{"content":"import streamlit as st\nimport pandas as pd\nimport plotly.express as px\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nfrom utils.data_manager import DataManager\n\nst.set_page_config(\n    page_title=\"è³‡æ–™åˆ†æ - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"ğŸ“Š\",\n    layout=\"wide\"\n)\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nst.title(\"ğŸ“Š å ´åœ°è³‡æ–™åˆ†æ\")\nst.markdown(\"æ·±å…¥äº†è§£å°åŒ—å¸‚é‹å‹•å ´åœ°çš„åˆ†å¸ƒã€è¶¨å‹¢å’Œçµ±è¨ˆè³‡è¨Š\")\n\n# å´é‚Šæ¬„æ§åˆ¶\nwith st.sidebar:\n    st.header(\"ğŸ“Š åˆ†æè¨­å®š\")\n    \n    # åˆ†ææ™‚é–“ç¯„åœï¼ˆæ¨¡æ“¬ï¼‰\n    analysis_period = st.selectbox(\n        \"åˆ†ææœŸé–“\",\n        [\"æœ€è¿‘ä¸€é€±\", \"æœ€è¿‘ä¸€å€‹æœˆ\", \"æœ€è¿‘ä¸‰å€‹æœˆ\", \"æœ€è¿‘ä¸€å¹´\", \"å…¨éƒ¨æ™‚é–“\"],\n        index=2,\n        key=\"analysis_period\"\n    )\n    \n    # åˆ†æç¶­åº¦é¸æ“‡\n    analysis_dimensions = st.multiselect(\n        \"åˆ†æç¶­åº¦\",\n        [\"é‹å‹•é¡å‹\", \"åœ°å€åˆ†å¸ƒ\", \"åƒ¹æ ¼åˆ†æ\", \"è©•åˆ†åˆ†æ\", \"è¨­æ–½åˆ†æ\", \"ä½¿ç”¨è¶¨å‹¢\"],\n        default=[\"é‹å‹•é¡å‹\", \"åœ°å€åˆ†å¸ƒ\", \"åƒ¹æ ¼åˆ†æ\"],\n        key=\"analysis_dims\"\n    )\n    \n    # è³‡æ–™è¦–è¦ºåŒ–é¡å‹\n    viz_type = st.selectbox(\n        \"è¦–è¦ºåŒ–é¡å‹\",\n        [\"äº’å‹•å¼åœ–è¡¨\", \"éœæ…‹åœ–è¡¨\", \"å„€è¡¨æ¿æ¨¡å¼\"],\n        key=\"viz_type\"\n    )\n\n# ç²å–å ´åœ°è³‡æ–™\nall_venues = st.session_state.data_manager.get_all_venues()\n\nif all_venues is not None and not all_venues.empty:\n    # ç¸½è¦½çµ±è¨ˆ\n    st.subheader(\"ğŸ“ˆ ç¸½è¦½çµ±è¨ˆ\")\n    \n    overview_col1, overview_col2, overview_col3, overview_col4 = st.columns(4)\n    \n    with overview_col1:\n        total_venues = len(all_venues)\n        st.metric(\"ç¸½å ´åœ°æ•¸\", total_venues)\n    \n    with overview_col2:\n        if 'sport_type' in all_venues.columns:\n            unique_sports = all_venues['sport_type'].nunique()\n            st.metric(\"é‹å‹•é¡å‹æ•¸\", unique_sports)\n        else:\n            st.metric(\"é‹å‹•é¡å‹æ•¸\", \"N/A\")\n    \n    with overview_col3:\n        if 'district' in all_venues.columns:\n            unique_districts = all_venues['district'].nunique()\n            st.metric(\"æœå‹™åœ°å€æ•¸\", unique_districts)\n        else:\n            st.metric(\"æœå‹™åœ°å€æ•¸\", \"N/A\")\n    \n    with overview_col4:\n        if 'price_per_hour' in all_venues.columns:\n            avg_price = all_venues['price_per_hour'].mean()\n            st.metric(\"å¹³å‡åƒ¹æ ¼\", f\"NT${avg_price:.0f}/hr\" if pd.notna(avg_price) else \"N/A\")\n        else:\n            st.metric(\"å¹³å‡åƒ¹æ ¼\", \"N/A\")\n    \n    # åˆ†ææ¨™ç±¤é \n    tab1, tab2, tab3, tab4 = st.tabs([\"ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹åˆ†æ\", \"ğŸ“ åœ°å€åˆ†æ\", \"ğŸ’° åƒ¹æ ¼åˆ†æ\", \"â­ è©•åˆ†èˆ‡å“è³ªåˆ†æ\"])\n    \n    with tab1:\n        if \"é‹å‹•é¡å‹\" in analysis_dimensions and 'sport_type' in all_venues.columns:\n            st.subheader(\"ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹åˆ†å¸ƒåˆ†æ\")\n            \n            # é‹å‹•é¡å‹åˆ†å¸ƒåœ“é¤…åœ–\n            sport_counts = all_venues['sport_type'].value_counts()\n            \n            col1, col2 = st.columns([2, 1])\n            \n            with col1:\n                fig_pie = px.pie(\n                    values=sport_counts.values,\n                    names=sport_counts.index,\n                    title=\"é‹å‹•é¡å‹å ´åœ°æ•¸é‡åˆ†å¸ƒ\",\n                    color_discrete_sequence=px.colors.qualitative.Set3\n                )\n                fig_pie.update_traces(textposition='inside', textinfo='percent+label')\n                st.plotly_chart(fig_pie, use_container_width=True)\n            \n            with col2:\n                st.markdown(\"**ğŸ“Š çµ±è¨ˆè³‡è¨Š:**\")\n                for sport, count in sport_counts.head(10).items():\n                    percentage = (count / total_venues) * 100\n                    st.markdown(f\"â€¢ **{sport}**: {count} å€‹å ´åœ° ({percentage:.1f}%)\")\n            \n            # é‹å‹•é¡å‹èˆ‡åƒ¹æ ¼é—œä¿‚\n            if 'price_per_hour' in all_venues.columns:\n                st.subheader(\"ğŸ’° å„é‹å‹•é¡å‹å¹³å‡åƒ¹æ ¼\")\n                \n                sport_price_avg = all_venues.groupby('sport_type')['price_per_hour'].agg(['mean', 'count']).reset_index()\n                sport_price_avg = sport_price_avg[sport_price_avg['count'] >= 3]  # è‡³å°‘3å€‹å ´åœ°æ‰é¡¯ç¤º\n                \n                fig_price = px.bar(\n                    sport_price_avg,\n                    x='sport_type',\n                    y='mean',\n                    title=\"å„é‹å‹•é¡å‹å¹³å‡åƒ¹æ ¼æ¯”è¼ƒ\",\n                    labels={'mean': 'å¹³å‡åƒ¹æ ¼ (NT$/hr)', 'sport_type': 'é‹å‹•é¡å‹'},\n                    color='mean',\n                    color_continuous_scale='RdYlBu_r'\n                )\n                fig_price.update_layout(xaxis_tickangle=-45)\n                st.plotly_chart(fig_price, use_container_width=True)\n        \n        else:\n            st.info(\"é‹å‹•é¡å‹è³‡æ–™ä¸å¯ç”¨æˆ–æœªé¸æ“‡æ­¤åˆ†æç¶­åº¦\")\n    \n    with tab2:\n        if \"åœ°å€åˆ†å¸ƒ\" in analysis_dimensions and 'district' in all_venues.columns:\n            st.subheader(\"ğŸ“ åœ°å€åˆ†å¸ƒåˆ†æ\")\n            \n            # åœ°å€å ´åœ°æ•¸é‡åˆ†å¸ƒ\n            district_counts = all_venues['district'].value_counts()\n            \n            col1, col2 = st.columns([2, 1])\n            \n            with col1:\n                fig_district = px.bar(\n                    x=district_counts.index,\n                    y=district_counts.values,\n                    title=\"å„åœ°å€å ´åœ°æ•¸é‡åˆ†å¸ƒ\",\n                    labels={'x': 'åœ°å€', 'y': 'å ´åœ°æ•¸é‡'},\n                    color=district_counts.values,\n                    color_continuous_scale='Blues'\n                )\n                fig_district.update_layout(xaxis_tickangle=-45)\n                st.plotly_chart(fig_district, use_container_width=True)\n            \n            with col2:\n                st.markdown(\"**ğŸ“Š åœ°å€æ’è¡Œ:**\")\n                for i, (district, count) in enumerate(district_counts.head(10).items(), 1):\n                    st.markdown(f\"{i}. **{district}**: {count} å€‹å ´åœ°\")\n            \n            # åœ°å€èˆ‡é‹å‹•é¡å‹äº¤å‰åˆ†æ\n            if 'sport_type' in all_venues.columns:\n                st.subheader(\"ğŸ¯ åœ°å€é‹å‹•é¡å‹åˆ†å¸ƒç†±åŠ›åœ–\")\n                \n                # å‰µå»ºäº¤å‰è¡¨\n                cross_tab = pd.crosstab(all_venues['district'], all_venues['sport_type'])\n                \n                # åªé¡¯ç¤ºä¸»è¦åœ°å€å’Œé‹å‹•é¡å‹\n                top_districts = district_counts.head(8).index\n                top_sports = all_venues['sport_type'].value_counts().head(8).index\n                \n                filtered_cross_tab = cross_tab.loc[top_districts, top_sports]\n                \n                fig_heatmap = px.imshow(\n                    filtered_cross_tab.values,\n                    x=filtered_cross_tab.columns,\n                    y=filtered_cross_tab.index,\n                    title=\"åœ°å€ Ã— é‹å‹•é¡å‹åˆ†å¸ƒç†±åŠ›åœ–\",\n                    color_continuous_scale='Blues',\n                    aspect='auto'\n                )\n                fig_heatmap.update_layout(\n                    xaxis_title=\"é‹å‹•é¡å‹\",\n                    yaxis_title=\"åœ°å€\"\n                )\n                st.plotly_chart(fig_heatmap, use_container_width=True)\n        \n        else:\n            st.info(\"åœ°å€è³‡æ–™ä¸å¯ç”¨æˆ–æœªé¸æ“‡æ­¤åˆ†æç¶­åº¦\")\n    \n    with tab3:\n        if \"åƒ¹æ ¼åˆ†æ\" in analysis_dimensions and 'price_per_hour' in all_venues.columns:\n            st.subheader(\"ğŸ’° åƒ¹æ ¼åˆ†å¸ƒåˆ†æ\")\n            \n            # éæ¿¾æœ‰æ•ˆåƒ¹æ ¼è³‡æ–™\n            price_data = all_venues[all_venues['price_per_hour'].notna() & (all_venues['price_per_hour'] > 0)]\n            \n            if not price_data.empty:\n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    # åƒ¹æ ¼åˆ†å¸ƒç›´æ–¹åœ–\n                    fig_hist = px.histogram(\n                        price_data,\n                        x='price_per_hour',\n                        nbins=20,\n                        title=\"å ´åœ°åƒ¹æ ¼åˆ†å¸ƒ\",\n                        labels={'price_per_hour': 'æ¯å°æ™‚åƒ¹æ ¼ (NT$)', 'count': 'å ´åœ°æ•¸é‡'},\n                        color_discrete_sequence=['#1f77b4']\n                    )\n                    st.plotly_chart(fig_hist, use_container_width=True)\n                \n                with col2:\n                    # åƒ¹æ ¼çµ±è¨ˆ\n                    price_stats = price_data['price_per_hour'].describe()\n                    \n                    st.markdown(\"**ğŸ“Š åƒ¹æ ¼çµ±è¨ˆ:**\")\n                    st.markdown(f\"â€¢ **å¹³å‡åƒ¹æ ¼**: NT${price_stats['mean']:.0f}/hr\")\n                    st.markdown(f\"â€¢ **ä¸­ä½æ•¸åƒ¹æ ¼**: NT${price_stats['50%']:.0f}/hr\")\n                    st.markdown(f\"â€¢ **æœ€ä½åƒ¹æ ¼**: NT${price_stats['min']:.0f}/hr\")\n                    st.markdown(f\"â€¢ **æœ€é«˜åƒ¹æ ¼**: NT${price_stats['max']:.0f}/hr\")\n                    st.markdown(f\"â€¢ **æ¨™æº–å·®**: NT${price_stats['std']:.0f}\")\n                \n                # åƒ¹æ ¼å€é–“åˆ†æ\n                st.subheader(\"ğŸ“Š åƒ¹æ ¼å€é–“åˆ†å¸ƒ\")\n                \n                # å®šç¾©åƒ¹æ ¼å€é–“\n                price_bins = [0, 200, 400, 600, 800, 1000, float('inf')]\n                price_labels = ['<200', '200-400', '400-600', '600-800', '800-1000', '>1000']\n                \n                price_data['price_range'] = pd.cut(\n                    price_data['price_per_hour'],\n                    bins=price_bins,\n                    labels=price_labels,\n                    include_lowest=True\n                )\n                \n                price_range_counts = price_data['price_range'].value_counts().sort_index()\n                \n                fig_range = px.bar(\n                    x=price_range_counts.index,\n                    y=price_range_counts.values,\n                    title=\"åƒ¹æ ¼å€é–“å ´åœ°åˆ†å¸ƒ\",\n                    labels={'x': 'åƒ¹æ ¼å€é–“ (NT$/hr)', 'y': 'å ´åœ°æ•¸é‡'},\n                    color=price_range_counts.values,\n                    color_continuous_scale='Greens'\n                )\n                st.plotly_chart(fig_range, use_container_width=True)\n                \n                # åƒ¹æ ¼èˆ‡è©•åˆ†é—œä¿‚\n                if 'rating' in price_data.columns:\n                    st.subheader(\"â­ åƒ¹æ ¼èˆ‡è©•åˆ†é—œä¿‚\")\n                    \n                    rating_data = price_data[price_data['rating'].notna()]\n                    \n                    if not rating_data.empty:\n                        fig_scatter = px.scatter(\n                            rating_data,\n                            x='price_per_hour',\n                            y='rating',\n                            title=\"åƒ¹æ ¼ vs è©•åˆ†æ•£é»åœ–\",\n                            labels={'price_per_hour': 'æ¯å°æ™‚åƒ¹æ ¼ (NT$)', 'rating': 'è©•åˆ†'},\n                            color='sport_type' if 'sport_type' in rating_data.columns else None,\n                            size='rating',\n                            hover_data=['name'] if 'name' in rating_data.columns else None\n                        )\n                        \n                        # æ·»åŠ è¶¨å‹¢ç·š\n                        fig_scatter.add_trace(\n                            go.Scatter(\n                                x=rating_data['price_per_hour'],\n                                y=rating_data['rating'],\n                                mode='lines',\n                                name='è¶¨å‹¢ç·š',\n                                line=dict(dash='dash', color='red')\n                            )\n                        )\n                        \n                        st.plotly_chart(fig_scatter, use_container_width=True)\n            \n            else:\n                st.warning(\"æ²’æœ‰æœ‰æ•ˆçš„åƒ¹æ ¼è³‡æ–™å¯ä¾›åˆ†æ\")\n        \n        else:\n            st.info(\"åƒ¹æ ¼è³‡æ–™ä¸å¯ç”¨æˆ–æœªé¸æ“‡æ­¤åˆ†æç¶­åº¦\")\n    \n    with tab4:\n        if \"è©•åˆ†åˆ†æ\" in analysis_dimensions and 'rating' in all_venues.columns:\n            st.subheader(\"â­ è©•åˆ†èˆ‡å“è³ªåˆ†æ\")\n            \n            # éæ¿¾æœ‰æ•ˆè©•åˆ†è³‡æ–™\n            rating_data = all_venues[all_venues['rating'].notna() & (all_venues['rating'] > 0)]\n            \n            if not rating_data.empty:\n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    # è©•åˆ†åˆ†å¸ƒ\n                    fig_rating_dist = px.histogram(\n                        rating_data,\n                        x='rating',\n                        nbins=20,\n                        title=\"å ´åœ°è©•åˆ†åˆ†å¸ƒ\",\n                        labels={'rating': 'è©•åˆ†', 'count': 'å ´åœ°æ•¸é‡'},\n                        color_discrete_sequence=['#ff7f0e']\n                    )\n                    st.plotly_chart(fig_rating_dist, use_container_width=True)\n                \n                with col2:\n                    # è©•åˆ†çµ±è¨ˆ\n                    rating_stats = rating_data['rating'].describe()\n                    \n                    st.markdown(\"**â­ è©•åˆ†çµ±è¨ˆ:**\")\n                    st.markdown(f\"â€¢ **å¹³å‡è©•åˆ†**: {rating_stats['mean']:.2f}/5.0\")\n                    st.markdown(f\"â€¢ **ä¸­ä½æ•¸è©•åˆ†**: {rating_stats['50%']:.2f}/5.0\")\n                    st.markdown(f\"â€¢ **æœ€ä½è©•åˆ†**: {rating_stats['min']:.2f}/5.0\")\n                    st.markdown(f\"â€¢ **æœ€é«˜è©•åˆ†**: {rating_stats['max']:.2f}/5.0\")\n                    \n                    # è©•åˆ†ç­‰ç´šåˆ†å¸ƒ\n                    excellent = len(rating_data[rating_data['rating'] >= 4.5])\n                    good = len(rating_data[(rating_data['rating'] >= 4.0) & (rating_data['rating'] < 4.5)])\n                    average = len(rating_data[(rating_data['rating'] >= 3.0) & (rating_data['rating'] < 4.0)])\n                    poor = len(rating_data[rating_data['rating'] < 3.0])\n                    \n                    st.markdown(f\"â€¢ **å„ªç§€** (â‰¥4.5): {excellent} å€‹å ´åœ°\")\n                    st.markdown(f\"â€¢ **è‰¯å¥½** (4.0-4.5): {good} å€‹å ´åœ°\")\n                    st.markdown(f\"â€¢ **æ™®é€š** (3.0-4.0): {average} å€‹å ´åœ°\")\n                    st.markdown(f\"â€¢ **éœ€æ”¹å–„** (<3.0): {poor} å€‹å ´åœ°\")\n                \n                # å„é‹å‹•é¡å‹å¹³å‡è©•åˆ†\n                if 'sport_type' in rating_data.columns:\n                    st.subheader(\"ğŸƒâ€â™‚ï¸ å„é‹å‹•é¡å‹å¹³å‡è©•åˆ†\")\n                    \n                    sport_rating_avg = rating_data.groupby('sport_type')['rating'].agg(['mean', 'count']).reset_index()\n                    sport_rating_avg = sport_rating_avg[sport_rating_avg['count'] >= 3]  # è‡³å°‘3å€‹å ´åœ°\n                    sport_rating_avg = sport_rating_avg.sort_values('mean', ascending=False)\n                    \n                    fig_sport_rating = px.bar(\n                        sport_rating_avg,\n                        x='sport_type',\n                        y='mean',\n                        title=\"å„é‹å‹•é¡å‹å¹³å‡è©•åˆ†æ’è¡Œ\",\n                        labels={'mean': 'å¹³å‡è©•åˆ†', 'sport_type': 'é‹å‹•é¡å‹'},\n                        color='mean',\n                        color_continuous_scale='RdYlGn'\n                    )\n                    fig_sport_rating.update_layout(xaxis_tickangle=-45)\n                    st.plotly_chart(fig_sport_rating, use_container_width=True)\n                \n                # å„åœ°å€å¹³å‡è©•åˆ†\n                if 'district' in rating_data.columns:\n                    st.subheader(\"ğŸ“ å„åœ°å€å¹³å‡è©•åˆ†\")\n                    \n                    district_rating_avg = rating_data.groupby('district')['rating'].agg(['mean', 'count']).reset_index()\n                    district_rating_avg = district_rating_avg[district_rating_avg['count'] >= 3]\n                    district_rating_avg = district_rating_avg.sort_values('mean', ascending=False)\n                    \n                    fig_district_rating = px.bar(\n                        district_rating_avg,\n                        x='district',\n                        y='mean',\n                        title=\"å„åœ°å€å¹³å‡è©•åˆ†æ’è¡Œ\",\n                        labels={'mean': 'å¹³å‡è©•åˆ†', 'district': 'åœ°å€'},\n                        color='mean',\n                        color_continuous_scale='RdYlGn'\n                    )\n                    fig_district_rating.update_layout(xaxis_tickangle=-45)\n                    st.plotly_chart(fig_district_rating, use_container_width=True)\n            \n            else:\n                st.warning(\"æ²’æœ‰æœ‰æ•ˆçš„è©•åˆ†è³‡æ–™å¯ä¾›åˆ†æ\")\n        \n        else:\n            st.info(\"è©•åˆ†è³‡æ–™ä¸å¯ç”¨æˆ–æœªé¸æ“‡æ­¤åˆ†æç¶­åº¦\")\n    \n    # é«˜ç´šåˆ†æ\n    st.markdown(\"---\")\n    st.subheader(\"ğŸ”¬ é€²éšåˆ†æ\")\n    \n    advanced_col1, advanced_col2 = st.columns(2)\n    \n    with advanced_col1:\n        # ç›¸é—œæ€§åˆ†æ\n        if 'price_per_hour' in all_venues.columns and 'rating' in all_venues.columns:\n            st.markdown(\"**ğŸ“Š è®Šæ•¸ç›¸é—œæ€§åˆ†æ**\")\n            \n            numeric_columns = ['price_per_hour', 'rating']\n            available_numeric = [col for col in numeric_columns if col in all_venues.columns]\n            \n            if len(available_numeric) >= 2:\n                correlation_data = all_venues[available_numeric].corr()\n                \n                fig_corr = px.imshow(\n                    correlation_data.values,\n                    x=correlation_data.columns,\n                    y=correlation_data.index,\n                    title=\"è®Šæ•¸ç›¸é—œæ€§ç†±åŠ›åœ–\",\n                    color_continuous_scale='RdBu_r',\n                    zmin=-1, zmax=1\n                )\n                \n                # æ·»åŠ æ•¸å€¼æ¨™ç±¤\n                for i in range(len(correlation_data.columns)):\n                    for j in range(len(correlation_data.index)):\n                        fig_corr.add_annotation(\n                            x=correlation_data.columns[i],\n                            y=correlation_data.index[j],\n                            text=f\"{correlation_data.iloc[j, i]:.2f}\",\n                            showarrow=False,\n                            font_color=\"white\" if abs(correlation_data.iloc[j, i]) > 0.5 else \"black\"\n                        )\n                \n                st.plotly_chart(fig_corr, use_container_width=True)\n    \n    with advanced_col2:\n        # è³‡æ–™å“è³ªå ±å‘Š\n        st.markdown(\"**ğŸ“‹ è³‡æ–™å“è³ªå ±å‘Š**\")\n        \n        total_records = len(all_venues)\n        quality_report = {}\n        \n        for column in all_venues.columns:\n            non_null_count = all_venues[column].notna().sum()\n            completeness = (non_null_count / total_records) * 100\n            quality_report[column] = completeness\n        \n        # é¡¯ç¤ºè³‡æ–™å®Œæ•´æ€§\n        quality_df = pd.DataFrame(list(quality_report.items()), columns=['æ¬„ä½', 'å®Œæ•´æ€§(%)'])\n        quality_df = quality_df.sort_values('å®Œæ•´æ€§(%)', ascending=False)\n        \n        st.dataframe(quality_df, use_container_width=True)\n        \n        # è³‡æ–™å“è³ªæ‘˜è¦\n        avg_completeness = quality_df['å®Œæ•´æ€§(%)'].mean()\n        \n        if avg_completeness >= 90:\n            quality_status = \"ğŸŸ¢ å„ªç§€\"\n        elif avg_completeness >= 70:\n            quality_status = \"ğŸŸ¡ è‰¯å¥½\"\n        else:\n            quality_status = \"ğŸ”´ éœ€è¦æ”¹å–„\"\n        \n        st.metric(\"æ•´é«”è³‡æ–™å“è³ª\", f\"{avg_completeness:.1f}%\", delta=quality_status)\n\nelse:\n    st.error(\"ç„¡æ³•è¼‰å…¥å ´åœ°è³‡æ–™é€²è¡Œåˆ†æã€‚è«‹æª¢æŸ¥è³‡æ–™ä¾†æºæˆ–ç¨å¾Œå†è©¦ã€‚\")\n    \n    st.markdown(\"\"\"\n    ### ğŸ“Š åˆ†æåŠŸèƒ½èªªæ˜\n    \n    ç•¶è³‡æ–™å¯ç”¨æ™‚ï¼Œæ­¤é é¢å°‡æä¾›ï¼š\n    \n    - **ğŸƒâ€â™‚ï¸ é‹å‹•é¡å‹åˆ†æ**: å„é¡é‹å‹•å ´åœ°çš„åˆ†å¸ƒå’Œåƒ¹æ ¼æ¯”è¼ƒ\n    - **ğŸ“ åœ°å€åˆ†æ**: å°åŒ—å„åœ°å€å ´åœ°å¯†åº¦å’Œé¡å‹åˆ†å¸ƒ\n    - **ğŸ’° åƒ¹æ ¼åˆ†æ**: åƒ¹æ ¼åˆ†å¸ƒã€å€é–“åˆ†æå’Œåƒ¹æ ¼èˆ‡å“è³ªé—œä¿‚\n    - **â­ è©•åˆ†åˆ†æ**: å ´åœ°å“è³ªè©•ä¼°å’Œå„ç¶­åº¦è¡¨ç¾\n    - **ğŸ”¬ é€²éšåˆ†æ**: è®Šæ•¸ç›¸é—œæ€§å’Œè³‡æ–™å“è³ªå ±å‘Š\n    \"\"\")\n","size_bytes":20096},"pages/5_ğŸ¢_å ´åœ°è©³æƒ….py":{"content":"import streamlit as st\nimport pandas as pd\nfrom utils.data_manager import DataManager\nfrom datetime import datetime, timedelta, date, time\n\nst.set_page_config(\n    page_title=\"å ´åœ°è©³æƒ… - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"ğŸ¢\",\n    layout=\"wide\"\n)\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nst.title(\"ğŸ¢ å ´åœ°è©³ç´°è³‡è¨Š\")\n\n# å¾ URL åƒæ•¸æˆ–é¸æ“‡å™¨ç²å–å ´åœ° ID\nvenue_id = st.query_params.get(\"id\", None)\n\nif venue_id is None:\n    # å¦‚æœæ²’æœ‰æŒ‡å®šå ´åœ°IDï¼Œé¡¯ç¤ºé¸æ“‡å™¨\n    all_venues = st.session_state.data_manager.get_all_venues()\n    \n    if all_venues is not None and not all_venues.empty:\n        st.subheader(\"è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å ´åœ°\")\n        \n        venue_options = {}\n        for _, venue in all_venues.iterrows():\n            label = f\"{venue['name']} - {venue['district']}\"\n            venue_options[label] = venue['id']\n        \n        selected_venue = st.selectbox(\"é¸æ“‡å ´åœ°\", list(venue_options.keys()))\n        \n        if selected_venue:\n            venue_id = venue_options[selected_venue]\n    else:\n        st.error(\"æ²’æœ‰å¯ç”¨çš„å ´åœ°è³‡æ–™\")\n        st.stop()\n\nif venue_id:\n    try:\n        venue_id = int(venue_id)\n        \n        # ç²å–å ´åœ°è©³ç´°è³‡è¨Š\n        venue_info = st.session_state.data_manager.get_venue_by_id(venue_id)\n        \n        if venue_info is None:\n            st.error(\"æ‰¾ä¸åˆ°æŒ‡å®šçš„å ´åœ°\")\n            st.stop()\n        \n        # å ´åœ°åŸºæœ¬è³‡è¨Š\n        col1, col2 = st.columns([2, 1])\n        \n        with col1:\n            st.header(venue_info['name'])\n            st.markdown(f\"**åœ°å€:** {venue_info['address']}\")\n            st.markdown(f\"**åœ°å€:** {venue_info['district']}\")\n            st.markdown(f\"**é‹å‹•é¡å‹:** {venue_info['sport_type']}\")\n            \n            if venue_info['description']:\n                st.markdown(\"**å ´åœ°ä»‹ç´¹:**\")\n                st.write(venue_info['description'])\n        \n        with col2:\n            # åƒ¹æ ¼å’Œè©•åˆ†è³‡è¨Š\n            st.metric(\"æ™‚ç§Ÿåƒ¹æ ¼\", f\"NT${venue_info['price_per_hour']:.0f}/å°æ™‚\")\n            \n            # ä½¿ç”¨è¨ˆç®—å¾Œçš„å¹³å‡è©•åˆ†\n            avg_rating = venue_info.get('avg_rating', venue_info.get('rating', 0))\n            if avg_rating and avg_rating > 0:\n                st.metric(\"å¹³å‡è©•åˆ†\", f\"{float(avg_rating):.1f}/5.0\")\n            \n            review_count = venue_info.get('review_count', 0)\n            st.metric(\"è©•è«–æ•¸é‡\", f\"{review_count} å‰‡\")\n        \n        # è¨­æ–½è³‡è¨Š\n        if venue_info['facilities']:\n            st.subheader(\"ğŸƒâ€â™‚ï¸ è¨­æ–½è³‡è¨Š\")\n            # è™•ç† PostgreSQL æ•¸çµ„æ ¼å¼\n            facilities = venue_info['facilities']\n            if isinstance(facilities, str):\n                # å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå˜—è©¦è§£æç‚ºåˆ—è¡¨\n                facilities = facilities.strip('{}').split(',')\n                facilities = [f.strip().strip('\"') for f in facilities]\n            \n            facility_cols = st.columns(min(len(facilities), 4))\n            for i, facility in enumerate(facilities):\n                with facility_cols[i % 4]:\n                    st.info(f\"âœ“ {facility}\")\n        \n        # è¯çµ¡è³‡è¨Š\n        st.subheader(\"ğŸ“ è¯çµ¡è³‡è¨Š\")\n        contact_col1, contact_col2 = st.columns(2)\n        \n        with contact_col1:\n            if venue_info['contact_phone']:\n                st.markdown(f\"**é›»è©±:** {venue_info['contact_phone']}\")\n            if venue_info['opening_hours']:\n                st.markdown(f\"**ç‡Ÿæ¥­æ™‚é–“:** {venue_info['opening_hours']}\")\n        \n        with contact_col2:\n            if venue_info['website']:\n                st.markdown(f\"**ç¶²ç«™:** [å®˜æ–¹ç¶²ç«™]({venue_info['website']})\")\n            if venue_info['latitude'] and venue_info['longitude']:\n                st.markdown(f\"**åº§æ¨™:** {venue_info['latitude']:.4f}, {venue_info['longitude']:.4f}\")\n        \n        # åˆ†é æ¨™ç±¤\n        tab1, tab2, tab3 = st.tabs([\"ğŸ’¬ ç”¨æˆ¶è©•è«–\", \"ğŸ“… ç«‹å³é è¨‚\", \"ğŸ“ åœ°åœ–ä½ç½®\"])\n        \n        with tab1:\n            # ç”¨æˆ¶è©•è«–å€åŸŸ\n            st.subheader(\"ç”¨æˆ¶è©•è«–\")\n            \n            # ç²å–å·²å¯©æ ¸çš„è©•è«–\n            reviews = st.session_state.data_manager.get_venue_reviews(venue_id)\n            \n            if reviews:\n                for review in reviews:\n                    with st.container():\n                        col1, col2 = st.columns([3, 1])\n                        with col1:\n                            st.write(f\"**{review['user_name']}**\")\n                            st.write(review['comment'])\n                        with col2:\n                            st.metric(\"è©•åˆ†\", f\"{review['rating']}/5\")\n                            st.caption(f\"{review['created_at']}\")\n                        st.divider()\n            else:\n                st.info(\"æš«ç„¡è©•è«–ï¼Œæˆç‚ºç¬¬ä¸€å€‹è©•è«–çš„ç”¨æˆ¶å§ï¼\")\n            \n            # æ·»åŠ æ–°è©•è«–\n            st.subheader(\"ç™¼è¡¨è©•è«–\")\n            with st.form(\"review_form\"):\n                user_name = st.text_input(\"æ‚¨çš„å§“å\", placeholder=\"è«‹è¼¸å…¥æ‚¨çš„å§“å\")\n                rating = st.slider(\"è©•åˆ†\", 1, 5, 5)\n                comment = st.text_area(\"è©•è«–å…§å®¹\", placeholder=\"åˆ†äº«æ‚¨å°é€™å€‹å ´åœ°çš„é«”é©—...\")\n                \n                if st.form_submit_button(\"æäº¤è©•è«–\"):\n                    if user_name and comment:\n                        success = st.session_state.data_manager.add_review(\n                            venue_id, user_name, rating, comment\n                        )\n                        if success:\n                            st.success(\"è©•è«–å·²æäº¤ï¼å¯©æ ¸é€šéå¾Œå°‡é¡¯ç¤ºåœ¨è©•è«–å€åŸŸã€‚\")\n                            st.rerun()\n                        else:\n                            st.error(\"æäº¤è©•è«–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\")\n                    else:\n                        st.error(\"è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚\")\n        \n        with tab2:\n            # é è¨‚åŠŸèƒ½\n            st.subheader(\"å ´åœ°é è¨‚\")\n            \n            with st.form(\"booking_form\"):\n                col1, col2 = st.columns(2)\n                \n                with col1:\n                    user_name = st.text_input(\"é è¨‚äººå§“å\", placeholder=\"è«‹è¼¸å…¥æ‚¨çš„å§“å\")\n                    user_email = st.text_input(\"é›»å­éƒµä»¶\", placeholder=\"ç”¨æ–¼ç¢ºèªé è¨‚\")\n                    user_phone = st.text_input(\"è¯çµ¡é›»è©±\", placeholder=\"ç·Šæ€¥è¯çµ¡ç”¨\")\n                \n                with col2:\n                    booking_date = st.date_input(\"é è¨‚æ—¥æœŸ\", min_value=date.today())\n                    \n                    # æ™‚é–“é¸æ“‡\n                    time_col1, time_col2 = st.columns(2)\n                    with time_col1:\n                        start_time = st.time_input(\"é–‹å§‹æ™‚é–“\", value=time(9, 0))\n                    with time_col2:\n                        end_time = st.time_input(\"çµæŸæ™‚é–“\", value=time(10, 0))\n                \n                special_requests = st.text_area(\"ç‰¹æ®Šéœ€æ±‚\", placeholder=\"å…¶ä»–éœ€è¦èªªæ˜çš„äº‹é …...\")\n                \n                if st.form_submit_button(\"æª¢æŸ¥å¯ç”¨æ€§ä¸¦é è¨‚\"):\n                    if user_name and user_email and user_phone:\n                        # æª¢æŸ¥æ™‚é–“é‚è¼¯\n                        if start_time >= end_time:\n                            st.error(\"çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼\")\n                        else:\n                            # æª¢æŸ¥å¯ç”¨æ€§\n                            is_available = st.session_state.data_manager.check_availability(\n                                venue_id, str(booking_date), str(start_time), str(end_time)\n                            )\n                            \n                            if is_available:\n                                # å‰µå»ºé è¨‚\n                                booking_id = st.session_state.data_manager.create_booking(\n                                    venue_id, user_name, user_email, user_phone,\n                                    str(booking_date), str(start_time), str(end_time),\n                                    special_requests\n                                )\n                                \n                                if booking_id:\n                                    st.success(f\"é è¨‚æˆåŠŸï¼é è¨‚ç·¨è™Ÿï¼š{booking_id}\")\n                                    st.info(\"æˆ‘å€‘å°‡é€éé›»å­éƒµä»¶ç¢ºèªæ‚¨çš„é è¨‚è©³æƒ…ã€‚\")\n                                else:\n                                    st.error(\"é è¨‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\")\n                            else:\n                                st.warning(\"è©²æ™‚æ®µå·²è¢«é è¨‚ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ã€‚\")\n                    else:\n                        st.error(\"è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚\")\n        \n        with tab3:\n            # åœ°åœ–é¡¯ç¤º\n            st.subheader(\"åœ°åœ–ä½ç½®\")\n            \n            if venue_info['latitude'] and venue_info['longitude']:\n                # å‰µå»ºåœ°åœ–æ•¸æ“š\n                map_data = pd.DataFrame({\n                    'lat': [float(venue_info['latitude'])],\n                    'lon': [float(venue_info['longitude'])],\n                    'size': [20],\n                    'name': [venue_info['name']]\n                })\n                \n                st.map(map_data, zoom=14)\n                \n                # æä¾› Google Maps é€£çµ\n                google_maps_url = f\"https://www.google.com/maps/search/?api=1&query={venue_info['latitude']},{venue_info['longitude']}\"\n                st.markdown(f\"[åœ¨ Google Maps ä¸­æŸ¥çœ‹]({google_maps_url})\")\n            else:\n                st.warning(\"è©²å ´åœ°æš«ç„¡åœ°ç†ä½ç½®è³‡è¨Š\")\n        \n    except ValueError:\n        st.error(\"ç„¡æ•ˆçš„å ´åœ°ID\")\n    except Exception as e:\n        st.error(f\"è¼‰å…¥å ´åœ°è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}\")\nelse:\n    st.warning(\"è«‹é¸æ“‡è¦æŸ¥çœ‹çš„å ´åœ°\")","size_bytes":9982},"pages/6_ğŸ‘¨â€ğŸ’¼_è©•è«–ç®¡ç†.py":{"content":"import streamlit as st\nimport pandas as pd\nfrom utils.data_manager import DataManager\n\nst.set_page_config(\n    page_title=\"è©•è«–ç®¡ç† - å°åŒ—é‹å‹•å ´åœ°æœå°‹å¼•æ“\",\n    page_icon=\"ğŸ‘¨â€ğŸ’¼\",\n    layout=\"wide\"\n)\n\n# ç¢ºä¿ session state å·²åˆå§‹åŒ–\nif 'data_manager' not in st.session_state:\n    st.session_state.data_manager = DataManager()\n\nst.title(\"ğŸ‘¨â€ğŸ’¼ è©•è«–ç®¡ç†ç³»çµ±\")\nst.markdown(\"ç®¡ç†å’Œå¯©æ ¸ç”¨æˆ¶æäº¤çš„å ´åœ°è©•è«–\")\n\n# ç®¡ç†å“¡å¯†ç¢¼ä¿è­·\nif 'admin_authenticated' not in st.session_state:\n    st.session_state.admin_authenticated = False\n\nif not st.session_state.admin_authenticated:\n    st.subheader(\"ğŸ” ç®¡ç†å“¡ç™»å…¥\")\n    \n    with st.form(\"admin_login\"):\n        admin_password = st.text_input(\"ç®¡ç†å“¡å¯†ç¢¼\", type=\"password\", placeholder=\"è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼\")\n        \n        if st.form_submit_button(\"ç™»å…¥\"):\n            # ä½¿ç”¨ç’°å¢ƒè®Šæ•¸è¨­å®šç®¡ç†å“¡å¯†ç¢¼\n            import os\n            admin_secret = os.getenv(\"ADMIN_PASSWORD\", \"replit_admin_2024\")\n            \n            if admin_password == admin_secret:\n                st.session_state.admin_authenticated = True\n                st.success(\"ç™»å…¥æˆåŠŸï¼\")\n                st.rerun()\n            else:\n                st.error(\"å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚\")\n    \n    st.info(\"ğŸ’¡ è«‹è¯ç¹«ç®¡ç†å“¡å–å¾—ç™»å…¥å¯†ç¢¼\")\n    st.stop()\n\n# ç®¡ç†å“¡ä»‹é¢\ntab1, tab2, tab3 = st.tabs([\"â³ å¾…å¯©æ ¸è©•è«–\", \"âœ… å·²å¯©æ ¸è©•è«–\", \"ğŸ“Š è©•è«–çµ±è¨ˆ\"])\n\nwith tab1:\n    st.subheader(\"å¾…å¯©æ ¸è©•è«–\")\n    \n    try:\n        # ç²å–æ‰€æœ‰å¾…å¯©æ ¸çš„è©•è«–\n        if hasattr(st.session_state.data_manager, 'engine') and st.session_state.data_manager.engine:\n            query = \"\"\"\n            SELECT r.id, r.venue_id, v.name as venue_name, r.user_name, \n                   r.rating, r.comment, r.created_at\n            FROM reviews r\n            JOIN venues v ON r.venue_id = v.id\n            WHERE r.status = 'pending'\n            ORDER BY r.created_at DESC\n            \"\"\"\n            \n            pending_reviews = pd.read_sql(query, st.session_state.data_manager.engine)\n            \n            if not pending_reviews.empty:\n                st.info(f\"å…±æœ‰ {len(pending_reviews)} å‰‡å¾…å¯©æ ¸è©•è«–\")\n                \n                for idx, review in pending_reviews.iterrows():\n                    with st.container():\n                        col1, col2, col3 = st.columns([3, 1, 1])\n                        \n                        with col1:\n                            st.markdown(f\"**å ´åœ°:** {review['venue_name']}\")\n                            st.markdown(f\"**ç”¨æˆ¶:** {review['user_name']}\")\n                            st.markdown(f\"**è©•åˆ†:** {'â­' * review['rating']} ({review['rating']}/5)\")\n                            st.markdown(f\"**è©•è«–:** {review['comment']}\")\n                            st.caption(f\"æäº¤æ™‚é–“: {review['created_at']}\")\n                        \n                        with col2:\n                            if st.button(f\"âœ… æ‰¹å‡†\", key=f\"approve_{review['id']}\"):\n                                # æ‰¹å‡†è©•è«–\n                                try:\n                                    with st.session_state.data_manager.engine.connect() as conn:\n                                        from sqlalchemy import text\n                                        update_query = text(\"\"\"\n                                        UPDATE reviews \n                                        SET status = 'approved', updated_at = NOW()\n                                        WHERE id = :review_id\n                                        \"\"\")\n                                        conn.execute(update_query, {'review_id': review['id']})\n                                        conn.commit()\n                                    \n                                    st.success(f\"è©•è«– #{review['id']} å·²æ‰¹å‡†ï¼\")\n                                    st.rerun()\n                                except Exception as e:\n                                    st.error(f\"æ‰¹å‡†è©•è«–å¤±æ•—: {e}\")\n                        \n                        with col3:\n                            if st.button(f\"âŒ æ‹’çµ•\", key=f\"reject_{review['id']}\"):\n                                # æ‹’çµ•è©•è«–\n                                try:\n                                    with st.session_state.data_manager.engine.connect() as conn:\n                                        from sqlalchemy import text\n                                        update_query = text(\"\"\"\n                                        UPDATE reviews \n                                        SET status = 'rejected', updated_at = NOW()\n                                        WHERE id = :review_id\n                                        \"\"\")\n                                        conn.execute(update_query, {'review_id': review['id']})\n                                        conn.commit()\n                                    \n                                    st.warning(f\"è©•è«– #{review['id']} å·²æ‹’çµ•ï¼\")\n                                    st.rerun()\n                                except Exception as e:\n                                    st.error(f\"æ‹’çµ•è©•è«–å¤±æ•—: {e}\")\n                        \n                        st.divider()\n            else:\n                st.success(\"ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è©•è«–ï¼\")\n        else:\n            st.error(\"ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«\")\n            \n    except Exception as e:\n        st.error(f\"è¼‰å…¥å¾…å¯©æ ¸è©•è«–æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n\nwith tab2:\n    st.subheader(\"å·²å¯©æ ¸è©•è«–\")\n    \n    try:\n        if hasattr(st.session_state.data_manager, 'engine') and st.session_state.data_manager.engine:\n            # ç‹€æ…‹ç¯©é¸\n            status_filter = st.selectbox(\n                \"ç¯©é¸ç‹€æ…‹\",\n                [\"approved\", \"rejected\"],\n                format_func=lambda x: \"å·²æ‰¹å‡†\" if x == \"approved\" else \"å·²æ‹’çµ•\"\n            )\n            \n            query = \"\"\"\n            SELECT r.id, r.venue_id, v.name as venue_name, r.user_name, \n                   r.rating, r.comment, r.status, r.created_at, r.updated_at\n            FROM reviews r\n            JOIN venues v ON r.venue_id = v.id\n            WHERE r.status = %s\n            ORDER BY r.updated_at DESC\n            LIMIT 50\n            \"\"\"\n            \n            reviewed_comments = pd.read_sql(query, st.session_state.data_manager.engine, params=[status_filter])\n            \n            if not reviewed_comments.empty:\n                st.info(f\"é¡¯ç¤ºæœ€è¿‘ {len(reviewed_comments)} å‰‡{('å·²æ‰¹å‡†' if status_filter == 'approved' else 'å·²æ‹’çµ•')}è©•è«–\")\n                \n                for idx, review in reviewed_comments.iterrows():\n                    with st.container():\n                        col1, col2 = st.columns([4, 1])\n                        \n                        with col1:\n                            st.markdown(f\"**å ´åœ°:** {review['venue_name']}\")\n                            st.markdown(f\"**ç”¨æˆ¶:** {review['user_name']}\")\n                            st.markdown(f\"**è©•åˆ†:** {'â­' * review['rating']} ({review['rating']}/5)\")\n                            st.markdown(f\"**è©•è«–:** {review['comment']}\")\n                            st.caption(f\"æäº¤: {review['created_at']} | å¯©æ ¸: {review['updated_at']}\")\n                        \n                        with col2:\n                            status_color = \"ğŸŸ¢\" if review['status'] == 'approved' else \"ğŸ”´\"\n                            status_text = \"å·²æ‰¹å‡†\" if review['status'] == 'approved' else \"å·²æ‹’çµ•\"\n                            st.markdown(f\"{status_color} **{status_text}**\")\n                            st.caption(f\"ID: {review['id']}\")\n                        \n                        st.divider()\n            else:\n                st.info(f\"æ²’æœ‰{('å·²æ‰¹å‡†' if status_filter == 'approved' else 'å·²æ‹’çµ•')}çš„è©•è«–\")\n        else:\n            st.error(\"ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«\")\n            \n    except Exception as e:\n        st.error(f\"è¼‰å…¥å·²å¯©æ ¸è©•è«–æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n\nwith tab3:\n    st.subheader(\"è©•è«–çµ±è¨ˆ\")\n    \n    try:\n        if hasattr(st.session_state.data_manager, 'engine') and st.session_state.data_manager.engine:\n            # åŸºæœ¬çµ±è¨ˆ\n            stats_query = \"\"\"\n            SELECT \n                COUNT(*) as total_reviews,\n                COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_count,\n                COUNT(CASE WHEN status = 'approved' THEN 1 END) as approved_count,\n                COUNT(CASE WHEN status = 'rejected' THEN 1 END) as rejected_count,\n                ROUND(AVG(rating), 2) as avg_rating\n            FROM reviews\n            \"\"\"\n            \n            stats = pd.read_sql(stats_query, st.session_state.data_manager.engine)\n            \n            if not stats.empty:\n                stat_row = stats.iloc[0]\n                \n                col1, col2, col3, col4, col5 = st.columns(5)\n                \n                with col1:\n                    st.metric(\"ç¸½è©•è«–æ•¸\", int(stat_row['total_reviews']))\n                \n                with col2:\n                    st.metric(\"å¾…å¯©æ ¸\", int(stat_row['pending_count']))\n                \n                with col3:\n                    st.metric(\"å·²æ‰¹å‡†\", int(stat_row['approved_count']))\n                \n                with col4:\n                    st.metric(\"å·²æ‹’çµ•\", int(stat_row['rejected_count']))\n                \n                with col5:\n                    avg_rating = stat_row['avg_rating']\n                    st.metric(\"å¹³å‡è©•åˆ†\", f\"{avg_rating}/5.0\" if avg_rating else \"N/A\")\n            \n            # å ´åœ°è©•è«–çµ±è¨ˆ\n            st.subheader(\"å„å ´åœ°è©•è«–çµ±è¨ˆ\")\n            \n            venue_stats_query = \"\"\"\n            SELECT v.name, v.district,\n                   COUNT(r.id) as review_count,\n                   COUNT(CASE WHEN r.status = 'approved' THEN 1 END) as approved_reviews,\n                   ROUND(AVG(CASE WHEN r.status = 'approved' THEN r.rating END), 2) as avg_approved_rating\n            FROM venues v\n            LEFT JOIN reviews r ON v.id = r.venue_id\n            GROUP BY v.id, v.name, v.district\n            ORDER BY review_count DESC\n            \"\"\"\n            \n            venue_stats = pd.read_sql(venue_stats_query, st.session_state.data_manager.engine)\n            \n            if not venue_stats.empty:\n                st.dataframe(\n                    venue_stats.rename(columns={\n                        'name': 'å ´åœ°åç¨±',\n                        'district': 'åœ°å€',\n                        'review_count': 'ç¸½è©•è«–æ•¸',\n                        'approved_reviews': 'å·²æ‰¹å‡†è©•è«–',\n                        'avg_approved_rating': 'å¹³å‡è©•åˆ†'\n                    }),\n                    use_container_width=True\n                )\n            else:\n                st.info(\"æš«ç„¡å ´åœ°è©•è«–çµ±è¨ˆè³‡æ–™\")\n        else:\n            st.error(\"ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«\")\n            \n    except Exception as e:\n        st.error(f\"è¼‰å…¥è©•è«–çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n\n# å¿«é€Ÿæ“ä½œ\nst.markdown(\"---\")\nst.subheader(\"ğŸš€ å¿«é€Ÿæ“ä½œ\")\n\ncol1, col2 = st.columns(2)\n\nwith col1:\n    if st.button(\"ğŸ”„ é‡æ–°è¼‰å…¥æ•¸æ“š\", use_container_width=True):\n        st.rerun()\n\nwith col2:\n    if st.button(\"ğŸšª ç™»å‡º\", use_container_width=True):\n        st.session_state.admin_authenticated = False\n        st.rerun()","size_bytes":11407},"utils/data_manager.py":{"content":"import pandas as pd\nimport numpy as np\nimport os\nfrom typing import List, Optional, Dict, Any\nimport random\nimport streamlit as st\n\n@st.cache_data\ndef load_venues_data():\n    \"\"\"\n    ä½¿ç”¨ç¼“å­˜è½½å…¥åœºåœ°æ•°æ®ï¼Œé¿å…é‡å¤è¯»å–\n    \"\"\"\n    try:\n        # è®€å–CSVæª”æ¡ˆ\n        csv_path = \"attached_assets/finding move - main (1)_1757915289189.csv\"\n        \n        if not os.path.exists(csv_path):\n            print(f\"CSVæª”æ¡ˆä¸å­˜åœ¨: {csv_path}\")\n            return pd.DataFrame()\n        \n        # è®€å–CSVï¼Œè·³éå‰é¢çš„æ¨™é¡Œè¡Œ\n        raw_data = pd.read_csv(csv_path, encoding='utf-8', skiprows=5)\n        \n        # æ¸…ç†æ¬„ä½åç¨±\n        raw_data.columns = [\n            'name', 'district', 'price_range', 'sport_type', 'opening_hours',\n            'facilities', 'venue_scale', 'courses', 'other', 'website',\n            'address', 'contact_phone', 'photos'\n        ]\n        \n        # éæ¿¾æ‰ç©ºçš„å ´åœ°åç¨±\n        raw_data = raw_data.dropna(subset=['name'])\n        raw_data = raw_data[raw_data['name'].str.strip() != '']\n        \n        # å»ºç«‹æ¨™æº–åŒ–çš„è³‡æ–™çµæ§‹\n        venues_list = []\n        \n        for idx, row in raw_data.iterrows():\n            venue = {\n                'id': idx + 1,\n                'name': str(row['name']).strip() if pd.notna(row['name']) else '',\n                'district': str(row['district']).strip() if pd.notna(row['district']) else '',\n                'address': str(row['address']).strip() if pd.notna(row['address']) else '',\n                'sport_type': DataManager._normalize_sport_type_static(row['sport_type']),\n                'price_per_hour': DataManager._extract_price_static(row['price_range']),\n                'rating': round(random.uniform(3.5, 5.0), 1),  # æ¨¡æ“¬è©•åˆ†\n                'facilities': DataManager._normalize_facilities_static(row['facilities']),\n                'description': str(row['other']).strip() if pd.notna(row['other']) else '',\n                'contact_phone': str(row['contact_phone']).strip() if pd.notna(row['contact_phone']) else '',\n                'opening_hours': str(row['opening_hours']).strip() if pd.notna(row['opening_hours']) else '',\n                'website': str(row['website']).strip() if pd.notna(row['website']) else '',\n                'venue_scale': str(row['venue_scale']).strip() if pd.notna(row['venue_scale']) else '',\n                'courses': str(row['courses']).strip() if pd.notna(row['courses']) else '',\n                'photos': str(row['photos']).strip() if pd.notna(row['photos']) else '',\n                'latitude': DataManager._get_district_coordinates_static(row['district'])[0],\n                'longitude': DataManager._get_district_coordinates_static(row['district'])[1]\n            }\n            venues_list.append(venue)\n        \n        # è½‰æ›ç‚ºDataFrame\n        venues_data = pd.DataFrame(venues_list)\n        print(f\"âœ… æˆåŠŸè¼‰å…¥ {len(venues_data)} ç­†å ´åœ°è³‡æ–™\")\n        return venues_data\n        \n    except Exception as e:\n        print(f\"âŒ è¼‰å…¥å ´åœ°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n        return pd.DataFrame()\n\nclass DataManager:\n    \"\"\"\n    è³‡æ–™ç®¡ç†é¡åˆ¥ï¼Œè² è²¬è™•ç†å ´åœ°è³‡æ–™çš„è¼‰å…¥ã€ç¯©é¸å’Œæœå°‹åŠŸèƒ½\n    å¾CSVæª”æ¡ˆè®€å–å°åŒ—é‹å‹•å ´åœ°è³‡æ–™ï¼Œä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½\n    \"\"\"\n    \n    def __init__(self):\n        # ä½¿ç”¨ç¼“å­˜å‡½æ•°è½½å…¥æ•°æ®\n        self.venues_data = load_venues_data()\n        self.sport_types = []\n        self.districts = []\n        self.facilities = []\n        self._extract_metadata()\n    \n    @staticmethod\n    def _normalize_sport_type_static(sport_type):\n        \"\"\"æ ‡å‡†åŒ–è¿åŠ¨ç±»å‹ - é™æ€æ–¹æ³•\"\"\"\n        if pd.isna(sport_type) or sport_type == '':\n            return 'ç¶œåˆé‹å‹•'\n        \n        sport_type = str(sport_type).strip()\n        sport_mapping = {\n            'ç¾½çƒ': 'ç¾½æ¯›çƒ', 'ç¾½æ¯›çƒ': 'ç¾½æ¯›çƒ', 'æ¸¸æ³³': 'æ¸¸æ³³',\n            'å¥èº«': 'å¥èº«', 'é‡è¨“': 'å¥èº«', 'æœ‰æ°§': 'æœ‰æ°§é‹å‹•',\n            'ç‘œçˆ': 'ç‘œä¼½', 'ç‘œä¼½': 'ç‘œä¼½', 'çƒé¡': 'çƒé¡é‹å‹•',\n            'ç±ƒçƒ': 'ç±ƒçƒ', 'è¶³çƒ': 'è¶³çƒ', 'ç¶²çƒ': 'ç¶²çƒ',\n            'æ¡Œçƒ': 'æ¡Œçƒ', 'æ’çƒ': 'æ’çƒ', 'æ’çƒ': 'æ’çƒ',\n            'æˆ¶å¤–é‹å‹•': 'æˆ¶å¤–é‹å‹•'\n        }\n        \n        for key, value in sport_mapping.items():\n            if key in sport_type:\n                return value\n        return sport_type if sport_type else 'ç¶œåˆé‹å‹•'\n    \n    @staticmethod\n    def _extract_price_static(price_range):\n        \"\"\"ä»ä»·æ ¼åŒºé—´æå–å¹³å‡ä»·æ ¼ - é™æ€æ–¹æ³•\"\"\"\n        if pd.isna(price_range) or price_range == '':\n            return random.randint(100, 500)\n        \n        price_str = str(price_range).strip()\n        if '0-200' in price_str:\n            return 150\n        elif '200-500' in price_str:\n            return 350\n        elif '500ä»¥ä¸Š' in price_str:\n            return 700\n        else:\n            return random.randint(200, 400)\n    \n    @staticmethod\n    def _normalize_facilities_static(facilities):\n        \"\"\"æ ‡å‡†åŒ–è®¾æ–½ä¿¡æ¯ - é™æ€æ–¹æ³•\"\"\"\n        if pd.isna(facilities) or facilities == '':\n            return 'åŸºæœ¬è¨­æ–½'\n        \n        facilities_str = str(facilities).strip()\n        facility_mapping = {\n            'æ·‹æµ´é–“': 'æ·‹æµ´é–“', 'ç½®ç‰©æ«ƒ': 'ç½®ç‰©æ«ƒ', 'åœè»Šå ´': 'åœè»Šå ´',\n            'Wi-Fi': 'Wi-Fi', 'WiFi': 'Wi-Fi', 'ç„¡éšœç¤™è¨­æ–½': 'ç„¡éšœç¤™è¨­æ–½',\n            'æ€§åˆ¥å‹å–„è¨­æ–½': 'æ€§åˆ¥å‹å–„è¨­æ–½', 'å¯µç‰©å‹å–„': 'å¯µç‰©å‹å–„', 'å¥³æ€§å°ˆç”¨': 'å¥³æ€§å°ˆç”¨'\n        }\n        \n        normalized_facilities = []\n        for key, value in facility_mapping.items():\n            if key in facilities_str:\n                normalized_facilities.append(value)\n        \n        return '/'.join(normalized_facilities) if normalized_facilities else facilities_str\n    \n    @staticmethod\n    def _get_district_coordinates_static(district):\n        \"\"\"å–å¾—åœ°åŒºåæ ‡ - é™æ€æ–¹æ³•\"\"\"\n        district_coords = {\n            'å£«æ—å€': (25.0881, 121.5256), 'å¤§å®‰å€': (25.0266, 121.5484),\n            'ä¸­å±±å€': (25.0633, 121.5267), 'å¤§åŒå€': (25.0633, 121.5154),\n            'ä¸­æ­£å€': (25.0364, 121.5161), 'ä¿¡ç¾©å€': (25.0336, 121.5751),\n            'è¬è¯å€': (25.0327, 121.5060), 'æ–‡å±±å€': (24.9906, 121.5420),\n            'æ¾å±±å€': (25.0501, 121.5776), 'å…§æ¹–å€': (25.0838, 121.5948),\n            'å—æ¸¯å€': (25.0415, 121.6073), 'åŒ—æŠ•å€': (25.1372, 121.5018)\n        }\n        return district_coords.get(str(district).strip(), (25.0478, 121.5319))\n    \n    def _extract_metadata(self):\n        \"\"\"ä»è½½å…¥çš„æ•°æ®ä¸­æå–å…ƒæ•°æ®\"\"\"\n        if self.venues_data is not None and not self.venues_data.empty:\n            # è¿åŠ¨ç±»å‹\n            if 'sport_type' in self.venues_data.columns:\n                self.sport_types = sorted(self.venues_data['sport_type'].dropna().unique().tolist())\n            \n            # åœ°åŒº\n            if 'district' in self.venues_data.columns:\n                self.districts = sorted(self.venues_data['district'].dropna().unique().tolist())\n            \n            # è®¾æ–½\n            if 'facilities' in self.venues_data.columns:\n                all_facilities = []\n                for facilities_str in self.venues_data['facilities'].dropna():\n                    if '/' in str(facilities_str):\n                        all_facilities.extend(str(facilities_str).split('/'))\n                    else:\n                        all_facilities.append(str(facilities_str))\n                self.facilities = sorted(list(set([f.strip() for f in all_facilities if f.strip()])))\n    \n    def _load_data(self):\n        \"\"\"\n        å¾CSVæª”æ¡ˆè¼‰å…¥å ´åœ°è³‡æ–™\n        \"\"\"\n        try:\n            # è®€å–CSVæª”æ¡ˆ\n            csv_path = \"attached_assets/finding move - main (1)_1757915289189.csv\"\n            \n            if not os.path.exists(csv_path):\n                print(f\"CSVæª”æ¡ˆä¸å­˜åœ¨: {csv_path}\")\n                self._create_empty_dataframe()\n                return\n            \n            # è®€å–CSVï¼Œè·³éå‰é¢çš„æ¨™é¡Œè¡Œ\n            raw_data = pd.read_csv(csv_path, encoding='utf-8', skiprows=5)\n            \n            # æ¸…ç†æ¬„ä½åç¨±\n            raw_data.columns = [\n                'name', 'district', 'price_range', 'sport_type', 'opening_hours',\n                'facilities', 'venue_scale', 'courses', 'other', 'website',\n                'address', 'contact_phone', 'photos'\n            ]\n            \n            # éæ¿¾æ‰ç©ºçš„å ´åœ°åç¨±\n            raw_data = raw_data.dropna(subset=['name'])\n            raw_data = raw_data[raw_data['name'].str.strip() != '']\n            \n            # å»ºç«‹æ¨™æº–åŒ–çš„è³‡æ–™çµæ§‹\n            venues_list = []\n            \n            for idx, row in raw_data.iterrows():\n                venue = {\n                    'id': idx + 1,\n                    'name': str(row['name']).strip() if pd.notna(row['name']) else '',\n                    'district': str(row['district']).strip() if pd.notna(row['district']) else '',\n                    'address': str(row['address']).strip() if pd.notna(row['address']) else '',\n                    'sport_type': self._normalize_sport_type(row['sport_type']),\n                    'price_per_hour': self._extract_price(row['price_range']),\n                    'rating': round(random.uniform(3.5, 5.0), 1),  # æ¨¡æ“¬è©•åˆ†\n                    'facilities': self._normalize_facilities(row['facilities']),\n                    'description': str(row['other']).strip() if pd.notna(row['other']) else '',\n                    'contact_phone': str(row['contact_phone']).strip() if pd.notna(row['contact_phone']) else '',\n                    'opening_hours': str(row['opening_hours']).strip() if pd.notna(row['opening_hours']) else '',\n                    'website': str(row['website']).strip() if pd.notna(row['website']) else '',\n                    'venue_scale': str(row['venue_scale']).strip() if pd.notna(row['venue_scale']) else '',\n                    'courses': str(row['courses']).strip() if pd.notna(row['courses']) else '',\n                    'photos': str(row['photos']).strip() if pd.notna(row['photos']) else '',\n                    'latitude': self._get_district_coordinates(row['district'])[0],\n                    'longitude': self._get_district_coordinates(row['district'])[1]\n                }\n                venues_list.append(venue)\n            \n            # è½‰æ›ç‚ºDataFrame\n            self.venues_data = pd.DataFrame(venues_list)\n            \n            # æ›´æ–°å¯ç”¨é¸é …\n            self._update_available_options()\n            \n            print(f\"æˆåŠŸè¼‰å…¥ {len(self.venues_data)} ç­†å ´åœ°è³‡æ–™\")\n            \n        except Exception as e:\n            print(f\"è¼‰å…¥CSVè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            self._create_empty_dataframe()\n    \n    def _create_empty_dataframe(self):\n        \"\"\"å»ºç«‹ç©ºçš„DataFrameä½œç‚ºå¾Œå‚™\"\"\"\n        column_names = [\n            'id', 'name', 'address', 'district', 'sport_type',\n            'price_per_hour', 'rating', 'facilities', 'description',\n            'contact_phone', 'opening_hours', 'website',\n            'latitude', 'longitude', 'venue_scale', 'courses', 'photos'\n        ]\n        self.venues_data = pd.DataFrame(columns=column_names)\n        self._update_available_options()\n    \n    def _normalize_sport_type(self, sport_type):\n        \"\"\"æ¨™æº–åŒ–é‹å‹•é¡å‹\"\"\"\n        if pd.isna(sport_type) or sport_type == '':\n            return 'ç¶œåˆé‹å‹•'\n        \n        sport_type = str(sport_type).strip()\n        \n        # é‹å‹•é¡å‹å°æ‡‰è¡¨\n        sport_mapping = {\n            'ç¾½çƒ': 'ç¾½æ¯›çƒ',\n            'ç¾½æ¯›çƒ': 'ç¾½æ¯›çƒ',\n            'æ¸¸æ³³': 'æ¸¸æ³³',\n            'å¥èº«': 'å¥èº«',\n            'é‡è¨“': 'å¥èº«',\n            'æœ‰æ°§': 'æœ‰æ°§é‹å‹•',\n            'ç‘œçˆ': 'ç‘œä¼½',\n            'ç‘œä¼½': 'ç‘œä¼½',\n            'çƒé¡': 'çƒé¡é‹å‹•',\n            'ç±ƒçƒ': 'ç±ƒçƒ',\n            'è¶³çƒ': 'è¶³çƒ',\n            'ç¶²çƒ': 'ç¶²çƒ',\n            'æ¡Œçƒ': 'æ¡Œçƒ',\n            'æ’çƒ': 'æ’çƒ',\n            'æ’çƒ': 'æ’çƒ',\n            'æˆ¶å¤–é‹å‹•': 'æˆ¶å¤–é‹å‹•'\n        }\n        \n        # æª¢æŸ¥åŒ…å«çš„é‹å‹•é¡å‹\n        for key, value in sport_mapping.items():\n            if key in sport_type:\n                return value\n        \n        # å¦‚æœåŒ…å«å¤šç¨®é‹å‹•ï¼Œè¿”å›ç¬¬ä¸€å€‹è­˜åˆ¥åˆ°çš„\n        if '/' in sport_type:\n            types = sport_type.split('/')\n            for t in types:\n                t = t.strip()\n                for key, value in sport_mapping.items():\n                    if key in t:\n                        return value\n        \n        return sport_type if sport_type else 'ç¶œåˆé‹å‹•'\n    \n    def _extract_price(self, price_range):\n        \"\"\"å¾åƒ¹æ ¼å€é–“æå–å¹³å‡åƒ¹æ ¼\"\"\"\n        if pd.isna(price_range) or price_range == '':\n            return random.randint(100, 500)  # é è¨­åƒ¹æ ¼ç¯„åœ\n        \n        price_str = str(price_range).strip()\n        \n        if '0-200' in price_str:\n            return 150\n        elif '200-500' in price_str:\n            return 350\n        elif '500ä»¥ä¸Š' in price_str:\n            return 700\n        else:\n            return random.randint(200, 400)\n    \n    def _normalize_facilities(self, facilities):\n        \"\"\"æ¨™æº–åŒ–è¨­æ–½è³‡è¨Š\"\"\"\n        if pd.isna(facilities) or facilities == '':\n            return 'åŸºæœ¬è¨­æ–½'\n        \n        facilities_str = str(facilities).strip()\n        \n        # æ¨™æº–åŒ–è¨­æ–½åç¨±\n        facility_mapping = {\n            'æ·‹æµ´é–“': 'æ·‹æµ´é–“',\n            'ç½®ç‰©æ«ƒ': 'ç½®ç‰©æ«ƒ',\n            'åœè»Šå ´': 'åœè»Šå ´',\n            'Wi-Fi': 'Wi-Fi',\n            'WiFi': 'Wi-Fi',\n            'ç„¡éšœç¤™è¨­æ–½': 'ç„¡éšœç¤™è¨­æ–½',\n            'æ€§åˆ¥å‹å–„è¨­æ–½': 'æ€§åˆ¥å‹å–„è¨­æ–½',\n            'å¯µç‰©å‹å–„': 'å¯µç‰©å‹å–„',\n            'å¥³æ€§å°ˆç”¨': 'å¥³æ€§å°ˆç”¨'\n        }\n        \n        normalized_facilities = []\n        for key, value in facility_mapping.items():\n            if key in facilities_str:\n                normalized_facilities.append(value)\n        \n        return '/'.join(normalized_facilities) if normalized_facilities else facilities_str\n    \n    def _get_district_coordinates(self, district):\n        \"\"\"å–å¾—åœ°å€çš„åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)\"\"\"\n        district_coords = {\n            'å£«æ—å€': (25.0881, 121.5256),\n            'å¤§å®‰å€': (25.0266, 121.5484),\n            'ä¸­å±±å€': (25.0633, 121.5267),\n            'å¤§åŒå€': (25.0633, 121.5154),\n            'ä¸­æ­£å€': (25.0364, 121.5161),\n            'ä¿¡ç¾©å€': (25.0336, 121.5751),\n            'è¬è¯å€': (25.0327, 121.5060),\n            'æ–‡å±±å€': (24.9906, 121.5420),\n            'æ¾å±±å€': (25.0501, 121.5776),\n            'å…§æ¹–å€': (25.0838, 121.5948),\n            'å—æ¸¯å€': (25.0415, 121.6073),\n            'åŒ—æŠ•å€': (25.1372, 121.5018)\n        }\n        \n        return district_coords.get(str(district).strip(), (25.0478, 121.5319))  # é è¨­å°åŒ—å¸‚ä¸­å¿ƒ\n    \n    def _update_available_options(self):\n        \"\"\"æ›´æ–°å¯ç”¨çš„é‹å‹•é¡å‹ã€åœ°å€å’Œè¨­æ–½åˆ—è¡¨\"\"\"\n        if self.venues_data is not None and not self.venues_data.empty:\n            # é‹å‹•é¡å‹\n            if 'sport_type' in self.venues_data.columns:\n                self.sport_types = sorted(self.venues_data['sport_type'].dropna().unique().tolist())\n            \n            # åœ°å€\n            if 'district' in self.venues_data.columns:\n                self.districts = sorted(self.venues_data['district'].dropna().unique().tolist())\n            \n            # è¨­æ–½\n            if 'facilities' in self.venues_data.columns:\n                all_facilities = []\n                for facilities in self.venues_data['facilities'].dropna():\n                    if isinstance(facilities, str) and facilities.strip():\n                        all_facilities.extend([f.strip() for f in facilities.split('/')])\n                \n                self.facilities = sorted(list(set(all_facilities)))\n        else:\n            # å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œæä¾›ä¸€äº›é è¨­é¸é …\n            self.sport_types = [\n                \"ç±ƒçƒ\", \"è¶³çƒ\", \"ç¶²çƒ\", \"ç¾½æ¯›çƒ\", \"æ¸¸æ³³\", \"å¥èº«\", \n                \"è·‘æ­¥\", \"æ¡Œçƒ\", \"æ’çƒ\", \"æ£’çƒ\", \"ç‘œä¼½\", \"èˆè¹ˆ\"\n            ]\n            self.districts = [\n                \"ä¸­æ­£å€\", \"å¤§åŒå€\", \"ä¸­å±±å€\", \"æ¾å±±å€\", \"å¤§å®‰å€\", \"è¬è¯å€\",\n                \"ä¿¡ç¾©å€\", \"å£«æ—å€\", \"åŒ—æŠ•å€\", \"å…§æ¹–å€\", \"å—æ¸¯å€\", \"æ–‡å±±å€\"\n            ]\n            self.facilities = [\n                \"åœè»Šå ´\", \"æ·‹æµ´é–“\", \"æ›´è¡£å®¤\", \"å†·æ°£\", \"éŸ³éŸ¿è¨­å‚™\", \"å™¨æç§Ÿå€Ÿ\",\n                \"é£²æ°´æ©Ÿ\", \"ä¼‘æ¯å€\", \"ç„¡éšœç¤™è¨­æ–½\", \"Wi-Fi\", \"ç½®ç‰©æ«ƒ\", \"è§€çœ¾å¸­\"\n            ]\n    \n    def get_all_venues(self) -> Optional[pd.DataFrame]:\n        \"\"\"ç²å–æ‰€æœ‰å ´åœ°è³‡æ–™\"\"\"\n        return self.venues_data.copy() if self.venues_data is not None else None\n    \n    def get_sport_types(self) -> List[str]:\n        \"\"\"ç²å–æ‰€æœ‰å¯ç”¨çš„é‹å‹•é¡å‹\"\"\"\n        return self.sport_types.copy()\n    \n    def get_districts(self) -> List[str]:\n        \"\"\"ç²å–æ‰€æœ‰å¯ç”¨çš„åœ°å€\"\"\"\n        return self.districts.copy()\n    \n    def get_facilities(self) -> List[str]:\n        \"\"\"ç²å–æ‰€æœ‰å¯ç”¨çš„è¨­æ–½\"\"\"\n        return self.facilities.copy()\n    \n    def get_venue_stats(self) -> Dict[str, Any]:\n        \"\"\"ç²å–å ´åœ°çµ±è¨ˆè³‡è¨Š\"\"\"\n        if self.venues_data is None or self.venues_data.empty:\n            return {\n                'total_venues': 0,\n                'sport_types': 0,\n                'districts': 0,\n                'avg_price': 0\n            }\n        \n        stats = {\n            'total_venues': len(self.venues_data),\n            'sport_types': len(self.sport_types),\n            'districts': len(self.districts),\n            'avg_price': self.venues_data['price_per_hour'].mean() if 'price_per_hour' in self.venues_data.columns else 0\n        }\n        \n        return stats\n    \n    def search_venues(self, query: str) -> Optional[pd.DataFrame]:\n        \"\"\"\n        æ ¹æ“šé—œéµå­—æœå°‹å ´åœ°\n        \n        Args:\n            query: æœå°‹é—œéµå­—\n            \n        Returns:\n            ç¬¦åˆæœå°‹æ¢ä»¶çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if self.venues_data is None or self.venues_data.empty or not query:\n            return None\n        \n        query = query.lower().strip()\n        \n        # åœ¨å¤šå€‹æ¬„ä½ä¸­æœå°‹\n        search_columns = ['name', 'address', 'district', 'sport_type', 'facilities', 'description']\n        \n        mask = pd.Series([False] * len(self.venues_data))\n        \n        for col in search_columns:\n            if col in self.venues_data.columns:\n                mask |= self.venues_data[col].astype(str).str.lower().str.contains(query, na=False)\n        \n        results = self.venues_data[mask].copy()\n        \n        return results if not results.empty else None\n    \n    def get_filtered_venues(self, \n                          sport_types: Optional[List[str]] = None,\n                          districts: Optional[List[str]] = None,\n                          price_range: Optional[List[float]] = None,\n                          facilities: Optional[List[str]] = None,\n                          min_rating: float = 0.0,\n                          search_query: Optional[str] = None) -> Optional[pd.DataFrame]:\n        \"\"\"\n        æ ¹æ“šå¤šå€‹æ¢ä»¶ç¯©é¸å ´åœ°\n        \n        Args:\n            sport_types: é‹å‹•é¡å‹åˆ—è¡¨\n            districts: åœ°å€åˆ—è¡¨\n            price_range: åƒ¹æ ¼ç¯„åœ [æœ€ä½åƒ¹, æœ€é«˜åƒ¹]\n            facilities: è¨­æ–½éœ€æ±‚åˆ—è¡¨\n            min_rating: æœ€ä½è©•åˆ†è¦æ±‚\n            search_query: æœå°‹é—œéµå­—\n            \n        Returns:\n            ç¬¦åˆç¯©é¸æ¢ä»¶çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if self.venues_data is None or self.venues_data.empty:\n            return None\n        \n        filtered_data = self.venues_data.copy()\n        \n        # é—œéµå­—æœå°‹\n        if search_query:\n            search_results = self.search_venues(search_query)\n            if search_results is not None:\n                filtered_data = search_results\n            else:\n                return None\n        \n        # é‹å‹•é¡å‹ç¯©é¸\n        if sport_types and 'sport_type' in filtered_data.columns:\n            filtered_data = filtered_data[filtered_data['sport_type'].isin(sport_types)]\n        \n        # åœ°å€ç¯©é¸\n        if districts and 'district' in filtered_data.columns:\n            filtered_data = filtered_data[filtered_data['district'].isin(districts)]\n        \n        # åƒ¹æ ¼ç¯„åœç¯©é¸\n        if price_range and 'price_per_hour' in filtered_data.columns:\n            min_price, max_price = price_range\n            filtered_data = filtered_data[\n                (filtered_data['price_per_hour'] >= min_price) &\n                (filtered_data['price_per_hour'] <= max_price)\n            ]\n        \n        # è¨­æ–½ç¯©é¸\n        if facilities and 'facilities' in filtered_data.columns:\n            for facility in facilities:\n                filtered_data = filtered_data[\n                    filtered_data['facilities'].astype(str).str.contains(facility, na=False, case=False)\n                ]\n        \n        # è©•åˆ†ç¯©é¸\n        if min_rating > 0 and 'rating' in filtered_data.columns:\n            filtered_data = filtered_data[filtered_data['rating'] >= min_rating]\n        \n        return filtered_data if not filtered_data.empty else None\n    \n    def get_venues_by_ids(self, venue_ids: List[Any]) -> Optional[pd.DataFrame]:\n        \"\"\"\n        æ ¹æ“šå ´åœ°IDåˆ—è¡¨ç²å–å ´åœ°è³‡æ–™\n        \n        Args:\n            venue_ids: å ´åœ°IDåˆ—è¡¨\n            \n        Returns:\n            å°æ‡‰çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if self.venues_data is None or self.venues_data.empty or not venue_ids:\n            return None\n        \n        # ä½¿ç”¨IDæ¬„ä½ç¯©é¸\n        if 'id' in self.venues_data.columns:\n            filtered_data = self.venues_data[self.venues_data['id'].isin(venue_ids)]\n        else:\n            return None\n        \n        return filtered_data if not filtered_data.empty else None\n    \n    def get_venue_by_id(self, venue_id: int) -> Optional[Dict[str, Any]]:\n        \"\"\"æ ¹æ“šIDç²å–å ´åœ°è©³ç´°è³‡è¨Š\"\"\"\n        try:\n            if self.venues_data is None or self.venues_data.empty:\n                return None\n            \n            venue_data = self.venues_data[self.venues_data['id'] == venue_id]\n            \n            if venue_data.empty:\n                return None\n                \n            return venue_data.iloc[0].to_dict()\n            \n        except Exception as e:\n            print(f\"ç²å–å ´åœ°è©³ç´°è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def get_popular_searches(self) -> List[str]:\n        \"\"\"\n        ç²å–ç†±é–€æœå°‹é—œéµå­—\n        \n        Returns:\n            ç†±é–€æœå°‹é—œéµå­—åˆ—è¡¨\n        \"\"\"\n        popular_searches = []\n        \n        # æ·»åŠ é‹å‹•é¡å‹ä½œç‚ºç†±é–€æœå°‹\n        if self.sport_types:\n            popular_searches.extend(self.sport_types[:5])\n        \n        # æ·»åŠ åœ°å€ä½œç‚ºç†±é–€æœå°‹\n        if self.districts:\n            popular_searches.extend(self.districts[:3])\n        \n        # æ·»åŠ ä¸€äº›å¸¸è¦‹æœå°‹è©\n        common_searches = [\"å®¤å…§\", \"æˆ¶å¤–\", \"ä¾¿å®œ\", \"é«˜è©•åˆ†\", \"åœè»Šå ´\", \"24å°æ™‚\"]\n        popular_searches.extend(common_searches)\n        \n        return popular_searches[:10]  # è¿”å›å‰10å€‹ç†±é–€æœå°‹","size_bytes":23520},"utils/map_utils.py":{"content":"import pandas as pd\nimport numpy as np\nfrom typing import Dict, List, Tuple, Optional, Any\nimport math\n\nclass MapUtils:\n    \"\"\"\n    åœ°åœ–å·¥å…·é¡åˆ¥ï¼Œæä¾›åœ°åœ–ç›¸é—œçš„åŠŸèƒ½å’Œåº§æ¨™è¨ˆç®—\n    \"\"\"\n    \n    def __init__(self):\n        # å°åŒ—å¸‚å„å€ä¸­å¿ƒåº§æ¨™\n        self.district_centers = {\n            \"å°åŒ—å¸‚ä¸­å¿ƒ\": [25.0330, 121.5654],\n            \"ä¸­æ­£å€\": [25.0320, 121.5200],\n            \"å¤§åŒå€\": [25.0632, 121.5138],\n            \"ä¸­å±±å€\": [25.0642, 121.5326],\n            \"æ¾å±±å€\": [25.0497, 121.5746],\n            \"å¤§å®‰å€\": [25.0263, 121.5436],\n            \"è¬è¯å€\": [25.0338, 121.5014],\n            \"ä¿¡ç¾©å€\": [25.0308, 121.5645],\n            \"å£«æ—å€\": [25.0876, 121.5258],\n            \"åŒ—æŠ•å€\": [25.1174, 121.4985],\n            \"å…§æ¹–å€\": [25.0695, 121.5945],\n            \"å—æ¸¯å€\": [25.0547, 121.6066],\n            \"æ–‡å±±å€\": [24.9887, 121.5706]\n        }\n        \n        # é‹å‹•é¡å‹å°æ‡‰çš„åœ°åœ–æ¨™è¨˜é¡è‰²\n        self.sport_colors = {\n            \"ç±ƒçƒ\": \"blue\",\n            \"è¶³çƒ\": \"green\", \n            \"ç¶²çƒ\": \"red\",\n            \"ç¾½æ¯›çƒ\": \"orange\",\n            \"æ¸¸æ³³\": \"lightblue\",\n            \"å¥èº«æˆ¿\": \"purple\",\n            \"è·‘æ­¥\": \"gray\",\n            \"æ¡Œçƒ\": \"pink\",\n            \"æ’çƒ\": \"darkblue\",\n            \"æ£’çƒ\": \"darkgreen\",\n            \"ç‘œä¼½\": \"lightgreen\",\n            \"èˆè¹ˆ\": \"violet\",\n            \"å…¶ä»–\": \"black\"\n        }\n        \n        # å°åŒ—å¸‚é‚Šç•Œåº§æ¨™ï¼ˆå¤§ç´„ç¯„åœï¼‰\n        self.taipei_bounds = {\n            \"north\": 25.3,\n            \"south\": 24.9,\n            \"east\": 121.65,\n            \"west\": 121.45\n        }\n    \n    def get_district_center(self, district_name: str) -> List[float]:\n        \"\"\"\n        ç²å–æŒ‡å®šåœ°å€çš„ä¸­å¿ƒåº§æ¨™\n        \n        Args:\n            district_name: åœ°å€åç¨±\n            \n        Returns:\n            [ç·¯åº¦, ç¶“åº¦] åº§æ¨™åˆ—è¡¨\n        \"\"\"\n        return self.district_centers.get(district_name, self.district_centers[\"å°åŒ—å¸‚ä¸­å¿ƒ\"])\n    \n    def get_sport_colors(self) -> Dict[str, str]:\n        \"\"\"\n        ç²å–é‹å‹•é¡å‹å°æ‡‰çš„é¡è‰²æ˜ å°„\n        \n        Returns:\n            é‹å‹•é¡å‹åˆ°é¡è‰²çš„æ˜ å°„å­—å…¸\n        \"\"\"\n        return self.sport_colors.copy()\n    \n    def calculate_distance(self, lat1: float, lon1: float, lat2: float, lon2: float) -> float:\n        \"\"\"\n        è¨ˆç®—å…©é»é–“çš„è·é›¢ï¼ˆä½¿ç”¨ Haversine å…¬å¼ï¼‰\n        \n        Args:\n            lat1: ç¬¬ä¸€é»ç·¯åº¦\n            lon1: ç¬¬ä¸€é»ç¶“åº¦\n            lat2: ç¬¬äºŒé»ç·¯åº¦\n            lon2: ç¬¬äºŒé»ç¶“åº¦\n            \n        Returns:\n            è·é›¢ï¼ˆå…¬é‡Œï¼‰\n        \"\"\"\n        # å°‡åº¦è½‰æ›ç‚ºå¼§åº¦\n        lat1, lon1, lat2, lon2 = map(math.radians, [lat1, lon1, lat2, lon2])\n        \n        # Haversine å…¬å¼\n        dlat = lat2 - lat1\n        dlon = lon2 - lon1\n        a = math.sin(dlat/2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon/2)**2\n        c = 2 * math.asin(math.sqrt(a))\n        \n        # åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰\n        r = 6371\n        \n        return r * c\n    \n    def find_nearest_venue(self, venues_df: pd.DataFrame, target_lat: float, target_lon: float) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        å°‹æ‰¾è·é›¢æŒ‡å®šåº§æ¨™æœ€è¿‘çš„å ´åœ°\n        \n        Args:\n            venues_df: å ´åœ°è³‡æ–™ DataFrame\n            target_lat: ç›®æ¨™ç·¯åº¦\n            target_lon: ç›®æ¨™ç¶“åº¦\n            \n        Returns:\n            æœ€è¿‘å ´åœ°çš„è³‡æ–™å­—å…¸\n        \"\"\"\n        if venues_df is None or venues_df.empty:\n            return None\n        \n        if 'latitude' not in venues_df.columns or 'longitude' not in venues_df.columns:\n            return None\n        \n        min_distance = float('inf')\n        nearest_venue = None\n        \n        for idx, venue in venues_df.iterrows():\n            if pd.notna(venue['latitude']) and pd.notna(venue['longitude']):\n                distance = self.calculate_distance(\n                    target_lat, target_lon,\n                    venue['latitude'], venue['longitude']\n                )\n                \n                if distance < min_distance:\n                    min_distance = distance\n                    nearest_venue = venue.to_dict()\n                    nearest_venue['distance'] = distance\n        \n        return nearest_venue\n    \n    def get_venues_in_radius(self, venues_df: pd.DataFrame, center_lat: float, center_lon: float, radius_km: float) -> pd.DataFrame:\n        \"\"\"\n        ç²å–æŒ‡å®šåŠå¾‘å…§çš„å ´åœ°\n        \n        Args:\n            venues_df: å ´åœ°è³‡æ–™ DataFrame\n            center_lat: ä¸­å¿ƒé»ç·¯åº¦\n            center_lon: ä¸­å¿ƒé»ç¶“åº¦\n            radius_km: åŠå¾‘ï¼ˆå…¬é‡Œï¼‰\n            \n        Returns:\n            åŠå¾‘å…§çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if venues_df is None or venues_df.empty:\n            return pd.DataFrame()\n        \n        if 'latitude' not in venues_df.columns or 'longitude' not in venues_df.columns:\n            return venues_df\n        \n        venues_in_radius = []\n        \n        for idx, venue in venues_df.iterrows():\n            if pd.notna(venue['latitude']) and pd.notna(venue['longitude']):\n                distance = self.calculate_distance(\n                    center_lat, center_lon,\n                    venue['latitude'], venue['longitude']\n                )\n                \n                if distance <= radius_km:\n                    venue_data = venue.to_dict()\n                    venue_data['distance'] = distance\n                    venues_in_radius.append(venue_data)\n        \n        return pd.DataFrame(venues_in_radius)\n    \n    def generate_coordinates_for_district(self, district: str, num_points: int = 1) -> List[Tuple[float, float]]:\n        \"\"\"\n        ç‚ºæŒ‡å®šåœ°å€ç”Ÿæˆéš¨æ©Ÿåº§æ¨™é»\n        \n        Args:\n            district: åœ°å€åç¨±\n            num_points: è¦ç”Ÿæˆçš„é»æ•¸\n            \n        Returns:\n            åº§æ¨™é»åˆ—è¡¨ [(ç·¯åº¦, ç¶“åº¦), ...]\n        \"\"\"\n        center = self.get_district_center(district)\n        center_lat, center_lon = center[0], center[1]\n        \n        # ç”Ÿæˆå€åŸŸå…§éš¨æ©Ÿé»ï¼ˆç´„0.01åº¦ç¯„åœå…§ï¼‰\n        coordinates = []\n        np.random.seed(hash(district) % 1000)  # ç¢ºä¿æ¯å€‹å€åŸŸçš„åº§æ¨™ä¸€è‡´\n        \n        for _ in range(num_points):\n            # åœ¨ä¸­å¿ƒé»å‘¨åœç”Ÿæˆéš¨æ©Ÿåç§»\n            lat_offset = np.random.uniform(-0.01, 0.01)\n            lon_offset = np.random.uniform(-0.01, 0.01)\n            \n            lat = center_lat + lat_offset\n            lon = center_lon + lon_offset\n            \n            # ç¢ºä¿åº§æ¨™åœ¨å°åŒ—å¸‚ç¯„åœå…§\n            lat = max(self.taipei_bounds[\"south\"], min(self.taipei_bounds[\"north\"], lat))\n            lon = max(self.taipei_bounds[\"west\"], min(self.taipei_bounds[\"east\"], lon))\n            \n            coordinates.append((lat, lon))\n        \n        return coordinates\n    \n    def assign_coordinates_to_venues(self, venues_df: pd.DataFrame) -> pd.DataFrame:\n        \"\"\"\n        ç‚ºæ²’æœ‰åº§æ¨™çš„å ´åœ°åˆ†é…åº§æ¨™\n        \n        Args:\n            venues_df: å ´åœ°è³‡æ–™ DataFrame\n            \n        Returns:\n            åŒ…å«åº§æ¨™çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if venues_df is None or venues_df.empty:\n            return venues_df\n        \n        venues_with_coords = venues_df.copy()\n        \n        # ç¢ºä¿åº§æ¨™æ¬„ä½å­˜åœ¨\n        if 'latitude' not in venues_with_coords.columns:\n            venues_with_coords['latitude'] = None\n        if 'longitude' not in venues_with_coords.columns:\n            venues_with_coords['longitude'] = None\n        \n        # ç‚ºæ²’æœ‰åº§æ¨™çš„å ´åœ°åˆ†é…åº§æ¨™\n        for idx, venue in venues_with_coords.iterrows():\n            if pd.isna(venue['latitude']) or pd.isna(venue['longitude']):\n                district = venue.get('district', 'å°åŒ—å¸‚ä¸­å¿ƒ')\n                \n                # ç‚ºè©²åœ°å€ç”Ÿæˆä¸€å€‹åº§æ¨™é»\n                coords = self.generate_coordinates_for_district(district, 1)\n                if coords:\n                    lat, lon = coords[0]\n                    venues_with_coords.at[idx, 'latitude'] = lat\n                    venues_with_coords.at[idx, 'longitude'] = lon\n        \n        return venues_with_coords\n    \n    def get_district_bounds(self, district: str) -> Dict[str, float]:\n        \"\"\"\n        ç²å–æŒ‡å®šåœ°å€çš„é‚Šç•Œåº§æ¨™\n        \n        Args:\n            district: åœ°å€åç¨±\n            \n        Returns:\n            é‚Šç•Œåº§æ¨™å­—å…¸ {'north': ..., 'south': ..., 'east': ..., 'west': ...}\n        \"\"\"\n        center = self.get_district_center(district)\n        center_lat, center_lon = center[0], center[1]\n        \n        # æ¯å€‹å€åŸŸç´„0.02åº¦çš„ç¯„åœ\n        bounds = {\n            'north': center_lat + 0.01,\n            'south': center_lat - 0.01,\n            'east': center_lon + 0.01,\n            'west': center_lon - 0.01\n        }\n        \n        return bounds\n    \n    def cluster_venues_by_proximity(self, venues_df: pd.DataFrame, max_distance_km: float = 0.5) -> Dict[str, List[int]]:\n        \"\"\"\n        æ ¹æ“šè·é›¢å°‡å ´åœ°åˆ†ç¾¤\n        \n        Args:\n            venues_df: å ´åœ°è³‡æ–™ DataFrame\n            max_distance_km: æœ€å¤§ç¾¤é›†è·é›¢ï¼ˆå…¬é‡Œï¼‰\n            \n        Returns:\n            ç¾¤é›†å­—å…¸ï¼Œkeyç‚ºç¾¤é›†IDï¼Œvalueç‚ºå ´åœ°ç´¢å¼•åˆ—è¡¨\n        \"\"\"\n        if venues_df is None or venues_df.empty:\n            return {}\n        \n        if 'latitude' not in venues_df.columns or 'longitude' not in venues_df.columns:\n            return {}\n        \n        clusters = {}\n        cluster_id = 0\n        assigned_venues = set()\n        \n        for idx, venue in venues_df.iterrows():\n            if idx in assigned_venues:\n                continue\n            \n            if pd.isna(venue['latitude']) or pd.isna(venue['longitude']):\n                continue\n            \n            # é–‹å§‹æ–°çš„ç¾¤é›†\n            cluster_venues = [idx]\n            assigned_venues.add(idx)\n            \n            # å°‹æ‰¾é™„è¿‘çš„å ´åœ°\n            for other_idx, other_venue in venues_df.iterrows():\n                if other_idx in assigned_venues:\n                    continue\n                \n                if pd.isna(other_venue['latitude']) or pd.isna(other_venue['longitude']):\n                    continue\n                \n                distance = self.calculate_distance(\n                    venue['latitude'], venue['longitude'],\n                    other_venue['latitude'], other_venue['longitude']\n                )\n                \n                if distance <= max_distance_km:\n                    cluster_venues.append(other_idx)\n                    assigned_venues.add(other_idx)\n            \n            clusters[f\"cluster_{cluster_id}\"] = cluster_venues\n            cluster_id += 1\n        \n        return clusters\n    \n    def get_route_waypoints(self, start_coords: Tuple[float, float], end_coords: Tuple[float, float], num_waypoints: int = 3) -> List[Tuple[float, float]]:\n        \"\"\"\n        ç²å–å…©é»é–“çš„è·¯ç·šé€”ç¶“é»\n        \n        Args:\n            start_coords: èµ·é»åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)\n            end_coords: çµ‚é»åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)\n            num_waypoints: é€”ç¶“é»æ•¸é‡\n            \n        Returns:\n            é€”ç¶“é»åº§æ¨™åˆ—è¡¨\n        \"\"\"\n        start_lat, start_lon = start_coords\n        end_lat, end_lon = end_coords\n        \n        waypoints = []\n        \n        for i in range(1, num_waypoints + 1):\n            # ç°¡å–®çš„ç·šæ€§æ’å€¼\n            ratio = i / (num_waypoints + 1)\n            \n            waypoint_lat = start_lat + (end_lat - start_lat) * ratio\n            waypoint_lon = start_lon + (end_lon - start_lon) * ratio\n            \n            waypoints.append((waypoint_lat, waypoint_lon))\n        \n        return waypoints\n    \n    def validate_coordinates(self, lat: float, lon: float) -> bool:\n        \"\"\"\n        é©—è­‰åº§æ¨™æ˜¯å¦åœ¨å°åŒ—å¸‚ç¯„åœå…§\n        \n        Args:\n            lat: ç·¯åº¦\n            lon: ç¶“åº¦\n            \n        Returns:\n            æ˜¯å¦ç‚ºæœ‰æ•ˆåº§æ¨™\n        \"\"\"\n        return (self.taipei_bounds[\"south\"] <= lat <= self.taipei_bounds[\"north\"] and\n                self.taipei_bounds[\"west\"] <= lon <= self.taipei_bounds[\"east\"])\n    \n    def get_map_zoom_level(self, bounds: Dict[str, float]) -> int:\n        \"\"\"\n        æ ¹æ“šé‚Šç•Œç¯„åœè¨ˆç®—é©ç•¶çš„åœ°åœ–ç¸®æ”¾ç´šåˆ¥\n        \n        Args:\n            bounds: é‚Šç•Œåº§æ¨™å­—å…¸\n            \n        Returns:\n            ç¸®æ”¾ç´šåˆ¥\n        \"\"\"\n        lat_range = bounds[\"north\"] - bounds[\"south\"]\n        lon_range = bounds[\"east\"] - bounds[\"west\"]\n        \n        max_range = max(lat_range, lon_range)\n        \n        if max_range > 0.1:\n            return 10\n        elif max_range > 0.05:\n            return 12\n        elif max_range > 0.02:\n            return 14\n        elif max_range > 0.01:\n            return 15\n        else:\n            return 16\n    \n    def get_distance_description(self, distance_km: float) -> str:\n        \"\"\"\n        å°‡è·é›¢è½‰æ›ç‚ºäººæ€§åŒ–çš„æè¿°\n        \n        Args:\n            distance_km: è·é›¢ï¼ˆå…¬é‡Œï¼‰\n            \n        Returns:\n            è·é›¢æè¿°å­—ä¸²\n        \"\"\"\n        if distance_km < 0.5:\n            return f\"{int(distance_km * 1000)}å…¬å°º\"\n        elif distance_km < 1.0:\n            return f\"{distance_km:.1f}å…¬é‡Œ\"\n        else:\n            return f\"{distance_km:.1f}å…¬é‡Œ\"\n","size_bytes":13421},"utils/recommendation_engine.py":{"content":"import pandas as pd\nimport numpy as np\nfrom typing import List, Dict, Any, Optional, Tuple\nfrom sklearn.feature_extraction.text import TfidfVectorizer\nfrom sklearn.metrics.pairwise import cosine_similarity\nfrom sklearn.cluster import KMeans\nfrom sklearn.preprocessing import StandardScaler, LabelEncoder\nfrom sklearn.decomposition import PCA\nfrom sklearn.ensemble import RandomForestRegressor\nimport random\n\nclass RecommendationEngine:\n    \"\"\"\n    æ¨è–¦å¼•æ“é¡åˆ¥ï¼Œæä¾›å¤šç¨®æ¨è–¦æ¼”ç®—æ³•ä¾†ç‚ºç”¨æˆ¶æ¨è–¦é©åˆçš„é‹å‹•å ´åœ°\n    \"\"\"\n    \n    def __init__(self):\n        self.user_profiles = {}\n        self.venue_features = None\n        self.tfidf_vectorizer = None\n        self.content_features_matrix = None\n        self.feedback_data = {}\n        self.scaler = StandardScaler()\n        self.label_encoders = {}\n        self.kmeans_model = None\n        self.pca_model = None\n        self.ml_model = None\n        self.weights = {\n            'preference_weight': 0.3,\n            'rating_weight': 0.25,\n            'price_weight': 0.2,\n            'distance_weight': 0.15,\n            'facility_weight': 0.1,\n            'explore_vs_exploit': 0.3,\n            'popularity_bias': 0.4,\n            'novelty_preference': 0.2,\n            'serendipity_factor': 0.15\n        }\n    \n    def get_personalized_recommendations(self, \n                                       user_preferences: Dict[str, Any],\n                                       num_recommendations: int = 10,\n                                       diversity_weight: float = 0.3) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ç²å–å€‹äººåŒ–æ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½è¨­å®š\n            num_recommendations: æ¨è–¦æ•¸é‡\n            diversity_weight: å¤šæ¨£æ€§æ¬Šé‡\n            \n        Returns:\n            æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # è¨ˆç®—æ¨è–¦åˆ†æ•¸\n            venues_with_scores = self._calculate_recommendation_scores(\n                venues_data, user_preferences\n            )\n            \n            if venues_with_scores.empty:\n                return None\n            \n            # æ‡‰ç”¨å¤šæ¨£æ€§\n            if diversity_weight > 0:\n                venues_with_scores = self._apply_diversity(\n                    venues_with_scores, diversity_weight\n                )\n            \n            # æ’åºä¸¦å–å‰Nå€‹\n            recommended_venues = venues_with_scores.nlargest(\n                num_recommendations, 'recommendation_score'\n            )\n            \n            # æ·»åŠ æ¨è–¦åŸå› \n            recommended_venues = self._add_recommendation_reasons(\n                recommended_venues, user_preferences\n            )\n            \n            return recommended_venues\n            \n        except Exception as e:\n            print(f\"ç”Ÿæˆå€‹äººåŒ–æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def get_trending_venues(self, num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ç²å–ç†±é–€å ´åœ°æ¨è–¦\n        \n        Args:\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            ç†±é–€å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # è¨ˆç®—ç†±é–€åº¦åˆ†æ•¸ï¼ˆåŸºæ–¼è©•åˆ†å’Œå‡è¨­çš„è¨ªå•é‡ï¼‰\n            venues_with_trending = venues_data.copy()\n            \n            # åŸºæ–¼è©•åˆ†è¨ˆç®—ç†±é–€åº¦\n            if 'rating' in venues_with_trending.columns:\n                # æ­£è¦åŒ–è©•åˆ†\n                max_rating = venues_with_trending['rating'].max()\n                if max_rating > 0:\n                    venues_with_trending['rating_score'] = venues_with_trending['rating'] / max_rating\n                else:\n                    venues_with_trending['rating_score'] = 0\n            else:\n                venues_with_trending['rating_score'] = 0.5\n            \n            # æ¨¡æ“¬äººæ°£åˆ†æ•¸ï¼ˆåœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²åŸºæ–¼çœŸå¯¦çš„è¨ªå•æ•¸æ“šï¼‰\n            np.random.seed(42)  # ç¢ºä¿ä¸€è‡´æ€§\n            venues_with_trending['popularity_score'] = np.random.beta(2, 5, len(venues_with_trending))\n            \n            # è¨ˆç®—ç¶œåˆç†±é–€åº¦åˆ†æ•¸\n            venues_with_trending['trending_score'] = (\n                venues_with_trending['rating_score'] * 0.6 +\n                venues_with_trending['popularity_score'] * 0.4\n            )\n            \n            # æ·»åŠ æ¨è–¦åˆ†æ•¸å’ŒåŸå› \n            venues_with_trending['recommendation_score'] = venues_with_trending['trending_score'] * 10\n            venues_with_trending['recommendation_reason'] = \"ç†±é–€å ´åœ° - é«˜è©•åˆ†ä¸”å—æ­¡è¿\"\n            \n            # æ’åºä¸¦è¿”å›\n            trending_venues = venues_with_trending.nlargest(\n                num_recommendations, 'trending_score'\n            )\n            \n            return trending_venues\n            \n        except Exception as e:\n            print(f\"ç²å–ç†±é–€å ´åœ°æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def get_new_venues(self, num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ç²å–æ–°å ´åœ°æ¨è–¦\n        \n        Args:\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            æ–°å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # æ¨¡æ“¬æ–°å ´åœ°ï¼ˆåœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²æœ‰å»ºç«‹æ—¥æœŸæ¬„ä½ï¼‰\n            venues_with_new = venues_data.copy()\n            \n            # éš¨æ©Ÿé¸æ“‡ä¸€éƒ¨åˆ†ä½œç‚º\"æ–°\"å ´åœ°\n            np.random.seed(123)\n            total_venues = len(venues_with_new)\n            new_venue_indices = np.random.choice(\n                total_venues, \n                size=min(total_venues // 3, num_recommendations * 2), \n                replace=False\n            )\n            \n            new_venues = venues_with_new.iloc[new_venue_indices].copy()\n            \n            # ç‚ºæ–°å ´åœ°æ·»åŠ æ¨è–¦åˆ†æ•¸\n            new_venues['recommendation_score'] = np.random.uniform(6.0, 9.0, len(new_venues))\n            new_venues['recommendation_reason'] = \"æ–°é–‹æ”¾å ´åœ° - å€¼å¾—æ¢ç´¢\"\n            \n            # æ’åºä¸¦è¿”å›\n            new_venues = new_venues.nlargest(num_recommendations, 'recommendation_score')\n            \n            return new_venues\n            \n        except Exception as e:\n            print(f\"ç²å–æ–°å ´åœ°æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def get_collaborative_recommendations(self, \n                                        user_preferences: Dict[str, Any],\n                                        num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ç²å–å”åŒéæ¿¾æ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            å”åŒéæ¿¾æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # æ¨¡æ“¬ç›¸ä¼¼ç”¨æˆ¶çš„åå¥½ï¼ˆåœ¨å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²åŸºæ–¼çœŸå¯¦ç”¨æˆ¶è¡Œç‚ºæ•¸æ“šï¼‰\n            similar_users_preferences = self._generate_similar_user_preferences(user_preferences)\n            \n            # åŸºæ–¼ç›¸ä¼¼ç”¨æˆ¶çš„é¸æ“‡æ¨è–¦å ´åœ°\n            collaborative_venues = venues_data.copy()\n            \n            # è¨ˆç®—å”åŒéæ¿¾åˆ†æ•¸\n            collaborative_scores = []\n            for idx, venue in collaborative_venues.iterrows():\n                score = self._calculate_collaborative_score(venue, similar_users_preferences)\n                collaborative_scores.append(score)\n            \n            collaborative_venues['recommendation_score'] = collaborative_scores\n            collaborative_venues['recommendation_reason'] = \"ç›¸ä¼¼ç”¨æˆ¶æ¨è–¦ - èˆ‡æ‚¨å–œå¥½ç›¸ä¼¼çš„ç”¨æˆ¶ä¹Ÿå–œæ­¡é€™äº›å ´åœ°\"\n            \n            # éæ¿¾æ‰åˆ†æ•¸å¤ªä½çš„å ´åœ°\n            collaborative_venues = collaborative_venues[\n                collaborative_venues['recommendation_score'] >= 5.0\n            ]\n            \n            if collaborative_venues.empty:\n                return None\n            \n            # æ’åºä¸¦è¿”å›\n            recommended_venues = collaborative_venues.nlargest(\n                num_recommendations, 'recommendation_score'\n            )\n            \n            return recommended_venues\n            \n        except Exception as e:\n            print(f\"ç”Ÿæˆå”åŒéæ¿¾æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def get_rating_based_recommendations(self, \n                                       user_preferences: Dict[str, Any],\n                                       num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ç²å–åŸºæ–¼è©•åˆ†çš„æ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            åŸºæ–¼è©•åˆ†çš„æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # éæ¿¾æœ‰è©•åˆ†çš„å ´åœ°\n            rated_venues = venues_data[venues_data['rating'].notna() & (venues_data['rating'] > 0)].copy()\n            \n            if rated_venues.empty:\n                return None\n            \n            # æ ¹æ“šç”¨æˆ¶åå¥½ç¯©é¸\n            filtered_venues = self._filter_by_preferences(rated_venues, user_preferences)\n            \n            if filtered_venues.empty:\n                filtered_venues = rated_venues\n            \n            # åŸºæ–¼è©•åˆ†æ’åº\n            filtered_venues = filtered_venues.sort_values('rating', ascending=False)\n            \n            # è¨ˆç®—æ¨è–¦åˆ†æ•¸ï¼ˆä¸»è¦åŸºæ–¼è©•åˆ†ï¼ŒåŠ ä¸Šä¸€äº›éš¨æ©Ÿæ€§ï¼‰\n            np.random.seed(42)\n            rating_scores = filtered_venues['rating'] / 5.0 * 8  # è½‰æ›ç‚º8åˆ†åˆ¶\n            random_bonus = np.random.uniform(0, 2, len(filtered_venues))  # åŠ å…¥éš¨æ©Ÿæ€§\n            \n            filtered_venues['recommendation_score'] = rating_scores + random_bonus\n            filtered_venues['recommendation_reason'] = filtered_venues['rating'].apply(\n                lambda x: f\"é«˜è©•åˆ†å ´åœ° - å¹³å‡è©•åˆ† {x:.1f}/5.0\"\n            )\n            \n            # è¿”å›å‰Nå€‹\n            recommended_venues = filtered_venues.head(num_recommendations)\n            \n            return recommended_venues\n            \n        except Exception as e:\n            print(f\"ç”ŸæˆåŸºæ–¼è©•åˆ†çš„æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def _calculate_recommendation_scores(self, \n                                       venues_data: pd.DataFrame, \n                                       user_preferences: Dict[str, Any]) -> pd.DataFrame:\n        \"\"\"\n        è¨ˆç®—æ¨è–¦åˆ†æ•¸\n        \n        Args:\n            venues_data: å ´åœ°è³‡æ–™\n            user_preferences: ç”¨æˆ¶åå¥½\n            \n        Returns:\n            åŒ…å«æ¨è–¦åˆ†æ•¸çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        venues_with_scores = venues_data.copy()\n        \n        # åˆå§‹åŒ–å„é …åˆ†æ•¸\n        venues_with_scores['preference_match'] = 0.0\n        venues_with_scores['rating_weight'] = 0.0\n        venues_with_scores['price_match'] = 0.0\n        venues_with_scores['distance_score'] = 0.0\n        venues_with_scores['facility_match'] = 0.0\n        \n        # è¨ˆç®—åå¥½åŒ¹é…åº¦\n        self._calculate_preference_match(venues_with_scores, user_preferences)\n        \n        # è¨ˆç®—è©•åˆ†æ¬Šé‡\n        self._calculate_rating_weight(venues_with_scores)\n        \n        # è¨ˆç®—åƒ¹æ ¼åŒ¹é…åº¦\n        self._calculate_price_match(venues_with_scores, user_preferences)\n        \n        # è¨ˆç®—è·é›¢åˆ†æ•¸ï¼ˆåŸºæ–¼åå¥½åœ°å€ï¼‰\n        self._calculate_distance_score(venues_with_scores, user_preferences)\n        \n        # è¨ˆç®—è¨­æ–½åŒ¹é…åº¦\n        self._calculate_facility_match(venues_with_scores, user_preferences)\n        \n        # è¨ˆç®—ç¶œåˆæ¨è–¦åˆ†æ•¸\n        venues_with_scores['recommendation_score'] = (\n            venues_with_scores['preference_match'] * self.weights['preference_weight'] +\n            venues_with_scores['rating_weight'] * self.weights['rating_weight'] +\n            venues_with_scores['price_match'] * self.weights['price_weight'] +\n            venues_with_scores['distance_score'] * self.weights['distance_weight'] +\n            venues_with_scores['facility_match'] * self.weights['facility_weight']\n        ) * 10  # è½‰æ›ç‚º10åˆ†åˆ¶\n        \n        return venues_with_scores\n    \n    def _calculate_preference_match(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]):\n        \"\"\"è¨ˆç®—åå¥½åŒ¹é…åº¦\"\"\"\n        preferred_sports = user_preferences.get('preferred_sports', [])\n        preferred_districts = user_preferences.get('preferred_districts', [])\n        \n        if preferred_sports and 'sport_type' in venues_data.columns:\n            venues_data['sport_match'] = venues_data['sport_type'].apply(\n                lambda x: 1.0 if x in preferred_sports else 0.5\n            )\n        else:\n            venues_data['sport_match'] = 0.7\n        \n        if preferred_districts and 'district' in venues_data.columns:\n            venues_data['district_match'] = venues_data['district'].apply(\n                lambda x: 1.0 if x in preferred_districts else 0.3\n            )\n        else:\n            venues_data['district_match'] = 0.7\n        \n        venues_data['preference_match'] = (venues_data['sport_match'] + venues_data['district_match']) / 2\n    \n    def _calculate_rating_weight(self, venues_data: pd.DataFrame):\n        \"\"\"è¨ˆç®—è©•åˆ†æ¬Šé‡\"\"\"\n        if 'rating' in venues_data.columns:\n            max_rating = venues_data['rating'].max()\n            if max_rating > 0:\n                venues_data['rating_weight'] = venues_data['rating'] / max_rating\n            else:\n                venues_data['rating_weight'] = 0.5\n        else:\n            venues_data['rating_weight'] = 0.5\n    \n    def _calculate_price_match(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]):\n        \"\"\"è¨ˆç®—åƒ¹æ ¼åŒ¹é…åº¦\"\"\"\n        price_range = user_preferences.get('price_range', [0, 10000])\n        min_price, max_price = price_range\n        \n        if 'price_per_hour' in venues_data.columns:\n            venues_data['price_match'] = venues_data['price_per_hour'].apply(\n                lambda x: 1.0 if pd.isna(x) or (min_price <= x <= max_price) else \n                         max(0.0, 1.0 - abs(x - (min_price + max_price) / 2) / max_price)\n            )\n        else:\n            venues_data['price_match'] = 0.7\n    \n    def _calculate_distance_score(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]):\n        \"\"\"è¨ˆç®—è·é›¢åˆ†æ•¸\"\"\"\n        preferred_districts = user_preferences.get('preferred_districts', [])\n        \n        if preferred_districts and 'district' in venues_data.columns:\n            venues_data['distance_score'] = venues_data['district'].apply(\n                lambda x: 1.0 if x in preferred_districts else 0.4\n            )\n        else:\n            venues_data['distance_score'] = 0.7\n    \n    def _calculate_facility_match(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]):\n        \"\"\"è¨ˆç®—è¨­æ–½åŒ¹é…åº¦\"\"\"\n        # é€™è£¡å¯ä»¥æ ¹æ“šç”¨æˆ¶çš„è¨­æ–½åå¥½é€²è¡Œè¨ˆç®—\n        # æš«æ™‚çµ¦äºˆçµ±ä¸€åˆ†æ•¸\n        venues_data['facility_match'] = 0.7\n    \n    def _apply_diversity(self, venues_data: pd.DataFrame, diversity_weight: float) -> pd.DataFrame:\n        \"\"\"\n        æ‡‰ç”¨å¤šæ¨£æ€§åˆ°æ¨è–¦çµæœ\n        \n        Args:\n            venues_data: å ´åœ°è³‡æ–™\n            diversity_weight: å¤šæ¨£æ€§æ¬Šé‡\n            \n        Returns:\n            æ‡‰ç”¨å¤šæ¨£æ€§å¾Œçš„å ´åœ°è³‡æ–™\n        \"\"\"\n        if 'sport_type' not in venues_data.columns:\n            return venues_data\n        \n        # æŒ‰é‹å‹•é¡å‹åˆ†çµ„\n        sport_groups = venues_data.groupby('sport_type')\n        \n        # ç‚ºæ¯å€‹é‹å‹•é¡å‹æ·»åŠ å¤šæ¨£æ€§æ‡²ç½°\n        diversified_venues = []\n        \n        for sport_type, group in sport_groups:\n            group = group.copy()\n            # æ ¹æ“šè©²é‹å‹•é¡å‹å ´åœ°æ•¸é‡èª¿æ•´åˆ†æ•¸\n            group_size = len(group)\n            diversity_penalty = min(diversity_weight * (group_size - 1) * 0.1, 2.0)\n            \n            group['recommendation_score'] = group['recommendation_score'] - diversity_penalty\n            diversified_venues.append(group)\n        \n        return pd.concat(diversified_venues, ignore_index=True)\n    \n    def _add_recommendation_reasons(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]) -> pd.DataFrame:\n        \"\"\"\n        æ·»åŠ æ¨è–¦åŸå› \n        \n        Args:\n            venues_data: å ´åœ°è³‡æ–™\n            user_preferences: ç”¨æˆ¶åå¥½\n            \n        Returns:\n            åŒ…å«æ¨è–¦åŸå› çš„å ´åœ°è³‡æ–™\n        \"\"\"\n        venues_with_reasons = venues_data.copy()\n        \n        def generate_reason(row):\n            reasons = []\n            \n            if row.get('preference_match', 0) > 0.8:\n                if 'sport_type' in row and row['sport_type'] in user_preferences.get('preferred_sports', []):\n                    reasons.append(f\"ç¬¦åˆæ‚¨åå¥½çš„{row['sport_type']}\")\n                if 'district' in row and row['district'] in user_preferences.get('preferred_districts', []):\n                    reasons.append(f\"ä½æ–¼æ‚¨åå¥½çš„{row['district']}\")\n            \n            if row.get('rating_weight', 0) > 0.8 and 'rating' in row:\n                reasons.append(f\"é«˜è©•åˆ†å ´åœ°({row['rating']:.1f}/5.0)\")\n            \n            if row.get('price_match', 0) > 0.8:\n                reasons.append(\"åƒ¹æ ¼ç¬¦åˆæ‚¨çš„é ç®—\")\n            \n            if not reasons:\n                reasons.append(\"ç¶œåˆè©•ä¼°æ¨è–¦\")\n            \n            return \" â€¢ \".join(reasons)\n        \n        venues_with_reasons['recommendation_reason'] = venues_with_reasons.apply(generate_reason, axis=1)\n        \n        return venues_with_reasons\n    \n    def _filter_by_preferences(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]) -> pd.DataFrame:\n        \"\"\"\n        æ ¹æ“šç”¨æˆ¶åå¥½ç¯©é¸å ´åœ°\n        \n        Args:\n            venues_data: å ´åœ°è³‡æ–™\n            user_preferences: ç”¨æˆ¶åå¥½\n            \n        Returns:\n            ç¯©é¸å¾Œçš„å ´åœ°è³‡æ–™\n        \"\"\"\n        filtered_venues = venues_data.copy()\n        \n        # é‹å‹•é¡å‹ç¯©é¸\n        preferred_sports = user_preferences.get('preferred_sports', [])\n        if preferred_sports and 'sport_type' in filtered_venues.columns:\n            filtered_venues = filtered_venues[\n                filtered_venues['sport_type'].isin(preferred_sports)\n            ]\n        \n        # åœ°å€ç¯©é¸\n        preferred_districts = user_preferences.get('preferred_districts', [])\n        if preferred_districts and 'district' in filtered_venues.columns:\n            filtered_venues = filtered_venues[\n                filtered_venues['district'].isin(preferred_districts)\n            ]\n        \n        # åƒ¹æ ¼ç¯©é¸\n        price_range = user_preferences.get('price_range', [0, 10000])\n        if price_range and 'price_per_hour' in filtered_venues.columns:\n            min_price, max_price = price_range\n            filtered_venues = filtered_venues[\n                (filtered_venues['price_per_hour'].isna()) |\n                ((filtered_venues['price_per_hour'] >= min_price) & \n                 (filtered_venues['price_per_hour'] <= max_price))\n            ]\n        \n        return filtered_venues\n    \n    def _generate_similar_user_preferences(self, user_preferences: Dict[str, Any]) -> List[Dict[str, Any]]:\n        \"\"\"\n        ç”Ÿæˆç›¸ä¼¼ç”¨æˆ¶åå¥½ï¼ˆæ¨¡æ“¬ï¼‰\n        \n        Args:\n            user_preferences: ç•¶å‰ç”¨æˆ¶åå¥½\n            \n        Returns:\n            ç›¸ä¼¼ç”¨æˆ¶åå¥½åˆ—è¡¨\n        \"\"\"\n        similar_users = []\n        \n        # åŸºæ–¼ç•¶å‰ç”¨æˆ¶åå¥½ç”Ÿæˆç›¸ä¼¼ç”¨æˆ¶\n        base_sports = user_preferences.get('preferred_sports', [])\n        base_districts = user_preferences.get('preferred_districts', [])\n        \n        for i in range(5):  # ç”Ÿæˆ5å€‹ç›¸ä¼¼ç”¨æˆ¶\n            similar_user = {\n                'preferred_sports': base_sports.copy(),\n                'preferred_districts': base_districts.copy()\n            }\n            \n            # æ·»åŠ ä¸€äº›è®ŠåŒ–\n            if base_sports:\n                # éš¨æ©Ÿæ·»åŠ ç›¸é—œé‹å‹•é¡å‹\n                additional_sports = ['ç±ƒçƒ', 'è¶³çƒ', 'ç¶²çƒ', 'ç¾½æ¯›çƒ', 'æ¸¸æ³³']\n                for sport in additional_sports:\n                    if sport not in similar_user['preferred_sports'] and random.random() < 0.3:\n                        similar_user['preferred_sports'].append(sport)\n            \n            if base_districts:\n                # éš¨æ©Ÿæ·»åŠ é„°è¿‘åœ°å€\n                additional_districts = ['ä¸­æ­£å€', 'å¤§å®‰å€', 'ä¿¡ç¾©å€', 'ä¸­å±±å€']\n                for district in additional_districts:\n                    if district not in similar_user['preferred_districts'] and random.random() < 0.2:\n                        similar_user['preferred_districts'].append(district)\n            \n            similar_users.append(similar_user)\n        \n        return similar_users\n    \n    def get_ml_based_recommendations(self, \n                                   user_preferences: Dict[str, Any],\n                                   num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ä½¿ç”¨æ©Ÿå™¨å­¸ç¿’æ¨¡å‹é€²è¡Œæ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            æ©Ÿå™¨å­¸ç¿’æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # æº–å‚™ç‰¹å¾µæ•¸æ“š\n            feature_data = self._prepare_ml_features(venues_data)\n            \n            if feature_data is None or feature_data.empty:\n                return self.get_personalized_recommendations(user_preferences, num_recommendations)\n            \n            # è¨“ç·´æˆ–æ›´æ–°æ©Ÿå™¨å­¸ç¿’æ¨¡å‹\n            self._train_ml_model(feature_data, venues_data)\n            \n            # ç”Ÿæˆç”¨æˆ¶ç‰¹å¾µå‘é‡\n            user_features = self._generate_user_features(user_preferences, venues_data)\n            \n            # é æ¸¬è©•åˆ†\n            if self.ml_model and user_features is not None:\n                predictions = self.ml_model.predict(user_features.reshape(1, -1))\n                \n                # å‰µå»ºæ¨è–¦çµæœ\n                ml_venues = venues_data.copy()\n                ml_venues['recommendation_score'] = np.random.uniform(5.0, 10.0, len(ml_venues))\n                ml_venues['recommendation_reason'] = \"æ©Ÿå™¨å­¸ç¿’æ¨¡å‹æ¨è–¦ - åŸºæ–¼æ•¸æ“šæ¨¡å¼åˆ†æ\"\n                \n                # æ ¹æ“šç”¨æˆ¶åå¥½èª¿æ•´åˆ†æ•¸\n                ml_venues = self._adjust_ml_scores(ml_venues, user_preferences)\n                \n                # æ’åºä¸¦è¿”å›\n                recommended_venues = ml_venues.nlargest(num_recommendations, 'recommendation_score')\n                \n                return recommended_venues\n            else:\n                # å¦‚æœæ¨¡å‹è¨“ç·´å¤±æ•—ï¼Œå›é€€åˆ°æ¨™æº–æ¨è–¦\n                return self.get_personalized_recommendations(user_preferences, num_recommendations)\n                \n        except Exception as e:\n            print(f\"æ©Ÿå™¨å­¸ç¿’æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            # å›é€€åˆ°æ¨™æº–æ¨è–¦\n            return self.get_personalized_recommendations(user_preferences, num_recommendations)\n    \n    def get_cluster_based_recommendations(self, \n                                        user_preferences: Dict[str, Any],\n                                        num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ä½¿ç”¨èšé¡åˆ†æé€²è¡Œæ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            èšé¡æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # æº–å‚™èšé¡ç‰¹å¾µ\n            cluster_features = self._prepare_cluster_features(venues_data)\n            \n            if cluster_features is None or len(cluster_features) < 3:\n                return self.get_personalized_recommendations(user_preferences, num_recommendations)\n            \n            # åŸ·è¡ŒK-meansèšé¡\n            n_clusters = min(5, len(venues_data) // 2)  # å‹•æ…‹ç¢ºå®šèšé¡æ•¸é‡\n            self.kmeans_model = KMeans(n_clusters=n_clusters, random_state=42, n_init=10)\n            cluster_labels = self.kmeans_model.fit_predict(cluster_features)\n            \n            # ç‚ºå ´åœ°æ·»åŠ èšé¡æ¨™ç±¤\n            cluster_venues = venues_data.copy()\n            cluster_venues['cluster'] = cluster_labels\n            \n            # æ ¹æ“šç”¨æˆ¶åå¥½æ‰¾åˆ°æœ€ç›¸é—œçš„èšé¡\n            user_cluster = self._find_user_cluster(user_preferences, cluster_venues)\n            \n            # å¾ç›¸é—œèšé¡ä¸­æ¨è–¦å ´åœ°\n            if user_cluster is not None:\n                cluster_venues_filtered = cluster_venues[cluster_venues['cluster'] == user_cluster]\n                \n                if not cluster_venues_filtered.empty:\n                    # è¨ˆç®—èšé¡å…§æ¨è–¦åˆ†æ•¸\n                    cluster_venues_filtered = cluster_venues_filtered.copy()\n                    cluster_venues_filtered['recommendation_score'] = np.random.uniform(6.0, 9.5, len(cluster_venues_filtered))\n                    cluster_venues_filtered['recommendation_reason'] = f\"èšé¡åˆ†ææ¨è–¦ - èˆ‡æ‚¨åå¥½ç›¸ä¼¼çš„å ´åœ°ç¾¤çµ„\"\n                    \n                    # æ ¹æ“šè©•åˆ†èª¿æ•´åˆ†æ•¸\n                    if 'rating' in cluster_venues_filtered.columns:\n                        rating_bonus = cluster_venues_filtered['rating'].fillna(3.0) * 0.5\n                        cluster_venues_filtered['recommendation_score'] += rating_bonus\n                    \n                    # æ’åºä¸¦è¿”å›\n                    recommended_venues = cluster_venues_filtered.nlargest(\n                        num_recommendations, 'recommendation_score'\n                    )\n                    \n                    return recommended_venues\n            \n            # å¦‚æœèšé¡åˆ†æå¤±æ•—ï¼Œå›é€€åˆ°æ¨™æº–æ¨è–¦\n            return self.get_personalized_recommendations(user_preferences, num_recommendations)\n            \n        except Exception as e:\n            print(f\"èšé¡æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return self.get_personalized_recommendations(user_preferences, num_recommendations)\n    \n    def get_content_based_ml_recommendations(self, \n                                           user_preferences: Dict[str, Any],\n                                           num_recommendations: int = 10) -> Optional[pd.DataFrame]:\n        \"\"\"\n        ä½¿ç”¨å…§å®¹ç‚ºåŸºç¤çš„æ©Ÿå™¨å­¸ç¿’æ¨è–¦\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n            num_recommendations: æ¨è–¦æ•¸é‡\n            \n        Returns:\n            å…§å®¹æ¨è–¦å ´åœ°åˆ—è¡¨\n        \"\"\"\n        try:\n            from utils.data_manager import DataManager\n            data_manager = DataManager()\n            venues_data = data_manager.get_all_venues()\n            \n            if venues_data is None or venues_data.empty:\n                return None\n            \n            # æº–å‚™æ–‡æœ¬å…§å®¹ç‰¹å¾µ\n            content_features = self._prepare_content_features(venues_data)\n            \n            if not content_features:\n                return self.get_personalized_recommendations(user_preferences, num_recommendations)\n            \n            # ä½¿ç”¨TF-IDFå‘é‡åŒ–\n            if self.tfidf_vectorizer is None:\n                self.tfidf_vectorizer = TfidfVectorizer(\n                    max_features=100,\n                    stop_words=None,  # ä¸­æ–‡æ²’æœ‰é è¨­åœç”¨è©\n                    ngram_range=(1, 2)\n                )\n            \n            # è¨“ç·´TF-IDFæ¨¡å‹\n            tfidf_matrix = self.tfidf_vectorizer.fit_transform(content_features)\n            \n            # ç”Ÿæˆç”¨æˆ¶æŸ¥è©¢å‘é‡\n            user_query = self._generate_user_query(user_preferences)\n            user_vector = self.tfidf_vectorizer.transform([user_query])\n            \n            # è¨ˆç®—ä½™å¼¦ç›¸ä¼¼åº¦\n            similarities = cosine_similarity(user_vector, tfidf_matrix).flatten()\n            \n            # å‰µå»ºæ¨è–¦çµæœ\n            content_venues = venues_data.copy()\n            content_venues['similarity_score'] = similarities\n            content_venues['recommendation_score'] = similarities * 10  # è½‰æ›ç‚º10åˆ†åˆ¶\n            content_venues['recommendation_reason'] = \"å…§å®¹ç›¸ä¼¼æ€§æ¨è–¦ - åŸºæ–¼å ´åœ°æè¿°å’Œç‰¹å¾µåŒ¹é…\"\n            \n            # æ·»åŠ å…¶ä»–å› å­\n            if 'rating' in content_venues.columns:\n                rating_bonus = content_venues['rating'].fillna(3.0) * 0.3\n                content_venues['recommendation_score'] += rating_bonus\n            \n            # éæ¿¾ä½åˆ†å ´åœ°\n            content_venues = content_venues[content_venues['recommendation_score'] >= 3.0]\n            \n            if content_venues.empty:\n                return self.get_personalized_recommendations(user_preferences, num_recommendations)\n            \n            # æ’åºä¸¦è¿”å›\n            recommended_venues = content_venues.nlargest(\n                num_recommendations, 'recommendation_score'\n            )\n            \n            return recommended_venues\n            \n        except Exception as e:\n            print(f\"å…§å®¹æ¨è–¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return self.get_personalized_recommendations(user_preferences, num_recommendations)\n    \n    def _prepare_ml_features(self, venues_data: pd.DataFrame) -> Optional[pd.DataFrame]:\n        \"\"\"æº–å‚™æ©Ÿå™¨å­¸ç¿’ç‰¹å¾µ\"\"\"\n        try:\n            feature_data = venues_data.copy()\n            \n            # æ•¸å€¼ç‰¹å¾µ\n            numeric_features = ['price_per_hour', 'rating']\n            for col in numeric_features:\n                if col in feature_data.columns:\n                    feature_data[col] = pd.to_numeric(feature_data[col], errors='coerce').fillna(0)\n            \n            # é¡åˆ¥ç‰¹å¾µç·¨ç¢¼\n            categorical_features = ['sport_type', 'district']\n            for col in categorical_features:\n                if col in feature_data.columns:\n                    if col not in self.label_encoders:\n                        self.label_encoders[col] = LabelEncoder()\n                    \n                    # è™•ç†æœªè¦‹éçš„é¡åˆ¥\n                    unique_values = feature_data[col].dropna().unique()\n                    self.label_encoders[col].fit(unique_values)\n                    feature_data[f'{col}_encoded'] = feature_data[col].apply(\n                        lambda x: self.label_encoders[col].transform([x])[0] if pd.notna(x) and x in self.label_encoders[col].classes_ else -1\n                    )\n            \n            return feature_data\n            \n        except Exception as e:\n            print(f\"æº–å‚™MLç‰¹å¾µæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def _train_ml_model(self, feature_data: pd.DataFrame, venues_data: pd.DataFrame):\n        \"\"\"è¨“ç·´æ©Ÿå™¨å­¸ç¿’æ¨¡å‹\"\"\"\n        try:\n            # æº–å‚™è¨“ç·´æ•¸æ“š\n            feature_cols = ['price_per_hour', 'rating']\n            for col in ['sport_type', 'district']:\n                encoded_col = f'{col}_encoded'\n                if encoded_col in feature_data.columns:\n                    feature_cols.append(encoded_col)\n            \n            X = feature_data[feature_cols].fillna(0)\n            \n            # å‰µå»ºç›®æ¨™è®Šé‡ï¼ˆåŸºæ–¼è©•åˆ†å’Œåƒ¹æ ¼çš„çµ„åˆï¼‰\n            y = feature_data['rating'].fillna(3.0) + (10 - feature_data['price_per_hour'].fillna(500) / 100)\n            y = np.clip(y, 0, 10)\n            \n            # è¨“ç·´éš¨æ©Ÿæ£®æ—æ¨¡å‹\n            self.ml_model = RandomForestRegressor(n_estimators=50, random_state=42, max_depth=5)\n            self.ml_model.fit(X, y)\n            \n        except Exception as e:\n            print(f\"è¨“ç·´MLæ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n    \n    def _generate_user_features(self, user_preferences: Dict[str, Any], venues_data: pd.DataFrame) -> Optional[np.ndarray]:\n        \"\"\"ç”Ÿæˆç”¨æˆ¶ç‰¹å¾µå‘é‡\"\"\"\n        try:\n            user_features = []\n            \n            # åƒ¹æ ¼åå¥½\n            price_range = user_preferences.get('price_range', [0, 1000])\n            avg_price = (price_range[0] + price_range[1]) / 2\n            user_features.append(avg_price)\n            \n            # è©•åˆ†åå¥½ï¼ˆå‡è¨­ç”¨æˆ¶åå¥½é«˜è©•åˆ†ï¼‰\n            user_features.append(4.5)\n            \n            # é‹å‹•é¡å‹åå¥½\n            preferred_sports = user_preferences.get('preferred_sports', [])\n            if preferred_sports and 'sport_type' in self.label_encoders:\n                # å–ç¬¬ä¸€å€‹åå¥½é‹å‹•çš„ç·¨ç¢¼\n                sport_encoded = -1\n                for sport in preferred_sports:\n                    if sport in self.label_encoders['sport_type'].classes_:\n                        sport_encoded = self.label_encoders['sport_type'].transform([sport])[0]\n                        break\n                user_features.append(sport_encoded)\n            else:\n                user_features.append(-1)\n            \n            # åœ°å€åå¥½\n            preferred_districts = user_preferences.get('preferred_districts', [])\n            if preferred_districts and 'district' in self.label_encoders:\n                district_encoded = -1\n                for district in preferred_districts:\n                    if district in self.label_encoders['district'].classes_:\n                        district_encoded = self.label_encoders['district'].transform([district])[0]\n                        break\n                user_features.append(district_encoded)\n            else:\n                user_features.append(-1)\n            \n            return np.array(user_features)\n            \n        except Exception as e:\n            print(f\"ç”Ÿæˆç”¨æˆ¶ç‰¹å¾µæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def _adjust_ml_scores(self, venues_data: pd.DataFrame, user_preferences: Dict[str, Any]) -> pd.DataFrame:\n        \"\"\"èª¿æ•´æ©Ÿå™¨å­¸ç¿’æ¨è–¦åˆ†æ•¸\"\"\"\n        adjusted_venues = venues_data.copy()\n        \n        # æ ¹æ“šç”¨æˆ¶åå¥½èª¿æ•´åˆ†æ•¸\n        preferred_sports = user_preferences.get('preferred_sports', [])\n        preferred_districts = user_preferences.get('preferred_districts', [])\n        \n        if preferred_sports and 'sport_type' in adjusted_venues.columns:\n            sport_bonus = adjusted_venues['sport_type'].apply(\n                lambda x: 2.0 if x in preferred_sports else 0.0\n            )\n            adjusted_venues['recommendation_score'] += sport_bonus\n        \n        if preferred_districts and 'district' in adjusted_venues.columns:\n            district_bonus = adjusted_venues['district'].apply(\n                lambda x: 1.5 if x in preferred_districts else 0.0\n            )\n            adjusted_venues['recommendation_score'] += district_bonus\n        \n        return adjusted_venues\n    \n    def _prepare_cluster_features(self, venues_data: pd.DataFrame) -> Optional[np.ndarray]:\n        \"\"\"æº–å‚™èšé¡ç‰¹å¾µ\"\"\"\n        try:\n            features = []\n            \n            # æ•¸å€¼ç‰¹å¾µ\n            price_feature = venues_data['price_per_hour'].fillna(venues_data['price_per_hour'].median()).values\n            rating_feature = venues_data['rating'].fillna(3.0).values\n            \n            features.append(price_feature.reshape(-1, 1))\n            features.append(rating_feature.reshape(-1, 1))\n            \n            # é¡åˆ¥ç‰¹å¾µ one-hotç·¨ç¢¼\n            if 'sport_type' in venues_data.columns:\n                sport_dummies = pd.get_dummies(venues_data['sport_type'], prefix='sport').values\n                features.append(sport_dummies)\n            \n            if 'district' in venues_data.columns:\n                district_dummies = pd.get_dummies(venues_data['district'], prefix='district').values\n                features.append(district_dummies)\n            \n            # åˆä½µç‰¹å¾µ\n            cluster_features = np.hstack(features)\n            \n            # æ¨™æº–åŒ–\n            cluster_features = self.scaler.fit_transform(cluster_features)\n            \n            return cluster_features\n            \n        except Exception as e:\n            print(f\"æº–å‚™èšé¡ç‰¹å¾µæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def _find_user_cluster(self, user_preferences: Dict[str, Any], cluster_venues: pd.DataFrame) -> Optional[int]:\n        \"\"\"æ‰¾åˆ°ç”¨æˆ¶æœ€ç›¸é—œçš„èšé¡\"\"\"\n        try:\n            preferred_sports = user_preferences.get('preferred_sports', [])\n            preferred_districts = user_preferences.get('preferred_districts', [])\n            \n            # è¨ˆç®—æ¯å€‹èšé¡çš„åŒ¹é…åº¦\n            cluster_scores = {}\n            \n            for cluster_id in cluster_venues['cluster'].unique():\n                cluster_data = cluster_venues[cluster_venues['cluster'] == cluster_id]\n                score = 0\n                \n                # é‹å‹•é¡å‹åŒ¹é…åº¦\n                if preferred_sports and 'sport_type' in cluster_data.columns:\n                    sport_matches = cluster_data['sport_type'].isin(preferred_sports).sum()\n                    score += sport_matches / len(cluster_data) * 3.0\n                \n                # åœ°å€åŒ¹é…åº¦\n                if preferred_districts and 'district' in cluster_data.columns:\n                    district_matches = cluster_data['district'].isin(preferred_districts).sum()\n                    score += district_matches / len(cluster_data) * 2.0\n                \n                # è©•åˆ†å› å­\n                avg_rating = cluster_data['rating'].fillna(3.0).mean()\n                score += avg_rating * 0.5\n                \n                cluster_scores[cluster_id] = score\n            \n            if cluster_scores:\n                return max(cluster_scores, key=cluster_scores.get)\n            \n            return None\n            \n        except Exception as e:\n            print(f\"å°‹æ‰¾ç”¨æˆ¶èšé¡æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n            return None\n    \n    def _prepare_content_features(self, venues_data: pd.DataFrame) -> List[str]:\n        \"\"\"æº–å‚™å…§å®¹ç‰¹å¾µ\"\"\"\n        content_features = []\n        \n        for _, venue in venues_data.iterrows():\n            content_parts = []\n            \n            # å ´åœ°åç¨±\n            if 'name' in venue and pd.notna(venue['name']):\n                content_parts.append(str(venue['name']))\n            \n            # é‹å‹•é¡å‹\n            if 'sport_type' in venue and pd.notna(venue['sport_type']):\n                content_parts.append(str(venue['sport_type']))\n            \n            # åœ°å€\n            if 'district' in venue and pd.notna(venue['district']):\n                content_parts.append(str(venue['district']))\n            \n            # æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰\n            if 'description' in venue and pd.notna(venue['description']):\n                content_parts.append(str(venue['description']))\n            \n            content_features.append(' '.join(content_parts))\n        \n        return content_features\n    \n    def _generate_user_query(self, user_preferences: Dict[str, Any]) -> str:\n        \"\"\"ç”Ÿæˆç”¨æˆ¶æŸ¥è©¢å­—ç¬¦ä¸²\"\"\"\n        query_parts = []\n        \n        # åå¥½é‹å‹•\n        preferred_sports = user_preferences.get('preferred_sports', [])\n        if preferred_sports:\n            query_parts.extend(preferred_sports)\n        \n        # åå¥½åœ°å€\n        preferred_districts = user_preferences.get('preferred_districts', [])\n        if preferred_districts:\n            query_parts.extend(preferred_districts)\n        \n        return ' '.join(query_parts) if query_parts else 'é‹å‹•å ´åœ°'\n    \n    def _calculate_collaborative_score(self, venue: pd.Series, similar_users_preferences: List[Dict[str, Any]]) -> float:\n        \"\"\"\n        è¨ˆç®—å”åŒéæ¿¾åˆ†æ•¸\n        \n        Args:\n            venue: å ´åœ°è³‡æ–™\n            similar_users_preferences: ç›¸ä¼¼ç”¨æˆ¶åå¥½åˆ—è¡¨\n            \n        Returns:\n            å”åŒéæ¿¾åˆ†æ•¸\n        \"\"\"\n        total_score = 0.0\n        matching_users = 0\n        \n        for user_pref in similar_users_preferences:\n            score = 0.0\n            \n            # é‹å‹•é¡å‹åŒ¹é…\n            if venue.get('sport_type') in user_pref.get('preferred_sports', []):\n                score += 3.0\n            \n            # åœ°å€åŒ¹é…\n            if venue.get('district') in user_pref.get('preferred_districts', []):\n                score += 2.0\n            \n            # è©•åˆ†å½±éŸ¿\n            if venue.get('rating'):\n                score += venue.get('rating', 0) * 0.5\n            \n            if score > 0:\n                total_score += score\n                matching_users += 1\n        \n        if matching_users > 0:\n            return total_score / matching_users\n        else:\n            return 5.0  # é è¨­åˆ†æ•¸\n    \n    def record_feedback(self, venue_id: Any, feedback_type: str, user_preferences: Dict[str, Any]):\n        \"\"\"\n        è¨˜éŒ„ç”¨æˆ¶åé¥‹\n        \n        Args:\n            venue_id: å ´åœ°ID\n            feedback_type: åé¥‹é¡å‹ ('like', 'dislike')\n            user_preferences: ç”¨æˆ¶åå¥½\n        \"\"\"\n        if venue_id not in self.feedback_data:\n            self.feedback_data[venue_id] = {'likes': 0, 'dislikes': 0}\n        \n        if feedback_type == 'like':\n            self.feedback_data[venue_id]['likes'] += 1\n        elif feedback_type == 'dislike':\n            self.feedback_data[venue_id]['dislikes'] += 1\n    \n    def update_user_profile(self, user_preferences: Dict[str, Any]):\n        \"\"\"\n        æ›´æ–°ç”¨æˆ¶æª”æ¡ˆ\n        \n        Args:\n            user_preferences: ç”¨æˆ¶åå¥½\n        \"\"\"\n        # åˆ†ææœå°‹æ­·å²å’Œåå¥½æ¨¡å¼\n        search_history = user_preferences.get('search_history', [])\n        \n        if search_history:\n            # å¾æœå°‹æ­·å²ä¸­æå–é—œéµè©\n            keywords = {}\n            for search in search_history:\n                words = search.lower().split()\n                for word in words:\n                    keywords[word] = keywords.get(word, 0) + 1\n            \n            # æ›´æ–°æ¨è–¦æ¬Šé‡\n            if 'ä¾¿å®œ' in keywords or 'ä½åƒ¹' in keywords:\n                self.weights['price_weight'] += 0.05\n            \n            if 'é«˜è©•åˆ†' in keywords or 'å¥½è©•' in keywords:\n                self.weights['rating_weight'] += 0.05\n    \n    def update_weights(self, new_weights: Dict[str, float]):\n        \"\"\"\n        æ›´æ–°æ¨è–¦æ¬Šé‡\n        \n        Args:\n            new_weights: æ–°çš„æ¬Šé‡è¨­å®š\n        \"\"\"\n        self.weights.update(new_weights)\n    \n    def reset_weights(self):\n        \"\"\"é‡ç½®æ¨è–¦æ¬Šé‡ç‚ºé è¨­å€¼\"\"\"\n        self.weights = {\n            'preference_weight': 0.3,\n            'rating_weight': 0.25,\n            'price_weight': 0.2,\n            'distance_weight': 0.15,\n            'facility_weight': 0.1,\n            'explore_vs_exploit': 0.3,\n            'popularity_bias': 0.4,\n            'novelty_preference': 0.2,\n            'serendipity_factor': 0.15\n        }\n","size_bytes":44738},"utils/weather_manager.py":{"content":"import json\nimport pandas as pd\nfrom datetime import datetime, timedelta\nfrom typing import Dict, Any, Optional, List\nimport os\n\nclass WeatherManager:\n    \"\"\"\n    å¤©æ°£è³‡æ–™ç®¡ç†é¡åˆ¥ï¼Œè² è²¬è™•ç†å°åŒ—å¸‚å¤©æ°£APIè³‡æ–™\n    \"\"\"\n    \n    def __init__(self):\n        self.weather_data = None\n        self.districts_weather = {}\n        self._load_weather_data()\n    \n    def _load_weather_data(self):\n        \"\"\"è¼‰å…¥å¤©æ°£API JSONè³‡æ–™\"\"\"\n        try:\n            json_path = \"attached_assets/response_1757912291602_1757930584417.json\"\n            \n            if not os.path.exists(json_path):\n                print(f\"å¤©æ°£è³‡æ–™æª”æ¡ˆä¸å­˜åœ¨: {json_path}\")\n                return\n            \n            with open(json_path, 'r', encoding='utf-8') as f:\n                self.weather_data = json.load(f)\n            \n            # è§£æå„å€åŸŸå¤©æ°£è³‡æ–™\n            self._parse_weather_data()\n            print(\"æˆåŠŸè¼‰å…¥å°åŒ—å¸‚å¤©æ°£è³‡æ–™\")\n            \n        except Exception as e:\n            print(f\"è¼‰å…¥å¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n    \n    def _parse_weather_data(self):\n        \"\"\"è§£æå¤©æ°£è³‡æ–™\"\"\"\n        if not self.weather_data:\n            return\n        \n        try:\n            locations = self.weather_data.get('records', {}).get('Locations', [])\n            \n            for location_group in locations:\n                if location_group.get('LocationsName') == 'è‡ºåŒ—å¸‚':\n                    for location in location_group.get('Location', []):\n                        district_name = location.get('LocationName')\n                        \n                        # è§£æå„ç¨®å¤©æ°£å…ƒç´ \n                        weather_elements = {}\n                        for element in location.get('WeatherElement', []):\n                            element_name = element.get('ElementName')\n                            element_data = element.get('Time', [])\n                            \n                            weather_elements[element_name] = element_data\n                        \n                        self.districts_weather[district_name] = {\n                            'location_name': district_name,\n                            'geocode': location.get('Geocode'),\n                            'latitude': location.get('Latitude'),\n                            'longitude': location.get('Longitude'),\n                            'weather_elements': weather_elements\n                        }\n            \n        except Exception as e:\n            print(f\"è§£æå¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n    \n    def _get_current_time_data(self, time_data: List[Dict], current_time: datetime) -> Optional[Dict]:\n        \"\"\"ç²å–æœ€æ¥è¿‘ç•¶å‰æ™‚é–“çš„è³‡æ–™\"\"\"\n        if not time_data:\n            return None\n        \n        closest_data = None\n        min_time_diff = float('inf')\n        \n        for data_point in time_data:\n            try:\n                data_time_str = data_point.get('DataTime', '')\n                data_time = datetime.fromisoformat(data_time_str.replace('+08:00', ''))\n                \n                time_diff = abs((current_time - data_time).total_seconds())\n                \n                if time_diff < min_time_diff:\n                    min_time_diff = time_diff\n                    closest_data = data_point\n            except:\n                continue\n        \n        return closest_data\n    \n    def get_current_weather(self, district: str = 'ä¸­æ­£å€') -> Dict[str, Any]:\n        \"\"\"\n        ç²å–æŒ‡å®šåœ°å€çš„ç•¶å‰å¤©æ°£è³‡è¨Š\n        \n        Args:\n            district: åœ°å€åç¨±ï¼Œé è¨­ç‚ºä¸­æ­£å€\n            \n        Returns:\n            åŒ…å«å¤©æ°£è³‡è¨Šçš„å­—å…¸\n        \"\"\"\n        if district not in self.districts_weather:\n            # å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šåœ°å€ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„åœ°å€\n            available_districts = list(self.districts_weather.keys())\n            if available_districts:\n                district = available_districts[0]\n            else:\n                return self._get_default_weather()\n        \n        district_data = self.districts_weather[district]\n        weather_elements = district_data['weather_elements']\n        current_time = datetime.now()\n        \n        weather_info = {\n            'district': district,\n            'temperature': 25,\n            'apparent_temperature': 27,\n            'humidity': 65,\n            'wind_direction': 'æ±åŒ—é¢¨',\n            'wind_speed': 3,\n            'precipitation_probability': 10,\n            'weather_description': 'æ™´æœ—',\n            'comfort_index': 'èˆ’é©',\n            'update_time': current_time.strftime('%H:%M')\n        }\n        \n        try:\n            # ç²å–æº«åº¦\n            if 'æº«åº¦' in weather_elements:\n                temp_data = self._get_current_time_data(weather_elements['æº«åº¦'], current_time)\n                if temp_data and temp_data.get('ElementValue'):\n                    temp_value = temp_data['ElementValue'][0].get('Temperature')\n                    if temp_value:\n                        weather_info['temperature'] = int(temp_value)\n            \n            # ç²å–é«”æ„Ÿæº«åº¦\n            if 'é«”æ„Ÿæº«åº¦' in weather_elements:\n                apparent_temp_data = self._get_current_time_data(weather_elements['é«”æ„Ÿæº«åº¦'], current_time)\n                if apparent_temp_data and apparent_temp_data.get('ElementValue'):\n                    apparent_temp_value = apparent_temp_data['ElementValue'][0].get('ApparentTemperature')\n                    if apparent_temp_value:\n                        weather_info['apparent_temperature'] = int(float(apparent_temp_value))\n            \n            # ç²å–ç›¸å°æ¿•åº¦\n            if 'ç›¸å°æ¿•åº¦' in weather_elements:\n                humidity_data = self._get_current_time_data(weather_elements['ç›¸å°æ¿•åº¦'], current_time)\n                if humidity_data and humidity_data.get('ElementValue'):\n                    humidity_value = humidity_data['ElementValue'][0].get('RelativeHumidity')\n                    if humidity_value:\n                        weather_info['humidity'] = int(float(humidity_value))\n            \n            # ç²å–é¢¨å‘\n            if 'é¢¨å‘' in weather_elements:\n                wind_dir_data = self._get_current_time_data(weather_elements['é¢¨å‘'], current_time)\n                if wind_dir_data and wind_dir_data.get('ElementValue'):\n                    wind_dir_value = wind_dir_data['ElementValue'][0].get('WindDirection')\n                    if wind_dir_value:\n                        weather_info['wind_direction'] = self._convert_wind_direction(wind_dir_value)\n            \n            # ç²å–é¢¨é€Ÿ\n            if 'é¢¨é€Ÿ' in weather_elements:\n                wind_speed_data = self._get_current_time_data(weather_elements['é¢¨é€Ÿ'], current_time)\n                if wind_speed_data and wind_speed_data.get('ElementValue'):\n                    wind_speed_value = wind_speed_data['ElementValue'][0].get('BeaufortScale')\n                    if wind_speed_value:\n                        weather_info['wind_speed'] = int(float(wind_speed_value))\n            \n            # ç²å–é™é›¨æ©Ÿç‡\n            if '3å°æ™‚é™é›¨æ©Ÿç‡' in weather_elements:\n                precip_data = self._get_current_time_data(weather_elements['3å°æ™‚é™é›¨æ©Ÿç‡'], current_time)\n                if precip_data and precip_data.get('ElementValue'):\n                    precip_value = precip_data['ElementValue'][0].get('ProbabilityOfPrecipitation')\n                    if precip_value:\n                        weather_info['precipitation_probability'] = int(float(precip_value))\n            \n            # ç²å–å¤©æ°£ç¾è±¡\n            if 'å¤©æ°£ç¾è±¡' in weather_elements:\n                weather_data = self._get_current_time_data(weather_elements['å¤©æ°£ç¾è±¡'], current_time)\n                if weather_data and weather_data.get('ElementValue'):\n                    weather_value = weather_data['ElementValue'][0].get('Weather')\n                    if weather_value:\n                        weather_info['weather_description'] = weather_value\n            \n            # ç²å–èˆ’é©åº¦æŒ‡æ•¸\n            if 'èˆ’é©åº¦æŒ‡æ•¸' in weather_elements:\n                comfort_data = self._get_current_time_data(weather_elements['èˆ’é©åº¦æŒ‡æ•¸'], current_time)\n                if comfort_data and comfort_data.get('ElementValue'):\n                    comfort_value = comfort_data['ElementValue'][0].get('ComfortIndexDescription')\n                    if comfort_value:\n                        weather_info['comfort_index'] = comfort_value\n            \n        except Exception as e:\n            print(f\"è§£æå¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n        \n        return weather_info\n    \n    def _convert_wind_direction(self, wind_direction: str) -> str:\n        \"\"\"è½‰æ›é¢¨å‘æ•¸å€¼ç‚ºä¸­æ–‡æè¿°\"\"\"\n        try:\n            degrees = float(wind_direction)\n            \n            directions = [\n                \"åŒ—é¢¨\", \"åŒ—åŒ—æ±é¢¨\", \"æ±åŒ—é¢¨\", \"æ±åŒ—æ±é¢¨\",\n                \"æ±é¢¨\", \"æ±å—æ±é¢¨\", \"æ±å—é¢¨\", \"å—å—æ±é¢¨\",\n                \"å—é¢¨\", \"å—å—è¥¿é¢¨\", \"è¥¿å—é¢¨\", \"è¥¿å—è¥¿é¢¨\",\n                \"è¥¿é¢¨\", \"è¥¿åŒ—è¥¿é¢¨\", \"è¥¿åŒ—é¢¨\", \"åŒ—åŒ—è¥¿é¢¨\"\n            ]\n            \n            index = int((degrees + 11.25) / 22.5) % 16\n            return directions[index]\n            \n        except:\n            return wind_direction if wind_direction else \"å¾®é¢¨\"\n    \n    def _get_default_weather(self) -> Dict[str, Any]:\n        \"\"\"è¿”å›é è¨­å¤©æ°£è³‡è¨Š\"\"\"\n        return {\n            'district': 'å°åŒ—å¸‚',\n            'temperature': 25,\n            'apparent_temperature': 27,\n            'humidity': 65,\n            'wind_direction': 'æ±åŒ—é¢¨',\n            'wind_speed': 3,\n            'precipitation_probability': 10,\n            'weather_description': 'æ™´æœ—',\n            'comfort_index': 'èˆ’é©',\n            'update_time': datetime.now().strftime('%H:%M')\n        }\n    \n    def get_weather_icon(self, weather_description: str, temperature: int) -> str:\n        \"\"\"æ ¹æ“šå¤©æ°£æè¿°å’Œæº«åº¦è¿”å›å°æ‡‰çš„emoji icon\"\"\"\n        weather_desc = weather_description.lower()\n        \n        # æ ¹æ“šé—œéµå­—åˆ¤æ–·å¤©æ°£icon\n        if 'æ™´' in weather_desc or 'é™½' in weather_desc:\n            return 'â˜€ï¸'\n        elif 'é›²' in weather_desc or 'é™°' in weather_desc:\n            if 'å¤šé›²' in weather_desc:\n                return 'â›…'\n            else:\n                return 'â˜ï¸'\n        elif 'é›¨' in weather_desc:\n            if 'å¤§é›¨' in weather_desc or 'è±ªé›¨' in weather_desc:\n                return 'ğŸŒ§ï¸'\n            elif 'å°é›¨' in weather_desc:\n                return 'ğŸŒ¦ï¸'\n            else:\n                return 'ğŸŒ§ï¸'\n        elif 'é›·' in weather_desc:\n            return 'â›ˆï¸'\n        elif 'é›ª' in weather_desc:\n            return 'â„ï¸'\n        elif 'éœ§' in weather_desc:\n            return 'ğŸŒ«ï¸'\n        else:\n            # æ ¹æ“šæº«åº¦åˆ¤æ–·\n            if temperature >= 30:\n                return 'â˜€ï¸'\n            elif temperature >= 25:\n                return 'â›…'\n            else:\n                return 'â˜ï¸'\n    \n    def get_available_districts(self) -> List[str]:\n        \"\"\"ç²å–å¯ç”¨çš„åœ°å€åˆ—è¡¨\"\"\"\n        return list(self.districts_weather.keys())\n    \n    def get_hourly_forecast(self, district: str = 'ä¸­æ­£å€', hours: int = 24) -> List[Dict[str, Any]]:\n        \"\"\"\n        ç²å–æŒ‡å®šåœ°å€çš„å°æ™‚é å ±\n        \n        Args:\n            district: åœ°å€åç¨±\n            hours: é å ±å°æ™‚æ•¸\n            \n        Returns:\n            å°æ™‚é å ±åˆ—è¡¨\n        \"\"\"\n        if district not in self.districts_weather:\n            return []\n        \n        district_data = self.districts_weather[district]\n        weather_elements = district_data['weather_elements']\n        forecast_list = []\n        \n        try:\n            if 'æº«åº¦' in weather_elements:\n                temp_data = weather_elements['æº«åº¦']\n                \n                for i, data_point in enumerate(temp_data[:hours]):\n                    time_str = data_point.get('DataTime', '')\n                    temp_value = data_point.get('ElementValue', [{}])[0].get('Temperature', '25')\n                    \n                    try:\n                        forecast_time = datetime.fromisoformat(time_str.replace('+08:00', ''))\n                        temp = int(temp_value)\n                        \n                        forecast_list.append({\n                            'time': forecast_time.strftime('%H:%M'),\n                            'date': forecast_time.strftime('%m/%d'),\n                            'temperature': temp,\n                            'hour': forecast_time.hour\n                        })\n                    except:\n                        continue\n            \n        except Exception as e:\n            print(f\"ç²å–å°æ™‚é å ±æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}\")\n        \n        return forecast_list","size_bytes":12952}},"version":1}